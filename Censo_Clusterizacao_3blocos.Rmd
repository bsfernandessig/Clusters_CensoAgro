---
title: "Análise de clusters - 2ª versão <br/>Variáveis do Censo Agro 2017"
output:
  html_document:
    toc: true
    toc_depth: 4 
    toc_float: 
      collapsed: false
    theme: flatly  

---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```


```{r Pacotes, message=FALSE, warning=FALSE, include=FALSE}
#pacotes

#install.packages(c("ggthemes", "ggpubr", "readr", "readxl", "rstatix", "sp", "sf", "tmap", "leaflet", "arsenal", "knitr", "plotly", "kableExtra", "prettydoc", "rmdformats", "knitr", "scales", "esquisse", "pacman"))

#install.packages(c(	"broom", "cli", "crayon" , "dbplyr", "dplyr", "forcats", "ggplot2", "haven", "hms", "httr", "jsonlite", "lubridate", "magrittr", "modelr", "pillar", "purrr", "readr", "readxl", "reprex", "rlang", "rstudioapi", "rvest", "stringr", "tibble", "tidyr", "xml2", "corrplot"))

##install.packages("factoextra")
##install.packages("qwraps2")

pacman::p_load(ggthemes, ggpubr, tidyverse, readr, readxl, esquisse, rstatix, sp, sf, tmap, leaflet, arsenal, knitr, plotly, kableExtra, prettydoc, rmdformats, knitr, scales, broom, cli, crayon , dbplyr, dplyr, forcats, ggplot2, haven, hms, httr, jsonlite, lubridate, magrittr, modelr, pillar, purrr, readr, readxl, reprex, rlang, rstudioapi, rvest, stringr, tibble, tidyr, xml2, factoextra, qwraps2, corrplot) 


options(scipen=999)

```


```{r COD_Tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### TABELAS -----------------
TABELA1 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6778_condicaodoprodutor+niveis.xlsx", na = "X") 
TABELA1$COD[TABELA1$NIVEL == "BR"] <- 000 #alterando o código do Brasil que está igual ao da região Norte

TABELA2 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6878_areaestabelecimentos+niveis.xlsx", na = "X") 
TABELA2$COD[TABELA2$NIVEL == "BR"] <- 000
TABELA2 <- TABELA2 %>% #deletando colunas pra que elas não fiquem duplicadas quando for juntar as tabelas
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA3 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6884_estabelecimentos_pessoalocupadolacoparentesco+niveis.xlsx", na = "X") 
TABELA3$COD[TABELA3$NIVEL == "BR"] <- 000
TABELA3 <- TABELA3 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA4 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6884_pessoalocupado+niveis.xlsx", na = "X") 
TABELA4$COD[TABELA4$NIVEL == "BR"] <- 000
TABELA4 <- TABELA4 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA5 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6884_pessoalocupadolacoparentesco+niveis.xlsx", na = "X") 
TABELA5$COD[TABELA5$NIVEL == "BR"] <- 000
TABELA5 <- TABELA5 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA6 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6898_valordaproducao+niveis.xlsx", na = "X") 
TABELA6$COD[TABELA6$NIVEL == "BR"] <- 000
TABELA6 <- TABELA6 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA7 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6901_num-estab-rendas+niveis.xlsx", na = "X") 
TABELA7$COD[TABELA7$NIVEL == "BR"] <- 000
TABELA7 <- TABELA7 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6901_valorreceitas+niveis.xlsx", na = "X") 
TABELA8$COD[TABELA8$NIVEL == "BR"] <- 000
TABELA8 <- TABELA8 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA9 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6882_areapreservacao+niveis.xlsx", na = "X") 
TABELA9$COD[TABELA9$NIVEL == "BR"] <- 000
TABELA9 <- TABELA9 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA10 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6788_MUN_totalestabelecimentos+niveis.xlsx", na = "X") 
TABELA10$COD[TABELA10$NIVEL == "BR"] <- 000
TABELA10 <- TABELA10 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)




TABELA4_06 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1113_MUN_ocupados.xlsx", na = "X") 
TABELA4_06$COD[TABELA4_06$NIVEL == "BR"] <- 000
TABELA4_06 <- TABELA4_06 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8_06a <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1116_MUN_rendimentosagropecuarios.xlsx", na = "X") 
TABELA8_06a$COD[TABELA8_06a$NIVEL == "BR"] <- 000
TABELA8_06a <- TABELA8_06a %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8_06b <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1117_MUN_rendimentosnaoagropec.xlsx", na = "X") 
TABELA8_06b$COD[TABELA8_06b$NIVEL == "BR"] <- 000
TABELA8_06b <- TABELA8_06b %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)
TABELA8_06 <- left_join(TABELA8_06a, TABELA8_06b, by = "COD")

TABELA2_06 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1112_MUN_totalestabelecimentos+areas+niveis.xlsx", na = "X") 
TABELA2_06$COD[TABELA2_06$NIVEL == "BR"] <- 000
TABELA2_06 <- TABELA2_06 %>% #deletando colunas pra que elas não fiquem duplicadas quando for juntar as tabelas
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)



```

```{r COD_Procedimentos com as tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### PROCEDIMENTOS COM AS TABELAS -----------------

#PARA VER (se) QUAIS LINHAS ESTÃO DUPLICADAS
TABELA1[duplicated(TABELA1$COD) | duplicated(TABELA1$COD, fromLast = TRUE), ]


#Join de todas as tabelas 
todastabelas <- TABELA1 %>% 
  left_join(., TABELA2, by = "COD") %>%
  left_join(., TABELA3, by = "COD") %>%
  left_join(., TABELA4, by = "COD") %>%
  left_join(., TABELA5, by = "COD") %>%
  left_join(., TABELA6, by = "COD") %>%
  left_join(., TABELA7, by = "COD") %>%
  left_join(., TABELA8, by = "COD") %>%
  left_join(., TABELA9, by = "COD") %>%
  left_join(., TABELA10, by = "COD") %>%
  full_join(., TABELA4_06, by = "COD") %>%
  full_join(., TABELA8_06, by = "COD") %>%
  full_join(., TABELA2_06, by = "COD")


#Filtragem por recorte geográfico
microrregioes <- todastabelas %>% filter(NIVEL == "MI")
mesorregioes <- todastabelas %>% filter(NIVEL == "ME")
estados <- todastabelas %>% filter(NIVEL == "UF")
macrorregioes <- todastabelas %>% filter(NIVEL == "GR")
brasil <- todastabelas %>% filter(NIVEL == "BR")


#Criando colunas de código do estado e da região 
microrregioes <- microrregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
microrregioes$COD_ESTADO <- substr(microrregioes$COD_ESTADO, 0, 2)
microrregioes$COD_REGIAO <- substr(microrregioes$COD_REGIAO, 0, 1)
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "1"] <- "Norte"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "2"] <- "Nordeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "3"] <- "Sudeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "4"] <- "Sul"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "5"] <- "Centro-Oeste"


mesorregioes <- mesorregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
mesorregioes$COD_ESTADO <- substr(mesorregioes$COD_ESTADO, 0, 2)
mesorregioes$COD_REGIAO <- substr(mesorregioes$COD_REGIAO, 0, 1)


```

```{r COD_Novas colunas, message=FALSE, warning=FALSE, include=FALSE}
#### CÁLCULO DAS PORCENTAGENS -----------------
microrregioes_pct <- microrregioes %>%
  mutate(MP_prop_REC_PROD = R_VALOR_MP_1 / R_VALOR_T_1 ,
         MP_prop_REC_OUTR = R_VALOR_MP_2 / R_VALOR_T_2 ,
         MP_prop_REC_FORA = R_VALOR_MP_302 / R_VALOR_T_302 ,
         MP_prop_REC_PROG = (R_VALOR_MP_301 + R_VALOR_MP_303 + R_VALOR_MP_304 + R_VALOR_MP_305 + R_VALOR_MP_306 + R_VALOR_MP_307) / (R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) ,
         AF_prop_REC_PROD = R_VALOR_AF_1 / R_VALOR_T_1 ,
         AF_prop_REC_OUTR = R_VALOR_AF_2 / R_VALOR_T_2 ,
         AF_prop_REC_FORA = R_VALOR_AF_302 / R_VALOR_T_302 ,
         AF_prop_REC_PROG = (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307) / (R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) ,
         GP_prop_REC_PROD = (R_VALOR_T_1 - R_VALOR_AF_1) / R_VALOR_T_1,
         GP_prop_REC_OUTR = (R_VALOR_T_2 - R_VALOR_AF_2) / R_VALOR_T_2,
         GP_prop_REC_FORA = (R_VALOR_T_302 - R_VALOR_AF_302) / R_VALOR_T_302,
         GP_prop_REC_PROG = ((R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) - (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307)) / (R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307),
GP_prop_REC_TOT = (R_VALOR_T_TOT - R_VALOR_AF_TOT) / R_VALOR_T_TOT,
         
         AF_prop_NEstab = PROD_AF / PROD_T ,
         MP_prop_NEstab = PROD_MP / PROD_T ,
         GP_prop_NEstab = (PROD_T - PROD_AF) / PROD_T ,
         
         AF_prop_AREA = AREA_AF / AREA_T ,
         MP_prop_AREA = AREA_MP / AREA_T ,
         GP_prop_AREA = (AREA_T - AREA_AF) / AREA_T ,
         
         AF_prop_OCU = O_AF / O_T ,
         MP_prop_OCU = O_MP / O_T ,
         GP_prop_OCU = (O_T - O_AF) / O_T ,
         
         AF_prop_VP = VP_AF / VP_T ,
         MP_prop_VP = VP_MP / VP_T ,
         GP_prop_VP = (VP_T - VP_AF) / VP_T ,
         
         MP_prop_REC_TOT = R_VALOR_MP_TOT / R_VALOR_T_TOT,
         AF_prop_REC_TOT = R_VALOR_AF_TOT / R_VALOR_T_TOT,
         GP_prop_REC_TOT = (R_VALOR_T_TOT - R_VALOR_AF_TOT) / R_VALOR_T_TOT,
         
         #porcentagem tipo 2, usando o total de tudo
         MP_prop2_REC_PROD = R_VALOR_MP_1 / R_VALOR_T_TOT ,
         MP_prop2_REC_OUTR = R_VALOR_MP_2 / R_VALOR_T_TOT ,
         MP_prop2_REC_FORA = R_VALOR_MP_302 / R_VALOR_T_TOT ,
         MP_prop2_REC_PROG = (R_VALOR_MP_301 + R_VALOR_MP_303 + R_VALOR_MP_304 + R_VALOR_MP_305 + R_VALOR_MP_306 + R_VALOR_MP_307) / R_VALOR_T_TOT ,
         AF_prop2_REC_PROD = R_VALOR_AF_1 / R_VALOR_T_TOT ,
         AF_prop2_REC_OUTR = R_VALOR_AF_2 / R_VALOR_T_TOT ,
         AF_prop2_REC_FORA = R_VALOR_AF_302 / R_VALOR_T_TOT ,
         AF_prop2_REC_PROG = (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307) /  R_VALOR_T_TOT ,
         GP_prop2_REC_PROD	=	(R_VALOR_T_1 - R_VALOR_AF_1 ) /  R_VALOR_T_TOT,
         GP_prop2_REC_OUTR	=	(R_VALOR_T_2 - R_VALOR_AF_2) /  R_VALOR_T_TOT ,
         GP_prop2_REC_FORA	=	(R_VALOR_T_302 - R_VALOR_AF_302) /  R_VALOR_T_TOT ,
         GP_prop2_REC_PROG	=	((R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) - (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307)) / R_VALOR_T_TOT  ,
         
        #porcentagem tipo 3, usando o total de cada tipologia 
        MP_prop3_REC_PROD = R_VALOR_MP_1 / R_VALOR_MP_TOT ,
        MP_prop3_REC_OUTR = R_VALOR_MP_2 / R_VALOR_MP_TOT ,
        MP_prop3_REC_FORA = R_VALOR_MP_302 / R_VALOR_MP_TOT ,
        MP_prop3_REC_PROG = (R_VALOR_MP_301 + R_VALOR_MP_303 + R_VALOR_MP_304 + R_VALOR_MP_305 + R_VALOR_MP_306 + R_VALOR_MP_307) / R_VALOR_MP_TOT ,
        AF_prop3_REC_PROD = R_VALOR_AF_1 / R_VALOR_AF_TOT ,
        AF_prop3_REC_OUTR = R_VALOR_AF_2 / R_VALOR_AF_TOT ,
        AF_prop3_REC_FORA = R_VALOR_AF_302 / R_VALOR_AF_TOT ,
        AF_prop3_REC_PROG = (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307) /  R_VALOR_AF_TOT ,   
        GP_prop3_REC_PROD = (R_VALOR_T_1 - R_VALOR_AF_1) /  (R_VALOR_T_TOT - R_VALOR_AF_TOT) ,
        GP_prop3_REC_OUTR = (R_VALOR_T_2 - R_VALOR_AF_2) /  (R_VALOR_T_TOT - R_VALOR_AF_TOT) ,
        GP_prop3_REC_FORA = (R_VALOR_T_302 - R_VALOR_AF_302) /  (R_VALOR_T_TOT - R_VALOR_AF_TOT) ,
        GP_prop3_REC_PROG = ((R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) - (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307)) / (R_VALOR_T_TOT - R_VALOR_AF_TOT)  ,

 #Valor da produção por área útil
    TT_VPdivAREA = round((VP_T*1000) / (AREA_T - AREAPRESERV_T), 2), 
    AF_VPdivAREA = round((VP_AF*1000) / (AREA_AF - AREAPRESERV_AF), 2),
    MP_VPdivAREA = round((VP_MP*1000) / (AREA_MP - AREAPRESERV_MP), 2),
    GP_VPdivAREA = round((((VP_T - VP_AF))*1000) / ((VP_T - VP_AF) - AREAPRESERV_GP), 2),
         





    
##a partir daqui, método para calcular os rendimentos dos estabelecimentos + RENDIMENTOS FORA DO ESTABELECIMENTO (SEM CONSIDERAR RENDAS DE PROGRAMAS E POLÍTICAS)

    # R_NEST_T = R_NEST_T_TOT     ,
    # R_NEST_NAF = R_NEST_T_TOT - R_NEST_AF_TOT     ,
    # R_NEST_AF = R_NEST_AF_TOT     ,
    # R_06_NEST_T = R_06_NEST_T     ,
    # R_06_NEST_NAF = R_06_NEST_NAF     ,
    # R_06_NEST_AF = R_06_NEST_AF     ,
    # 
    # 
    # R_VALOR_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302) / 12 ,
    # R_VALOR_NAF = (R_VALOR_T_1 - R_VALOR_AF_1 + R_VALOR_T_2 - R_VALOR_AF_2 + R_VALOR_T_302 - R_VALOR_AF_302) / 12 ,
    # R_VALOR_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302) / 12 ,
    # 
    # 
    # Rc_06_VALOR_T	=	((R_06_VALOR_T + R_06_VALOROTR_T6) / 12)	*	1,8974051,  #Para corrigir inflação multiplicar tudo por 1,89740510
    # Rc_06_VALOR_AF	=	((R_06_VALOR_AF + R_06_VALOROTR_AF6) / 12)	*	1,8974051,
    # Rc_06_VALOR_NAF	=	((R_06_VALOR_NAF + R_06_VALOROTR_NAF6) / 12)	*	1,8974051,
    # R_06_VALOR_T = (R_06_VALOR_T + R_06_VALOROTR_T6) / 12   ,
    # R_06_VALOR_AF = (R_06_VALOR_AF + R_06_VALOROTR_AF6) / 12  ,
    # R_06_VALOR_NAF = (R_06_VALOR_NAF + R_06_VALOROTR_NAF6) / 12   ,
    # 
    # NEST_T = NEST_T     ,
    # NEST_NAF = NEST_NAF     ,
    # NEST_AF = NEST_AF     ,
    # NEST_06_T = NEST_06_T     ,
    # NEST_06_NAF = NEST_06_NAF     ,
    # NEST_06_AF = NEST_06_AF     ,
    # AREA_T = AREA_T     ,
    # AREA_NAF = AREA_T - AREA_AF     ,
    # AREA_AF = AREA_AF     ,
    # AREA_06_T = AREA_06_T     ,
    # AREA_06_NAF = AREA_06_NAF     ,
    # AREA_06_AF = AREA_06_AF     ,
    # OCU_T = O_T     ,
    # OCU_NAF = O_T - O_AF     ,
    # OCU_AF = O_AF     ,
    # OCU_06_T = OCU_06_T     ,
    # OCU_06_NAF = OCU_06_Nfam     ,
    # OCU_06_AF = OCU_06_AF  ,
    

##a partir daqui, método para calcular os rendimentos APENAS DOS ESTABELECIMENTOS
    
    R_NEST_T	=	R_NEST_T_TOT				,
    R_NEST_NAF	=	R_NEST_T_TOT - R_NEST_AF_TOT				,
    R_NEST_AF	=	R_NEST_AF_TOT				,
    R_06_NEST_T	=	R_06_NEST_T				,
    R_06_NEST_NAF	=	R_06_NEST_NAF				,
    R_06_NEST_AF	=	R_06_NEST_AF				,


    R_VALOR_T	=	((R_VALOR_T_1	+	R_VALOR_T_2) / 12), #como a variável é anual, aqui está sendo dividida por 12 para se ter o valor mensal médio
    R_VALOR_NAF	=	((R_VALOR_T_1 - R_VALOR_AF_1	+	R_VALOR_T_2 - R_VALOR_AF_2) / 12)		,
    R_VALOR_AF	=	((R_VALOR_AF_1	+	R_VALOR_AF_2) / 12)		,
    R_VALOR_MP	=	((R_VALOR_MP_1	+	R_VALOR_MP_2) / 12)		,



    Rc_06_VALOR_T	=	((R_06_VALOR_T / 12)	*	1.8974051),  #Para corrigir inflação multiplicar tudo por 1,89740510
    Rc_06_VALOR_NAF	=	((R_06_VALOR_NAF / 12)	*	1.8974051),
    Rc_06_VALOR_AF	=	((R_06_VALOR_AF / 12)	*	1.8974051),
    R_06_VALOR_T	=	(R_06_VALOR_T) / 12				,
    R_06_VALOR_NAF	=	(R_06_VALOR_NAF) / 12				,
    R_06_VALOR_AF	=	(R_06_VALOR_AF) / 12				,

    


    NEST_T	=	NEST_T				,
    NEST_NAF	=	NEST_NAF				,
    NEST_AF	=	NEST_AF				,
    NEST_06_T	=	NEST_06_T				,
    NEST_06_NAF	=	NEST_06_NAF				,
    NEST_06_AF	=	NEST_06_AF				,
    AREA_T	=	AREA_T				,
    AREA_NAF	=	AREA_T - AREA_AF				,
    AREA_AF	=	AREA_AF				,
    AREA_06_T	=	AREA_06_T				,
    AREA_06_NAF	=	AREA_06_NAF				,
    AREA_06_AF	=	AREA_06_AF				,
    OCU_T	=	O_T				,
    OCU_NAF	=	O_T - O_AF				,
    OCU_AF	=	O_AF				,
    OCU_06_T	=	OCU_06_T				,
    OCU_06_NAF	=	OCU_06_Nfam				,
    OCU_06_AF	=	OCU_06_AF	,

 

REND_ESTAB_T	=	(1000	*	R_VALOR_T)	/	NEST_T	,
REND_ESTAB_NAF	=	(1000	*	R_VALOR_NAF)	/	NEST_NAF	,
REND_ESTAB_AF	=	(1000	*	R_VALOR_AF)	/	NEST_AF	,
REND_ESTAB_06_T	=	(1000	*	R_06_VALOR_T)	/	NEST_06_T	,
REND_ESTAB_06_NAF	=	(1000	*	R_06_VALOR_NAF)	/	NEST_06_NAF	,
REND_ESTAB_06_AF	=	(1000	*	R_06_VALOR_AF)	/	NEST_06_AF , 
RENDc_ESTAB_06_T	=	(1000	*	Rc_06_VALOR_T)	/	NEST_06_T	, #INFLAÇÃO CORRIGIDA
RENDc_ESTAB_06_NAF	=	(1000	*	Rc_06_VALOR_NAF)	/	NEST_06_NAF	, #INFLAÇÃO CORRIGIDA
RENDc_ESTAB_06_AF	=	(1000	*	Rc_06_VALOR_AF)	/	NEST_06_AF ,  #INFLAÇÃO CORRIGIDA


REND_OCU_T	=	(1000	*	R_VALOR_T)	/	OCU_T	,
REND_OCU_NAF	=	(1000	*	R_VALOR_NAF)	/	OCU_NAF	,
REND_OCU_AF	=	(1000	*	R_VALOR_AF)	/	OCU_AF	,
REND_OCU_MP	=	(1000	*	R_VALOR_MP)	/	O_MP	, # Renda por trabalhador ocupado - renda pelo trabalho

REND_OCU_06_T	=	(1000	*	R_06_VALOR_T)	/	OCU_06_T	,
REND_OCU_06_NAF	=	(1000	*	R_06_VALOR_NAF)	/	OCU_06_NAF	,
REND_OCU_06_AF	=	(1000	*	R_06_VALOR_AF)	/	OCU_06_AF ,

RENDc_OCU_06_T	=	(1000	*	Rc_06_VALOR_T)	/	OCU_06_T	,
RENDc_OCU_06_NAF	=	(1000	*	Rc_06_VALOR_NAF)	/	OCU_06_NAF	,
RENDc_OCU_06_AF	=	(1000	*	Rc_06_VALOR_AF)	/	OCU_06_AF ,
  

Dif_NEST_T	=	(	NEST_T	-	NEST_06_T	)	/	NEST_06_T	,
Dif_NEST_NAF	=	(	NEST_NAF	-	NEST_06_NAF	)	/	NEST_06_NAF	,
Dif_NEST_AF	=	(	NEST_AF	-	NEST_06_AF	)	/	NEST_06_AF	,
									
Dif_OCU_T	=	(	OCU_T	-	OCU_06_T	)	/	OCU_06_T	,
Dif_OCU_NAF	=	(	OCU_NAF	-	OCU_06_NAF	)	/	OCU_06_NAF	,
Dif_OCU_AF	=	(	OCU_AF	-	OCU_06_AF	)	/	OCU_06_AF	,
									
Dif_REND_OCU_T	=	(	REND_OCU_T	-	REND_OCU_06_T	)	/	REND_OCU_06_T	,
Dif_REND_OCU_NAF	=	(	REND_OCU_NAF	-	REND_OCU_06_NAF	)	/	REND_OCU_06_NAF	,
Dif_REND_OCU_AF	=	(	REND_OCU_AF	-	REND_OCU_06_AF	)	/	REND_OCU_06_AF	,
									
Dif_REND_ESTAB_T	=	(	REND_ESTAB_T	-	RENDc_ESTAB_06_T	)	/	RENDc_ESTAB_06_T	,
Dif_REND_ESTAB_NAF	=	(	REND_ESTAB_NAF	-	RENDc_ESTAB_06_NAF	)	/	RENDc_ESTAB_06_NAF	,
Dif_REND_ESTAB_AF	=	(	REND_ESTAB_AF	-	RENDc_ESTAB_06_AF	)	/	RENDc_ESTAB_06_AF	,
									
Dif_AREA_T	=	(	AREA_T	-	AREA_06_T	)	/	AREA_06_T	,
Dif_AREA_NAF	=	(	AREA_NAF	-	AREA_06_NAF	)	/	AREA_06_NAF	,
Dif_AREA_AF	=	(	AREA_AF	-	AREA_06_AF	)	/	AREA_06_AF	,

Dif_REND_T	=	(	R_VALOR_T	-	Rc_06_VALOR_T	)	/	Rc_06_VALOR_T	,
Dif_REND_NAF	=	(	R_VALOR_NAF	-	Rc_06_VALOR_NAF	)	/	Rc_06_VALOR_NAF	,
Dif_REND_AF	=	(	R_VALOR_AF	-	Rc_06_VALOR_AF	)	/	Rc_06_VALOR_AF ,

AF_prop_OCUarea = (O_AF / (AREA_AF - AREAPRESERV_AF)), #prop de pessoas ocupadas por hectare da AF
MP_prop_OCUarea = (O_MP / (AREA_MP - AREAPRESERV_MP)), #prop de pessoas ocupadas por hectare da AF
GP_prop_OCUarea = ((O_T - O_AF) / ((AREA_T - AREA_AF) - AREAPRESERV_GP)), #prop de pessoas ocupadas por hectare da AP


)







# microrregioes_pct <- microrregioes_pct %>%
#   select(-(4:162))
```


Essa análise tem como objetivo verificar, a partir do processo de clusterização, as possíveis formas de agrupar um conjunto de variáveis de modo a regionalizar aspectos que possam auxiliar no melhor entendimento da inclusão produtiva rural. 

Tendo como ponto de partida dois conjuntos selecionados de variáveis, uma relativa a condição dos produtores e outra relativa ao desempenho em inclusão produtiva rural, foram geradas três clusterizações diferentes, uma com cada grupo de variáveis e, uma terceira, unindo ambos os grupos. 



**Sobre a tipologia dos estabelecimentos:**

* Estabelecimentos da agricultura familiar (AF / Fam. / Familiar);
* Estabelecimentos de beneficiados pelo Pronamp - Programa Nacional de Apoio ao Médio Produtor Rural (MP / Pronamp / médio produtor);
  + Pequenos ou médios agricultores rurais que tenham no mínimo, 80% de sua renda bruta anual originária da atividade agropecuária ou extrativa vegetal e possuam renda bruta anual de até R$ 2 milhões;
* Estabelecimentos que não são de agricultura familiar (AP / não familiares / patronais)
  + Nessa análise, foi considerado como de tipologia patronal tudo que não é familiar, ou seja, a diferença entre o total dos estabelecimentos e os estabelecimentos da agricultura familiar.
  
  
Observação: Ao tratar de área útil dos estabelecimentos (hectare útil), o trabalho refere-se a totalidade das áreas dos estabelecimentos, excluídas as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal.


```{r TABELA_POP_BF, message=FALSE, warning=FALSE, include=FALSE}

CENSODEM_10 <- read_excel("data/tabelas/CensoDemografico/CensoDem_2010_3216.xlsx", na = "X") 
CENSODEM_10$COD[CENSODEM_10$NIVEL == "BR"] <- 000
CENSODEM_10 <- CENSODEM_10 %>%
  select(c(COD, POP10_Rur))




# CORRESPONDER MUNICÍPIO E MICRORREGIÃO
corresp <- read_delim("data/tabelas/CORRESPmun_micro/TabelaCorrespondencia_MUN_MICRO.csv", 
                      ";", escape_double = FALSE, locale = locale(encoding = "WINDOWS-1252"))

CADUNICO_familia <- read_delim("data/tabelas/CADUNICO/base_amostra_familia_201712_20190131.csv",
    ";", escape_double = FALSE, col_types = cols(dat_alteracao_fam = col_date(format = "%Y-%m-%d")),
    trim_ws = TRUE)


CADUNICO_familia2 <- CADUNICO_familia %>%
  filter(cod_local_domic_fam == 2) %>% #apenas rural
  filter(marc_pbf == 1) %>% #beneficiários do Bolsa Familia
  group_by(cd_ibge) %>%
  summarise(NumPessoasBF = sum(qtde_pessoas)) %>%
  left_join(., corresp, by = c("cd_ibge" = "Código Município Completo")) %>%
  group_by(COD_MICRO) %>%
  summarise(NumPessoasBF = sum(NumPessoasBF)) %>%
  mutate(COD_MICRO = as.character(COD_MICRO))


CADUNICO_POP <- CADUNICO_familia2 %>%
  left_join(., CENSODEM_10, by = c("COD_MICRO" = "COD")) %>%
  mutate(pct_POPrur_BF = (NumPessoasBF / POP10_Rur)) # Cálculo da porcentagem da população beneficiária do BF


#Juntando a tabela com as variáveis do Censo Agro e os dados do CADUNICO

microrregioes_CLI <- microrregioes_pct %>%
  left_join(., CADUNICO_POP, by = c("COD" = "COD_MICRO"))

 
```

<br>

# Grupo I - Sobre quem são os produtores

**I - Sobre quem são os produtores**

*Variáveis:*

* Presença 
  + Proporção número de estabelecimentos da AF na microrregião em 2017; 
  + Proporção número de estabelecimentos do Pronamp na microrregião em 2017; 
  + Proporção número de estabelecimentos da AP na microrregião em 2017;  
  + Total de estabelecimentos;  
  + Proporção da área de estabelecimentos AF no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos do Pronamp no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos da AP no total da microrregião em 2017; 
  + Total de área. 

* Produtividade 
  + VBP da AF por hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP dos Médios/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP AP/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017. 

* Situação de pobreza
  + Porcentagem da população rural beneficiária do Programa Bolsa Família em 2017. 

* Pessoal ocupado
  + Proporção do pessoal ocupado da microrregião na AF em 2017; 
  + Proporção do pessoal ocupado da microrregião no Pronamp em 2017;  
  + Proporção do pessoal ocupado da microrregião na AP em 2017;  
  + Pessoas ocupadas. 
  

```{r Criando a tabela Cluster I, message=FALSE, warning=FALSE, include=FALSE}

variaveis_clusterI <- microrregioes_CLI %>%
  filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>%
  select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO,
         AF_prop_NEstab, MP_prop_NEstab, GP_prop_NEstab, NEST_T, 
         AF_prop_AREA, MP_prop_AREA, GP_prop_AREA, AREA_T, 
         AF_VPdivAREA, MP_VPdivAREA, GP_VPdivAREA, 
         pct_POPrur_BF, 
         AF_prop_OCU, MP_prop_OCU, GP_prop_OCU, O_T) 

```

Com o objetivo de observar a correlação inicial entre as variáveis, foi montado um correlograma que indica de -1 a 1 qual a correlação entre cada uma delas, sendo -1 uma correlação inversamente proporcional perfeita, 0 a inexistência de correlação e 1 uma correlação proporcional perfeita.
Observando o correlograma abaixo, nota-se que, exceto para o VBP, em todos os grupos de indicadores em que foram analisados dados tanto da agricultura familiar quanto da agricultura patronal (quantidade de estabelecimentos, área e pessoal ocupado), as correlações foram inversamente proporcionais entre as duas tipologias. Esse resultado tem explicação contida na definição da própria variável de estabelecimentos patronais, que é calculada a partir de todos os estabelecimentos, exceto os de agricultura familiar. 


```{r Normalizando variaveis I, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
variaveis_clusterI[is.na(variaveis_clusterI)] <- 0

# Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização
variaveis_clusterI_2 <- variaveis_clusterI %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame()


variaveis_clusterI_3 <- variaveis_clusterI_2 %>%
  select(5:20) %>%
  rename(
    "Estab. - % de estab. (AF)" = AF_prop_NEstab,
    "Estab. - % de estab. (MP)" = MP_prop_NEstab,
    "Estab. - % de estab. (AP)" = GP_prop_NEstab,
    "Estab. - Nº total" = NEST_T,

    "Área - % de área (AF)" = AF_prop_AREA,
    "Área - % de área (MP)" = MP_prop_AREA,
    "Área - % de área (AP)" = GP_prop_AREA,
    "Área - Total" = AREA_T,

    "VBP - VBP/ha (AF)" = AF_VPdivAREA,
    "VBP - VBP/ha (MP)" = MP_VPdivAREA,
    "VBP - VBP/ha (AP)" = GP_VPdivAREA,

    "Bolsa Família - % pop. rural c/ BF" = pct_POPrur_BF,

    "Ocup. - % de ocupados (AF)" = AF_prop_OCU,
    "Ocup. - % de ocupados (MP)" = MP_prop_OCU,
    "Ocup. - % de ocupados (AP)" = GP_prop_OCU,
    "Ocup. - Total de ocupados" = O_T)

# Padronização das escalas
clusterizacaoI_scale <- scale(variaveis_clusterI_3[,-c(1:4)])


# correlacao_CLI <- cor(clusterizacaoI_scale)
# 
# corrplot(correlacao_CLI, method="color",  
#          type="upper", order="hclust", 
#          addCoef.col = "#565656", # Add coefficient of correlation
#          tl.col="black", tl.srt=45) #Text label color and rotation

correlacao_CLI_corrplot <- "data/correlacao_CLI.png"
include_graphics(correlacao_CLI_corrplot)



```

Dado o exposto, a análise de cluster utilizará apenas os dados da agricultura familiar e dos beneficiários do Pronamp (MP), uma vez que é possível inferir interpretações para os estabelecimentos patronais a partir de uma interpretação inversa a dos familiares.


### 1.1. Número ideal de clusters

Após a normalização dos valores (com desvio padrão de 1 e média 0), uma vez que é necessário indicar previamente um número de clusters para iniciar o procedimento de clusterização das variáveis, foram verificados inicialmente três métodos diferentes para determinar o número ideal de clusters, sendo eles:
1. Método do cotovelo (Elbow method)
2. Método de silhueta (Average Silhouette Method) 
3. Método Gap (Gap Statistic Method)


```{r Testes de tamanho de cluster I, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3}

clusterizacaoI_scale <- variaveis_clusterI_2 %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU"))

clusterizacaoI_scale <- scale(clusterizacaoI_scale[,-c(1:4)])


# Elbow method
CLIDEAL_elbow <- fviz_nbclust(clusterizacaoI_scale, kmeans, method = "wss") +
    geom_vline(xintercept = 5, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
CLIDEAL_silhou <- fviz_nbclust(clusterizacaoI_scale, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
CLIDEAL_gap <- fviz_nbclust(clusterizacaoI_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")

ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5)
```

As três análises sugeriram números ideias de clusters distintos entre si. Uma vez que o número das duas últimas foi muito inferior, ao invés de utilizar a média dessas análises, como uma alternativa foi utilizada uma função que fornece resultados de 30 índices diferentes para a escolha do melhor número de clusters.

```{r teste numero clusters I, message=FALSE, warning=FALSE, include=FALSE}
nbclust_out <- NbClust::NbClust(
  data = clusterizacaoI_scale,
  distance = "euclidean",
  min.nc = 4, # minimum number of clusters
  max.nc = 8, # maximum number of clusters
  method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans"
)

# # create a dataframe of the optimal number of clusters
# nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ])
# # select only indices which select between 2 and 5 clusters
# nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5)
# 
# # create plot
# ggplot(nbclust_plot) +
#   aes(x = clusters) +
#   geom_histogram(bins = 30L, fill = "#0c4c8a") +
#   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") +
#   theme_minimal()

```

Os resultados dessa análise mostram que:

* 5 testes indicaram 4 como o número ideal de clusters 
* 12 testes indicaram 5 como o número ideal de clusters 
* 0 testes indicaram 6 como o número ideal de clusters 
* 4 testes indicaram 7 como o número ideal de clusters 
* 2 testes indicaram 8 como o número ideal de clusters 

Portanto, de acordo com a maioria, o melhor número de clusters, nesse caso, é 5.


```{r Criacao dos clusters I, message=FALSE, warning=FALSE, include=FALSE}

#CLUSTERs
set.seed(123)
k4 <- kmeans(clusterizacaoI_scale, centers = 4, nstart = 150)
k5 <- kmeans(clusterizacaoI_scale, centers = 5, nstart = 150)
k6 <- kmeans(clusterizacaoI_scale, centers = 6, nstart = 150)
k7 <- kmeans(clusterizacaoI_scale, centers = 7, nstart = 150)
k8 <- kmeans(clusterizacaoI_scale, centers = 8, nstart = 150)
k9 <- kmeans(clusterizacaoI_scale, centers = 9, nstart = 150)
#print(k4)

k4graph <- fviz_cluster(k4, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 4")
k5graph <- fviz_cluster(k5, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 5")
k6graph <- fviz_cluster(k6, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 6")
k9graph <- fviz_cluster(k9, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 9")

# Visualize silhouhette information
# library(cluster)
# #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale))
# teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale)))

```



```{r Manipulacao tabelas clusters I, message=FALSE, warning=FALSE, include=FALSE}

df_clusters <- variaveis_clusterI %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
  mutate(Cluster4 = k4$cluster,
         Cluster5 = k5$cluster,
         Cluster6 = k6$cluster,
         Cluster7 = k7$cluster,
         Cluster9 = k9$cluster) 


# df_clusters_k4_sumario <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster4 = k4$cluster) %>%
#   group_by(Cluster4) %>%
#   summarise_all("mean") %>% 
#   mutate(Tamanho = k4$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k4_centers <- as.data.frame(k4[["centers"]])


df_clusters_k5_sumario <- variaveis_clusterI %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
  mutate(Cluster5 = k5$cluster) %>%
  group_by(Cluster5) %>%
  summarise(
    AF_prop_NEstab = mean(AF_prop_NEstab, na.rm = TRUE),
    MP_prop_NEstab = mean(MP_prop_NEstab, na.rm = TRUE),
    NEST_Tsum = sum(NEST_T, na.rm = TRUE)  ,
    NEST_Tmean = mean(NEST_T, na.rm = TRUE)  ,
    AF_prop_AREA = mean(AF_prop_AREA, na.rm = TRUE),
    MP_prop_AREA = mean(MP_prop_AREA, na.rm = TRUE),
    AREA_Tsum  = sum(AREA_T, na.rm = TRUE)  ,
    AREA_Tmean  = mean(AREA_T, na.rm = TRUE)  ,
    AF_VPdivAREA = mean(AF_VPdivAREA, na.rm = TRUE),
    MP_VPdivAREA = mean(MP_VPdivAREA, na.rm = TRUE),
    GP_VPdivAREA = mean(GP_VPdivAREA, na.rm = TRUE),
    pct_POPrur_BF = mean(pct_POPrur_BF, na.rm = TRUE),
    AF_prop_OCU = mean(AF_prop_OCU, na.rm = TRUE),
    MP_prop_OCU = mean(MP_prop_OCU, na.rm = TRUE),
    O_Tsum = sum(O_T, na.rm = TRUE),
    O_Tmean = mean(O_T, na.rm = TRUE)
  ) %>%
  # summarise_all("mean") %>% 
  mutate(Tamanho = k5$size) #%>%
  # select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k5_centers <- as.data.frame(k5[["centers"]])



# df_clusters_k6_sumario <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster6 = k6$cluster) %>%
#   group_by(Cluster6) %>%
#   summarise_all("mean") %>%
#   mutate(Tamanho = k6$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k6_centers <- as.data.frame(k6[["centers"]])
# 
# df_clusters_k7_sumario <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster7 = k7$cluster) %>%
#   group_by(Cluster7) %>%
#   summarise_all("mean") %>%
#   mutate(Tamanho = k7$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k7_centers <- as.data.frame(k7[["centers"]])
# 
# df_clusters_k9_sumario <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster9 = k9$cluster) %>%
#   group_by(Cluster9) %>%
#   summarise_all("mean") %>%
#   mutate(Tamanho = k9$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# 
# 
# df_clusters_k9_sumario_MD <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster9 = k9$cluster) %>%
#   group_by(Cluster9) %>%
#   summarise_at(c(6:12), median) %>%
#   mutate(Tamanho = k9$size) 
# 
# df_clusters_k9_centers <- as.data.frame(k9[["centers"]])

```




### 1.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r tabela sumario I, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k5_sumarioSCALES <- df_clusters_k5_sumario %>%
  mutate(AF_prop_NEstab = scales::percent(round(AF_prop_NEstab, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
         MP_prop_NEstab = scales::percent(round(MP_prop_NEstab, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         NEST_Tsum = paste(format(round(NEST_Tsum), decimal.mark=",", big.mark = "."), " estab."),
         NEST_Tmean = paste(format(round(NEST_Tmean), decimal.mark=",", big.mark = "."), " estab."),
         
         AF_prop_AREA = scales::percent(round(AF_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_AREA = scales::percent(round(MP_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         AREA_Tsum = paste(format(round(AREA_Tsum), decimal.mark=",", big.mark = "."), "ha"),
         AREA_Tmean = paste(format(round(AREA_Tmean), decimal.mark=",", big.mark = "."), "ha"),
         
         AF_VPdivAREA = paste("R$", format(round(AF_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         MP_VPdivAREA = paste("R$", format(round(MP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         GP_VPdivAREA = paste("R$", format(round(GP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         
         pct_POPrur_BF = scales::percent(round(pct_POPrur_BF, 4), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         
         AF_prop_OCU = scales::percent(round(AF_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_OCU = scales::percent(round(MP_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         O_Tsum = paste(format(round(O_Tsum), decimal.mark=",", big.mark = "."), " pessoas"),
         O_Tmean = paste(format(round(O_Tmean), decimal.mark=",", big.mark = "."), " pessoas")
        )

# real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",")

df_clusters_k5_sumarioPLOT <-
  as.data.frame(t(df_clusters_k5_sumarioSCALES)) %>%
  rename("CL 1" = 1,
         "CL 2" = 2,
         "CL 3" = 3,
         "CL 4" = 4,
         "CL 5" = 5) %>%
  slice(-1)


# mutate("Origem da renda" = (recode(names,
#                 "AF_prod" = "Produção do estabelecimento",
#                 "MP_prod" = "Produção do estabelecimento",
#                 "GP_prod" = "Produção do estabelecimento",
#                 "AF_fora" = "Fora do estabelecimento",
#                 "MP_fora" = "Fora do estabelecimento",
#                 "GP_fora" = "Fora do estabelecimento",
#                 "AF_outr" = "Outras do estabelecimento",
#                 "MP_outr" = "Outras do estabelecimento",
#                 "GP_outr" = "Outras do estabelecimento",
#                 "AF_prog" = "Programas e políticas",
#                 "MP_prog" = "Programas e políticas",
#                 "GP_prog" = "Programas e políticas"))) %>%
#   mutate(TIPOLOGIA = recode(TIPOLOGIA, 
#          "AF" = "Agricultura familiar",
#          "MP" = "Pronamp",
#          "GP" = "Agricultura patronal*")) %>%
#   select(-names) %>%
#   dplyr::relocate("Origem da renda", .after = TIPOLOGIA) %>%
#   arrange(desc(TIPOLOGIA))  %>%
#   rename(Tipologia = TIPOLOGIA)




df_clusters_k5_sumarioPLOT <- df_clusters_k5_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

df_clusters_k5_sumarioPLOT[1,1] <- "% de estab. (AF)" 
df_clusters_k5_sumarioPLOT[2,1] <- "% de estab. (MP)"
df_clusters_k5_sumarioPLOT[3,1] <- "Total de estabelecimentos no cluster"
df_clusters_k5_sumarioPLOT[4,1] <- "Média do total de estabelecimentos por micro"

df_clusters_k5_sumarioPLOT[5,1] <- "% de área (AF)"
df_clusters_k5_sumarioPLOT[6,1] <- "% de área (MP)"
df_clusters_k5_sumarioPLOT[7,1] <- "Área total em ha"
df_clusters_k5_sumarioPLOT[8,1] <- "Média de área em ha"

df_clusters_k5_sumarioPLOT[9,1] <- "VBP/ha (AF)"
df_clusters_k5_sumarioPLOT[10,1] <- "VBP/ha (MP)"
df_clusters_k5_sumarioPLOT[11,1] <- "VBP/ha (AP)"


df_clusters_k5_sumarioPLOT[12,1] <- "% da população rural beneficiária do Bolsa Família"

df_clusters_k5_sumarioPLOT[13,1] <- "% de ocupados (AF)"
df_clusters_k5_sumarioPLOT[14,1] <- "% de ocupados (MP)"
df_clusters_k5_sumarioPLOT[15,1] <- "Total de ocupados no cluster"
df_clusters_k5_sumarioPLOT[16,1] <- "Média do total de ocupados por micro"

df_clusters_k5_sumarioPLOT[17,1] <- "Nº total de microrregiões"



kbl(df_clusters_k5_sumarioPLOT, digits = 2, 
    caption = "", align = "lccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Estabelecimentos", 1, 4) %>%
  pack_rows("Área", 5, 8) %>%
  pack_rows("VBP", 9, 11) %>%
  pack_rows("Assistência social", 12, 12) %>%
  pack_rows("Pessoal ocupado", 13, 16)

```


### 1.3. Descrição dos clusters

* Cluster 1 

Apesar das microrregiões serem compostas por, em média, 65% de estabelecimentos da agricultura familiar, nesse cluster esses estabelecimentos apresentam a menor expressão em área dentre todos os outros clusters, com média de 13%. Isso significa que, apesar de em número de estabelecimentos a agricultura familiar ainda ser predominante, em área ela é pouquíssimo representativa nesse cluster, que possui em média nas microrregiões 87% de ocupação da agricultura não familiar (chamada aqui de patronal), e 57% de beneficiários do Pronamp (chamados aqui também de médios produtores). 
Dentre todos os clusters e tipologias, é nessa região que os estabelecimentos de beneficiários do Pronamp apresenta o menor valor bruto da produção por hectare útil (definindo-se aqui como hectare útil as áreas de estabelecimentos agropecuários, exceto as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal), com média nas microrregiões de R\$486/ha, contra R\$980/ha da agricultura familiar e R$1396/ha na agricultura patronal (não familiar). Sobre esta variável, observa-se também que embora a agricultura patronal seja a mais rentável do cluster, a diferença desta com a média da familiar não é tão expressiva, possuindo ambos valores relativamente médios quando comparados com os demais clusters. 
Quanto a proporção de pessoas ocupadas, com média e soma total de pessoas ocupadas por microrregião similar ao cluster 5 (região Sudeste), aqui apesar da menor expressão territorial em área da AF, ela é responsável por 51% das pessoas ocupadas nesse cluster. A porcentagem de ocupados beneficiários do Pronamp é a segunda maior dentre todos os clusters, com 33%.
Ainda que não seja possível afirmar que toda a população rural está necessariamente envolvida em atividades agropecuárias, em média 5% das pessoas residentes em áreas rurais são beneficiárias do programa bolsa família na região. Apesar de esse não ser o maior valor dentre os clusters, ele pode ser considerado mediano em comparação com os demais.

  <!-- + Predominância em área de estabelecimentos não familiares (patronais), eficiência mediana da produção (com AP 1,4x maior que a AF), AF emprega tanto quanto AP -->


* Cluster 2 

O cluster 2, localizado majoritariamente na seção norte das regiões Norte e Nordeste, apresente forte predominância da AF em número de estalecimentos, mas ainda é, em média, inferior em área quando comparado com os estabelecimentos patronais, que ocupam em média 60% da área das microrregiões do cluster. Com ampla maioria dos ocupados sendo da agricultura familiar (em média de 74%, contra 26% da patronal e 23% dos beneficiários do Pronamp), a eficiência produtiva em termos do valor bruto da produção por hectare útil é 1,6x maior na AF do que na não familiar, apresentando portanto valores em geral medianos, assim como no cluster 1. 
Quanto a proporção de moradores das zonas rurais beneficiárias do bolsa família, nesse cluster temos o segundo maior valor, com em média 9% da população sendo beneficiária em 2017.

  <!-- + Ainda que 1,5x menor em área do que a AP, a AF emprega mais, é mais produtiva (apesar da diferença ser pouca) e apresenta uma porcentagem considerável da população rural que recebe o benefício do Bolsa Família. -->


* Cluster 3 

Localizado majoritariamente no Nordeste e em algumas porções do Norte, o cluster 3 possui predominância em número de estabelecimentos similar ao cluster 2 (apesar de um número muito maior de estabelecimentos), com proporção média de 81% de estabelecimentos da AF e 19% de estabelecimentos de beneficiários do Pronamp. Apesar dessa predominância em número, em área os estabelecimentos patronais ainda ocupam, em média, metade das microrregiões desse clusters. Diferentemente do cluster anterior, neste a eficiência produtiva em VBP/ha é em média 2,2x maior nos estabelecimentos não familiares.
Assim como no cluster 2, a proporção de pessoas ocupadas nos estabelecimentos é muito maior na AF do que na AP (em média 3,45x maior). Esse cluster é o que apresenta a maior proporção de população rural beneficiária do Bolsa Família, com em média 11% recebendo o benefício em 2017.

  <!-- + Área da AF equilibrada com área ocupada pela AP, porcentagem grande da população rural beneficiária do BF, alto número de ocupados -->


* Cluster 4 

Localizado em grande porção do estado de Santa Catarina, sul do Paraná e norte do Rio Grande do Sul, esse é o único cluster no qual a agricultura familiar predomina não apenas em número de estabelecimentos, como também em área, tendo os estabelecimentos da AF ocupando uma média de 51% da área do cluster, mas com valor máximo em microrregião que pode chegar a 91%.
Esse é o cluster que possui a maior média de VBP/ha útil, sendo 1,7x maior que o segundo maior valor da AF, e 5,4x maior na agricultura familiar do que na patronal. Diferente dos estabelecimentos do Pronamp nos outros clusters, que apresentam VBP/ha útil baixíssimo, nesse o valor da produção é o segundo maior quando comparado com todas as outras tipologias em todos os clusters.
Outro fator de destaque desse cluster reside na porcentagem de população rural que recebia o benefício do Bolsa Família em 2017: o cluster apresenta o menor valor de todos, com em média 2,4% de pessoas enquadradas nessa condição. 
Assim como no cluster 2, 3 e 4, a porcentagem média de empregados na AF é muito maior do que a de empregados na não familiar. 

  <!-- + AF de altíssimo VBP/ha, predominante em área, com baixa % da pop. beneficiária do BF e altíssima proporção de ocupados na AF -->


* Cluster 5

O cluster 5, localizado predominantemente na região Sudeste, apresenta proporções similares ao cluster 1 em termos de número de estabelecimentos e área por tipologia. Com ocupação de apenas 18% da área dada por estabelecimentos familiares, os estabelecimentos não patronais ocupam uma área 4,5x maior, com 36% dos estabelecimentos em média, em comparação com 64% da AF. 
Apesar da similaridade inicial com o cluster 1 (do Centro-Oeste), a principal diferença entre eles pode ser encontrada no VBP/ha útil, com a AF sendo em média 3x mais eficiente do que a agricultura não familiar. Outro destaque relevante é que esse é o único cluster que, em média, possui mais pessoas ocupadas em estabelecimentos não familiares do que em familiares (com uma pequena vantagem).
Ainda que em média o cluster tenha uma porcentagem pequena de pessoas beneficiárias do bolsa família, é relevante destacar nesse caso a existência de uma grande variância no dado, apresentando como valor máximo uma microrregião na qual 43% da população rural era beneficiária do Bolsa Família em 2017.

  <!-- + Algumas áreas de maior vulnerabilidade, AP mais eficiente do que AF, com predominancia em área da AP. -->



### 1.4. Representação espacial dos clusters

```{r CODmapas PREPARACAO I, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}

SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
st_crs(SHP_Microrregioes)
tmap_mode("view")
# tmap_mode("plot") #> tmap mode set to plotting
# Mudando o nome pra ficar igual ao da tabela
names(SHP_Microrregioes)[1] <- "COD"


# Juntando o shape e a tabela
SHP_clusters <- SHP_Microrregioes %>%
  left_join(., df_clusters, by = "COD")



# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```

<br>



```{r Mapeando os clusters I, echo=FALSE, message=FALSE, warning=FALSE}

SHP_clusters %>%
  filter(!is.na(Cluster5)) %>%
  tm_shape() +
  tm_fill(col = "Cluster5", 
          title = "Clusters (n=5)", 
          id = "LOCALIZACAO", palette="Accent",
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1) 

# ### CLUSTER 6
# SHP_clusters %>%
#   filter(!is.na(Cluster6)) %>%
#   tm_shape() +
#   tm_fill(col = "Cluster6",
#           title = "Clusters",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)
# 
# ### CLUSTER 7
# SHP_clusters %>%
#   filter(!is.na(Cluster7)) %>%
#   tm_shape() +
#   tm_fill(col = "Cluster7",
#           title = "Clusters",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)
# 
# ### CLUSTER 9
# SHP_clusters %>%
#   tm_shape() +
#   tm_fill(col = "Cluster9",
#           title = "Clusters (n=9)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

```

<br>
<br>


### 1.5. Tabela descritiva

Sumário com médias, medianas, mínimos e máximos das microrregiões para cada uma das variáveis utilizadas


```{r Tabela de resumo I, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

options(qwraps2_markup = 'markdown')

our_summary1 <-
  list("Proporção de estabelecimentos AF" =
       list("min"       = ~ scales::percent(round(min(AF_prop_NEstab), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop_NEstab), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop_NEstab), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop_NEstab), 2))),
       "Proporção de estabelecimentos MP" =
       list("min"       = ~ scales::percent(round(min(MP_prop_NEstab), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop_NEstab), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop_NEstab), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop_NEstab), 2))),
       "Estabelecimentos nas micro" =
       list("min"       = ~ paste(round(min(NEST_T), 2), " estab."),
            "Mediana"    = ~ paste(round(median(NEST_T), 2), " estab."),
            "max"       = ~ paste(round(max(NEST_T), 2), " estab."),
            "Média"      = ~ paste(round(mean(NEST_T), 2), " estab.")),
       
       
       "Proporção de área AF" =
       list("min"       = ~ scales::percent(round(min(AF_prop_AREA), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop_AREA), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop_AREA), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop_AREA), 2))),
       "Proporção de área MP" =
       list("min"       = ~ scales::percent(round(min(MP_prop_AREA), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop_AREA), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop_AREA), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop_AREA), 2))),
       "Área total dos estab. nas micro" =
       list("min"       = ~ paste(round(min(AREA_T), 2), " ha"),
            "Mediana"    = ~ paste(round(median(AREA_T), 2), " ha"),
            "max"       = ~ paste(round(max(AREA_T), 2), " ha"),
            "Média"      = ~ paste(round(mean(AREA_T), 2), " ha")),
       
       
       "VP/ha da AF" =
       list("min"       = ~ paste("R$", round(min(AF_VPdivAREA)), "/ha"),
            "Mediana"    = ~ paste("R$", round(median(AF_VPdivAREA)), "/ha"),
            "max"       = ~ paste("R$", round(max(AF_VPdivAREA)), "/ha"),
            "Média"      = ~ paste("R$", round(mean(AF_VPdivAREA)), "/ha")),
       "VP/ha do MP" =
       list("min"       = ~ paste("R$", round(min(MP_VPdivAREA)), "/ha"),
            "Mediana"    = ~ paste("R$", round(median(MP_VPdivAREA)), "/ha"),
            "max"       = ~ paste("R$", round(max(MP_VPdivAREA)), "/ha"),
            "Média"      = ~ paste("R$", round(mean(MP_VPdivAREA)), "/ha")),
       "VP/ha da AP" =
       list("min"       = ~ paste("R$", round(min(GP_VPdivAREA)), "/ha"),
            "Mediana"    = ~ paste("R$", round(median(GP_VPdivAREA)), "/ha"),
            "max"       = ~ paste("R$", round(max(GP_VPdivAREA)), "/ha"),
            "Média"      = ~ paste("R$", round(mean(GP_VPdivAREA)), "/ha")),
       
       
       "Assistência social - % de beneficiários do Bolsa Familia (áreas rurais)" =
       list("min"       = ~ scales::percent(round(min(pct_POPrur_BF), 2)),
            "Mediana"    = ~ scales::percent(round(median(pct_POPrur_BF), 2)),
            "max"       = ~ scales::percent(round(max(pct_POPrur_BF), 2)),
            "Média"      = ~ scales::percent(round(mean(pct_POPrur_BF), 2))),
       
       
       "Proporção de ocupados na AF" =
       list("min"       = ~ scales::percent(round(min(AF_prop_OCU), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop_OCU), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop_OCU), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop_OCU), 2))),
       "Proporção de ocupados na MP" =
       list("min"       = ~ scales::percent(round(min(MP_prop_OCU), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop_OCU), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop_OCU), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop_OCU), 2))),
       "Total de ocupados nas micro" =
       list("min"       = ~ paste(round(min(O_T), 2), "pessoas"),
            "Mediana"    = ~ paste(round(median(O_T), 2), "pessoas"),
            "max"       = ~ paste(round(max(O_T), 2), "pessoas"),
            "Média"      = ~ paste(round(mean(O_T), 2), "pessoas"))
  )




tabelaresumo1 <- qwraps2::summary_table(df_clusters, our_summary1)
#kbl(tabelaresumo1)

tabelaresumo2 <- qwraps2::summary_table(dplyr::group_by(df_clusters, Cluster5), our_summary1)
print(tabelaresumo2, rtitle = "Clusters")


```

<br> 
<br>
<br>


# Grupo II - Sobre desempenho em IPR

**II - Sobre desempenho em IPR**

*Variáveis:*

* Evolução da renda 
  + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AF na microrregião 2006-2017.
  + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AP na microrregião 2006-2017. 

* Renda pelo trabalho
  + Renda da AF por trabalhador ocupado na microrregião em 2017. 
  + Renda dos beneficiários do Pronamp por trabalhador ocupado na microrregião em 2017.  
  + Renda da AP por trabalhador ocupado na microrregião em 2017. 

* Evolução pessoal ocupado 
  + Aumento ou redução do pessoal ocupado na AF 2006-2017. 
  + Aumento ou redução do pessoal ocupado na AP 2006-2017. 

* Pessoal ocupado
  + Número de trabalhadores ocupados por hectare na AF da microrregião em 2017. 
  + Número de trabalhadores ocupados por hectare nos beneficiários do Pronamp da microrregião em 2017. 
  + Número de trabalhadores ocupados por hectare na AP da microrregião em 2017. 

* Rendas de programas sociais
  + Proporção da renda dos estabelecimentos da agricultura familiar composta por programas e políticas para AF em 2017. 

* Rendas produtivas não agrícolas
  + Proporção da renda dos estabelecimentos da AF com outras receitas ou fora do estabelecimento em 2017.
  + Proporção da renda dos estabelecimentos do Pronamp com outras receitas ou fora do estabelecimento em 2017.
  + Proporção da renda dos estabelecimentos da AP com outras receitas ou fora do estabelecimento em 2017. 




```{r Criando a tabela Cluster II, message=FALSE, warning=FALSE, include=FALSE}

variaveis_clusterII <- microrregioes_CLI %>%
  filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>%
  mutate(AF_prop3_REC_naoPROD = (R_VALOR_AF_2 + R_VALOR_AF_302) / R_VALOR_AF_TOT ,
         MP_prop3_REC_naoPROD = (R_VALOR_MP_2 + R_VALOR_MP_302) / R_VALOR_MP_TOT ,
         GP_prop3_REC_naoPROD = ((R_VALOR_T_302 - R_VALOR_AF_302) +  (R_VALOR_T_2 - R_VALOR_AF_2))  / (R_VALOR_T_TOT - R_VALOR_AF_TOT)) %>%
  select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO,
         
         Dif_REND_AF, Dif_REND_NAF,
         REND_OCU_AF, REND_OCU_NAF, REND_OCU_MP,
         Dif_OCU_AF, Dif_OCU_NAF,
         AF_prop_OCUarea, MP_prop_OCUarea, GP_prop_OCUarea,
         AF_prop3_REC_PROG, 
         AF_prop3_REC_naoPROD, MP_prop3_REC_naoPROD, GP_prop3_REC_naoPROD 
         ) 

```

Com o objetivo de observar a correlação inicial entre as variáveis, foi montado um correlograma que indica de -1 a 1 qual a correlação entre cada uma delas, sendo -1 uma correlação inversamente proporcional perfeita, 0 a inexistência de correlação e 1 uma correlação proporcional perfeita.
Observando o correlograma, nota-se que, nesse caso, a única variável que apresenta correlação muito alta ou muito baixa com outra, é a de **ocupados/ha do Pronamp e da agricultura patronal**. Diferente do primeiro caso, no qual as variáveis excluídas eram complementares entre si - uma vez que os valores para agricultura familiar são equivalentes aos totais excluídos os valores da agricultura familiar -, nesse caso apesar das duas variáveis mencionadas possuírem correlação altíssima, ambas serão mantidas por não ser possível afirmar que são necessariamente complementares.


```{r Normalizando variaveis e correlacao II, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
variaveis_clusterII[is.na(variaveis_clusterII)] <- 0

# Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização
variaveis_clusterII_2 <- variaveis_clusterII %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame()

variaveis_clusterII_2 <- variaveis_clusterII_2 %>%
  select(5:18) %>%
  rename(
    "Evol. renda (Fam.)" = Dif_REND_AF,
    "Evol. renda (Patr.)" = Dif_REND_NAF,

    "Renda por ocupado (Fam.)" = REND_OCU_AF,
    "Renda por ocupado (Pronamp)" = REND_OCU_MP,
    "Renda por ocupado (Patr.)" = REND_OCU_NAF,
    
    "Evol. ocupados (Fam.)" = Dif_OCU_AF ,  
    "Evol. ocupados (Patr.)" = Dif_OCU_NAF ,

    "Ocupados/ha (Fam.)" = AF_prop_OCUarea  ,
    "Ocupados/ha (Pronamp)" = MP_prop_OCUarea  ,
    "Ocupados/ha (Patr.)" = GP_prop_OCUarea  ,
    
    "Rendas prog. soc. (Fam.)" = AF_prop3_REC_PROG,

    "Rendas não produt. (Fam.)" = AF_prop3_REC_naoPROD ,
    "Rendas não produt. (Pronamp)" = MP_prop3_REC_naoPROD ,
    "Rendas não produt. (Patr.)" = GP_prop3_REC_naoPROD)

# Padronização das escalas
clusterizacaoII_scale <- scale(variaveis_clusterII_2)

# correlacao_CLII <- cor(clusterizacaoII_scale)
# 
# corrplot(correlacao_CLII, method="color",  
#          type="upper", order="hclust", 
#          addCoef.col = "#565656", # Add coefficient of correlation
#          tl.col="black", tl.srt=45) #Text label color and rotation

correlacao_CLII_corrplot <- "data/correlacao_CLII.png"
include_graphics(correlacao_CLII_corrplot)

```


### 2.1. Número ideal de clusters

Após a normalização dos valores (com desvio padrão de 1 e média 0), uma vez que é necessário indicar previamente um número de clusters para iniciar o procedimento de clusterização das variáveis, foram verificados inicialmente três métodos diferentes para determinar o número ideal de clusters, sendo eles:
1. Método do cotovelo (Elbow method)
2. Método de silhueta (Average Silhouette Method) 
3. Método Gap (Gap Statistic Method)


```{r Testes de tamanho de cluster II, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3}

# Padronização das escalas
clusterizacaoII_scale <- scale(variaveis_clusterII_2)

# Elbow method
CLIDEAL_elbow <- fviz_nbclust(clusterizacaoII_scale, kmeans, method = "wss") +
    #geom_vline(xintercept = 6, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
CLIDEAL_silhou <- fviz_nbclust(clusterizacaoII_scale, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
CLIDEAL_gap <- fviz_nbclust(clusterizacaoII_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")

ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5)

```

O primeiro método não apresenta um indicativo conclusivo para o número ideal de clusters e os demais indicam como ideal dois clusters, um número excessivamente baixo para a análise que se deseja fazer aqui.

Como uma alternativa, foi utilizada uma função que fornece resultados de 30 índices diferentes para a escolha do melhor número de clusters.
```{r teste numero clusters II, message=FALSE, warning=FALSE, include=FALSE}
nbclust_out <- NbClust::NbClust(
  data = clusterizacaoII_scale,
  distance = "euclidean",
  min.nc = 4, # minimum number of clusters
  max.nc = 8, # maximum number of clusters
  method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans"
)

# create a dataframe of the optimal number of clusters
nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ])
# select only indices which select between 2 and 5 clusters
nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5)

# create plot
# ggplot(nbclust_plot) +
#   aes(x = clusters) +
#   geom_histogram(bins = 30L, fill = "#0c4c8a") +
#   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") +
#   theme_minimal()

```

Os resultados dessa análise mostram que:

* 7 testes indicaram 4 como o número ideal de clusters
* 2 testes indicaram 5 como o número ideal de clusters
* 2 testes indicaram 6 como o número ideal de clusters
* 11 testes indicaram 7 como o número ideal de clusters
* 1 testes indicaram 8 como o número ideal de clusters

Portanto, de acordo com a maioria, o melhor número de clusters, nesse caso, é 7.



```{r Criacao dos clusters II, message=FALSE, warning=FALSE, include=FALSE}

#CLUSTERs
set.seed(123)
k4_II <- kmeans(clusterizacaoII_scale, centers = 4, nstart = 150)
k5_II <- kmeans(clusterizacaoII_scale, centers = 5, nstart = 150)
k6_II <- kmeans(clusterizacaoII_scale, centers = 6, nstart = 150)
k7_II <- kmeans(clusterizacaoII_scale, centers = 7, nstart = 150)
k8_II <- kmeans(clusterizacaoII_scale, centers = 8, nstart = 150)
k9_II <- kmeans(clusterizacaoII_scale, centers = 9, nstart = 150)
#print(k4)

k4graph_II <- fviz_cluster(k4_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 4")
k5graph_II <- fviz_cluster(k5_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 5")
k6graph_II <- fviz_cluster(k6_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 6")
k7graph_II <- fviz_cluster(k7_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 7")
k9graph_II <- fviz_cluster(k9_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 9")

# Visualize silhouhette information
# library(cluster)
# #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale))
# teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale)))

```



```{r Manipulacao tabelas clusters II, message=FALSE, warning=FALSE, include=FALSE}

df_clusters_II <- variaveis_clusterII %>%
  mutate(Cluster4 = k4_II$cluster,
         Cluster5 = k5_II$cluster,
         Cluster6 = k6_II$cluster,
         Cluster7 = k7_II$cluster,
         Cluster9 = k9_II$cluster) 


df_clusters_k4_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster4 = k4_II$cluster) %>%
  group_by(Cluster4) %>%
  summarise_all("mean") %>% 
  mutate(Tamanho = k4_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k4_centers <- as.data.frame(k4[["centers"]])


df_clusters_k5_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster5 = k5_II$cluster) %>%
  group_by(Cluster5) %>%
  summarise_all("mean") %>% 
  mutate(Tamanho = k5_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k5_centers <- as.data.frame(k5[["centers"]])

df_clusters_k6_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster6 = k6_II$cluster) %>%
  group_by(Cluster6) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k6_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k6_centers <- as.data.frame(k6[["centers"]])

df_clusters_k7_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster7 = k7_II$cluster) %>%
  group_by(Cluster7) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k7_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k7_centers <- as.data.frame(k7[["centers"]])

df_clusters_k9_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster9 = k9_II$cluster) %>%
  group_by(Cluster9) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k9_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))

# df_clusters_k9_II_centers <- as.data.frame(k9[["centers"]])

```



### 2.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r tabela sumario II, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k7_II_sumarioSCALES <- df_clusters_k7_II_sumario %>%
  mutate(
    
    Dif_REND_AF = scales::percent(round(Dif_REND_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE)    ,
    Dif_REND_NAF = scales::percent(round(Dif_REND_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
    
    REND_OCU_AF = paste("R$",round(REND_OCU_AF), "/ ocupado") ,
    REND_OCU_MP = paste("R$",round(REND_OCU_MP), "/ ocupado")  ,
    REND_OCU_NAF = paste("R$",round(REND_OCU_NAF), "/ ocupado")  ,
    
    Dif_OCU_AF = scales::percent(round(Dif_OCU_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,  
    Dif_OCU_NAF = scales::percent(round(Dif_OCU_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    
    AF_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / AF_prop_OCUarea), 2), "ha"), 
    MP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / MP_prop_OCUarea), 2), "ha"), 
    GP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / GP_prop_OCUarea), 2), "ha"), 
    
    AF_prop3_REC_PROG = scales::percent(round(AF_prop3_REC_PROG, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    
    AF_prop3_REC_naoPROD = scales::percent(round(AF_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , 
    MP_prop3_REC_naoPROD = scales::percent(round(MP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    GP_prop3_REC_naoPROD = scales::percent(round(GP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) 
  ) %>%
  
  relocate(REND_OCU_MP, .after = REND_OCU_AF)
    
    
# real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",")

df_clusters_k7_II_sumarioPLOT <-
  as.data.frame(t(df_clusters_k7_II_sumarioSCALES)) %>%
  rename("CL 1" = V1,
         "CL 2" = V2,
         "CL 3" = V3,
         "CL 4" = V4,
         "CL 5" = V5,
         "CL 6" = V6,
         "CL 7" = V7) %>%
  slice(-1)


df_clusters_k7_II_sumarioPLOT <- df_clusters_k7_II_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

df_clusters_k7_II_sumarioPLOT[1,1] <- "Aumento/redução % da renda (Fam.)"
df_clusters_k7_II_sumarioPLOT[2,1] <- "Aumento/redução % da renda (Patr.)"

df_clusters_k7_II_sumarioPLOT[3,1] <- "Renda por pessoa ocupada (Fam.)"
df_clusters_k7_II_sumarioPLOT[4,1] <- "Renda por pessoa ocupada (Pronamp)"
df_clusters_k7_II_sumarioPLOT[5,1] <- "Renda por pessoa ocupada (Patr.)"

df_clusters_k7_II_sumarioPLOT[6,1] <- "Aumento/redução % de ocupados (Fam.)"
df_clusters_k7_II_sumarioPLOT[7,1] <- "Aumento/redução % de ocupados (Patr.)"

df_clusters_k7_II_sumarioPLOT[8,1] <- "Pessoas ocupadas por ha (Fam.)"
df_clusters_k7_II_sumarioPLOT[9,1] <- "Pessoas ocupadas por ha (Pronamp)"
df_clusters_k7_II_sumarioPLOT[10,1] <- "Pessoas ocupadas por ha (Patr.)"


df_clusters_k7_II_sumarioPLOT[11,1] <- "% renda composta por prog. e pol. (Fam.)"
df_clusters_k7_II_sumarioPLOT[12,1] <- "% rendas não agrícolas (Fam.)"
df_clusters_k7_II_sumarioPLOT[13,1] <- "% rendas não agrícolas (Pronamp)"
df_clusters_k7_II_sumarioPLOT[14,1] <- "% rendas não agrícolas (Patr.)"

df_clusters_k7_II_sumarioPLOT[15,1] <- "Nº total de microrregiões"



kbl(df_clusters_k7_II_sumarioPLOT, digits = 2, 
    caption = "", align = "lccccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Evolução da renda", 1, 2) %>%
  pack_rows("Renda pelo trabalho", 3, 5) %>%
  pack_rows("Evolução do pessoal ocupado", 6, 7) %>%
  pack_rows("Pessoal ocupado por ha útil", 8, 10) %>%
  pack_rows("Rendas de programas sociais", 11, 11) %>%
  pack_rows("Rendas produtivas não agrícolas", 12, 14)

```

<br> 

### 2.3. Descrição dos clusters

Consideração inicial: Apesar do número ideal de clusters ter sido sete, um cluster possui apenas 4 microrregiões (cluster 3) e dois possuem 22 e 24 microrregiões (cluster 5 e 6, respectivamente), números bastante inferiores aos da clusterização anterior. Entretando, apesar do valor baixo, eles foram mantidos na análise por se tratarem de outliers de dados importantes de serem analisados.


* Cluster 1 

O primeiro cluster abrange uma extensão territorial que vai da região Sul ao Centro-Oeste, passando pelo Sudeste, mas fazendo um corte que não incorpora as microrregiões mais próximas ao litoral do país (sem presença nos estados do Rio de Janeiro e do Espírito Santo). Apesar de apresentar um aumento na renda tanto dos estabelecimentos familiares quanto nos não familiares de 2006 para 2017, esse aumento foi em média 1,6x maior nos patronais. 
Assim como em todos os outros clusters, a renda por pessoa ocupada nos estabelecimentos foi em média maior na agricultura patronal do que na familiar, com a segunda maior diferença entre as outras regiões (5x maior). Independente dessa diferença observada, tanto AF quanto AP possuem os maiores valores dentro da sua tipologia em comparação com os demais clusteres, sendo este portanto o cluster com maior renda por pessoa ocupada em 2017.
Do mesmo modo que será destacado nos clusters 2, 4, e 5, enquanto o número de ocupados aumentou de 2006 para 2017 na agricultura não familiar, ele reduziu na agricultura familiar (em média, 12% de aumento contra 14% de redução). 
Como já poderia ser antecipado, em todos os clusters o número de ocupados por ha útil é superior na agricultura familiar. Nesse caso, é relevante denotar a diferença entre uma mesma tipologia para os diferentes clusters: o cluster 1 é superior no número de pessoas ocupadas por hectare apenas quando em comparação com o cluster 7, tanto na AF quanto na AP.


* Cluster 2 

O cluster 2 ocupa quase a totalidade das microrregiões localizadas na costa brasileira, indo do Sul ao Norte, com algumas ocorrências no Centro Oeste. Tendo tido aumento de renda de 50% para a AP e 20% para a AF, com aumento de 16% em ocupados na AF e redução de 10% em ocupados na AF, o cluster apresenta uma renda por pessoa ocupada de valores medianos, mas 3,5% maiores nos estabelecimentos não patronais.
Apesar do número de pessoas ocupadas por hectare útil nos estabelecimentos ser superior na agricultura patronal, os valores das três tipologias são inferiores aos do cluster anterior, indicando que em quaisquer tipologia que seja há mais pessoas ocupadas por área do que no cluster 1. 
Também assim como nos demais clusters, em média as rendas não agrícolas compõem mais o total dos rendimentos nos estabelecimentos patronais do que nos estabelecimentos familiares. 


* Cluster 3 

O cluster 3 é um caso especial. Por possuir valores muito distintos dos demais, apenas quatro microrregiões fazem parte desse recorte. O que torna esse cluster tão distinto dos demais são três características principais: a primeira se trata de um aumento gigantesco na renda dos estabelecimentos patronais de 2006 para 2017 (404% de aumento), contra ínfimos 3% da agricultura familiar; a segunda característica se dá no aumento percentual do número de ocupados, que cresce 439% (valor mais do que 5x maior do que o segundo maior aumento); e o terceiro ponto é um baixíssimo número de pessoas ocupadas por hectare útil, o que pela região de localização do cluster pode se dar devido a uma grande quantidade de área protegida.


* Cluster 4 

Nesse cluster temos a região que menos apresentou aumento de renda na agricultura não familiar e a segunda posição de maior redução na agricultura familiar dentre os clusters. Em comparação com os demais, a renda por pessoa ocupada é baixa, mas o número de ocupados nos estabelecimentos patronais aumentou 46%, enquanto que o de familiares reduziu 20%. 
Dentre todos os clusters, em conjunto com o cluster 5, na AP e no Pronamp ocorrem os valores mais altos da média de participação de rendas não agrícolas na composição da renda dos estabelecimentos nas microrregiões. 

 
* Cluster 5 

O quinto cluster, espacialmente muito próximo do 4º, possui valores extremamente similares a este nas categorias de renda pelo trabalho, evolução do pessoal ocupado, pessoal ocupado por área útil e rendas produtivas não agrícolas. Entretanto, duas diferenças definem o diferencial nesse cluster: a primeira, e principal diferença, é que esse cluster é o único que tem média de composição da renda de programas e políticas acima de 50%, em comparação com os demais que não passam de 2% em média. A segunda é que, diferentemente do cluster 4, que teve redução na renda da AF, aqui houve aumento de 36% em média na renda da AF e 52% em média na renda dos não familiares.


* Cluster 7 

O cluster 7 é o que melhor representa a expansão da agropecuária para Norte do país a partir do Centro-Oeste. Com o maior aumento de renda da AF (141%) e o segundo maior da AP (212%), esse cluster possui os segundos maiores valores da renda por pessoa ocupada, apenas não se equiparando nesse quesito ao primeiro cluster.
Com aumento no número de pessoas ocupadas de 2006 para 2017. esse cluster possui os menores valores de número de pessoas ocupadas por hectare útil. Quanto às rendas não agrícolas, a maior média da AF dentre os clusters pertence a esse, mas tanto Pronamp quanto AP possuem valores medianos em comparação aos demais.



<br> 


### 2.4. Representação espacial dos clusters


```{r CODmapas PREPARACAO II, message=FALSE, warning=FALSE, include=FALSE}

# SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
# SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
# st_crs(SHP_Microrregioes)
# tmap_mode("view")
# # tmap_mode("plot") #> tmap mode set to plotting
# # Mudando o nome pra ficar igual ao da tabela
# names(SHP_Microrregioes)[1] <- "COD"
# 

# Juntando o shape e a tabela
SHP_clusters_II <- SHP_Microrregioes %>%
  left_join(., df_clusters_II, by = "COD")



# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```





```{r Mapeando os clusters II, echo=FALSE, message=FALSE, warning=FALSE}

# SHP_clusters_II %>%
#   tm_shape() +
#   tm_fill(col = "Cluster4",
#           title = "Clusters (n=4)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)
# 
# ### CLUSTER 6
# SHP_clusters_II %>%
#   filter(!is.na(Cluster6)) %>%
#   tm_shape() +
#   tm_fill(col = "Cluster6",
#           title = "Clusters",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

### CLUSTER 7
SHP_clusters_II %>%
  filter(!is.na(Cluster7)) %>%
  tm_shape() +
  tm_fill(col = "Cluster7",
          title = "Clusters",
          id = "LOCALIZACAO", palette="Accent",
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1)

# ### CLUSTER 9
# SHP_clusters_II %>%
#   tm_shape() +
#   tm_fill(col = "Cluster9",
#           title = "Clusters (n=9)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

```


### 2.5. Tabela descritiva

Sumário com médias, medianas, mínimos e máximos das microrregiões para cada uma das variáveis utilizadas


```{r Tabela de resumo II, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

options(qwraps2_markup = 'markdown')
our_summary_II <-
  list("Evolução da renda - Agricultura familiar" =
       list("min"       = ~ scales::percent(round(min(Dif_REND_AF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_REND_AF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_REND_AF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_REND_AF), 2))),
       "Evolução da renda - Agricultura patronal" =
       list("min"       = ~ scales::percent(round(min(Dif_REND_NAF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_REND_NAF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_REND_NAF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_REND_NAF), 2))),
       
       "Renda por trabalhador - Agricultura familiar" =
       list("min"       = ~ paste("R$", round(min(REND_OCU_AF), 2), "/ocupado"),
            "Mediana"    = ~ paste("R$", round(median(REND_OCU_AF), 2), "/ocupado"),
            "max"       = ~ paste("R$", round(max(REND_OCU_AF), 2), "/ocupado"),
            "Média"      = ~ paste("R$", round(mean(REND_OCU_AF), 2), "/ocupado")),
       "Renda por trabalhador - Pronamp" =
       list("min"       = ~ paste("R$", round(min(REND_OCU_MP), 2), "/ocupado"),
            "Mediana"    = ~ paste("R$", round(median(REND_OCU_MP), 2), "/ocupado"),
            "max"       = ~ paste("R$", round(max(REND_OCU_MP), 2), "/ocupado"),
            "Média"      = ~ paste("R$", round(mean(REND_OCU_MP), 2), "/ocupado")),
       "Renda por trabalhador - Agricultura patronal" =
       list("min"       = ~ paste("R$", round(min(REND_OCU_NAF), 2), "/ocupado"),
            "Mediana"    = ~ paste("R$", round(median(REND_OCU_NAF), 2), "/ocupado"),
            "max"       = ~ paste("R$", round(max(REND_OCU_NAF), 2), "/ocupado"),
            "Média"      = ~ paste("R$", round(mean(REND_OCU_NAF), 2), "/ocupado")),
       
       "Evolução do pessoal ocupado - Agricultura familiar" =
       list("min"       = ~ scales::percent(round(min(Dif_OCU_AF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_OCU_AF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_OCU_AF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_OCU_AF), 2))),
       "Evolução do pessoal ocupado - Agricultura patronal" =
       list("min"       = ~ scales::percent(round(min(Dif_OCU_NAF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_OCU_NAF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_OCU_NAF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_OCU_NAF), 2))),
       
       
       "Pessoal ocupado por ha útil - Agricultura familiar" =
       list("min"       = ~ paste("1 pessoa ocup. a cada", round(min(AF_prop_OCUarea), 2), "ha"),
            "Mediana"    = ~ paste("1 pessoa ocup. a cada", round(median(AF_prop_OCUarea), 2), " ha"),
            "max"       = ~ paste("1 pessoa ocup. a cada", round(max(AF_prop_OCUarea), 2), " ha"),
            "Média"      = ~ paste("1 pessoa ocup. a cada", round(mean(AF_prop_OCUarea), 2), " ha")),
       "Pessoal ocupado por ha útil - Pronamp" =
       list("min"       = ~ paste("1 pessoa ocup. a cada", round(min(MP_prop_OCUarea), 2), "ha"),
            "Mediana"    = ~ paste("1 pessoa ocup. a cada", round(median(MP_prop_OCUarea), 2), " ha"),
            "max"       = ~ paste("1 pessoa ocup. a cada", round(max(MP_prop_OCUarea), 2), " ha"),
            "Média"      = ~ paste("1 pessoa ocup. a cada", round(mean(MP_prop_OCUarea), 2), " ha")),
       "Pessoal ocupado por ha útil - Agricultura patronal" =
       list("min"       = ~ paste("1 pessoa ocup. a cada", round(min(GP_prop_OCUarea), 2), "ha"),
            "Mediana"    = ~ paste("1 pessoa ocup. a cada", round(median(GP_prop_OCUarea), 2), " ha"),
            "max"       = ~ paste("1 pessoa ocup. a cada", round(max(GP_prop_OCUarea), 2), " ha"),
            "Média"      = ~ paste("1 pessoa ocup. a cada", round(mean(GP_prop_OCUarea), 2), " ha")),
       
       "Assistência social - % da renda composta por programas e políticas" =
       list("min"       = ~ scales::percent(round(min(AF_prop3_REC_PROG), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop3_REC_PROG), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop3_REC_PROG), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop3_REC_PROG), 2))),
       
       "% das rendas não agrícolas na composição da renda - Agricultura familiar" =
       list("min"       = ~ scales::percent(round(min(AF_prop3_REC_naoPROD), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop3_REC_naoPROD), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop3_REC_naoPROD), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop3_REC_naoPROD), 2))),
       "% das rendas não agrícolas na composição da renda - Pronamp" =
       list("min"       = ~ scales::percent(round(min(MP_prop3_REC_naoPROD), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop3_REC_naoPROD), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop3_REC_naoPROD), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop3_REC_naoPROD), 2))),
       "% das rendas não agrícolas na composição da renda - Agricultura patronal" =
       list("min"       = ~ scales::percent(round(min(GP_prop3_REC_naoPROD), 2)),
            "Mediana"    = ~ scales::percent(round(median(GP_prop3_REC_naoPROD), 2)),
            "max"       = ~ scales::percent(round(max(GP_prop3_REC_naoPROD), 2)),
            "Média"      = ~ scales::percent(round(mean(GP_prop3_REC_naoPROD), 2)))
       
  )




tabelaresumo1_II <- qwraps2::summary_table(df_clusters_II, our_summary_II)
#kbl(tabelaresumo1)

tabelaresumo2_II <- qwraps2::summary_table(dplyr::group_by(df_clusters_II, Cluster7), our_summary_II)
print(tabelaresumo2_II, rtitle = "Clusters")



```

<br> 
<br>
<br>


# Grupo I + II - Quem são os produtores e qual o desempenho em IPR 


**I - Sobre quem são os produtores**

*Variáveis:*

* Presença 
  + Proporção número de estabelecimentos da AF na microrregião em 2017; 
  + Proporção número de estabelecimentos do Pronamp na microrregião em 2017; 
  + Proporção número de estabelecimentos da AP na microrregião em 2017;  
  + Total de estabelecimentos;  
  + Proporção da área de estabelecimentos AF no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos do Pronamp no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos da AP no total da microrregião em 2017; 
  + Total de área. 

* Produtividade 
  + VBP da AF por hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP dos Médios/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP AP/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017. 

* Situação de pobreza
  + Porcentagem da população rural beneficiária do Programa Bolsa Família em 2017. 

* Pessoal ocupado
  + Proporção do pessoal ocupado da microrregião na AF em 2017; 
  + Proporção do pessoal ocupado da microrregião no Pronamp em 2017;  
  + Proporção do pessoal ocupado da microrregião na AP em 2017;  
  + Pessoas ocupadas. 
  


**II - Sobre desempenho em IPR** 

*Variáveis:*

* Evolução da renda 
  + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AF na microrregião 2006-2017.
  + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AP na microrregião 2006-2017. 

* Renda pelo trabalho
  + Renda da AF por trabalhador ocupado na microrregião em 2017. 
  + Renda dos beneficiários do Pronamp por trabalhador ocupado na microrregião em 2017.  
  + Renda da AP por trabalhador ocupado na microrregião em 2017. 

* Evolução pessoal ocupado 
  + Aumento ou redução do pessoal ocupado na AF 2006-2017. 
  + Aumento ou redução do pessoal ocupado na AP 2006-2017. 

* Pessoal ocupado
  + Número de trabalhadores ocupados por hectare na AF da microrregião em 2017. 
  + Número de trabalhadores ocupados por hectare nos beneficiários do Pronamp da microrregião em 2017. 
  + Número de trabalhadores ocupados por hectare na AP da microrregião em 2017. 

* Rendas de programas sociais
  + Proporção da renda dos estabelecimentos da agricultura familiar composta por programas e políticas para AF em 2017. 

* Rendas produtivas não agrícolas
  + Proporção da renda dos estabelecimentos da AF com outras receitas ou fora do estabelecimento em 2017.
  + Proporção da renda dos estabelecimentos do Pronamp com outras receitas ou fora do estabelecimento em 2017.
  + Proporção da renda dos estabelecimentos da AP com outras receitas ou fora do estabelecimento em 2017. 





```{r Criando a tabela Cluster III, message=FALSE, warning=FALSE, include=FALSE}

variaveis_clusterIII <- microrregioes_CLI %>%
  filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>%
  mutate(AF_prop3_REC_naoPROD = (R_VALOR_AF_2 + R_VALOR_AF_302) / R_VALOR_AF_TOT ,
         MP_prop3_REC_naoPROD = (R_VALOR_MP_2 + R_VALOR_MP_302) / R_VALOR_MP_TOT ,
         GP_prop3_REC_naoPROD = ((R_VALOR_T_302 - R_VALOR_AF_302) +  (R_VALOR_T_2 - R_VALOR_AF_2))  / (R_VALOR_T_TOT - R_VALOR_AF_TOT)) %>%
  select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO,
         
         AF_prop_NEstab, MP_prop_NEstab, NEST_T, 
         AF_prop_AREA, MP_prop_AREA, AREA_T, 
         AF_VPdivAREA, MP_VPdivAREA, GP_VPdivAREA, 
         pct_POPrur_BF, 
         AF_prop_OCU, MP_prop_OCU, O_T,
         
         Dif_REND_AF, Dif_REND_NAF,
         REND_OCU_AF, REND_OCU_NAF, REND_OCU_MP,
         Dif_OCU_AF, Dif_OCU_NAF,
         AF_prop_OCUarea, MP_prop_OCUarea, GP_prop_OCUarea,
         AF_prop3_REC_PROG, 
         AF_prop3_REC_naoPROD, MP_prop3_REC_naoPROD, GP_prop3_REC_naoPROD 
         ) 

```


Com o objetivo de observar a correlação final entre as variáveis, foi montado novamente um correlograma que indica de -1 a 1 qual a correlação entre cada uma delas, sendo -1 uma correlação inversamente proporcional perfeita, 0 a inexistência de correlação e 1 uma correlação proporcional perfeita, agora com todas as variáveis da análise.
Observando o correlograma, é possível perceber que existem apenas três correlações com valores extremamente altos/baixos, sendo elas: a proporção de estabelecimentos da agricultura familiar com a proporção de estabelecimentos do Pronamp, o número total de estabelecimentos com o número total de ocupados nos estabelecimentos e o número de ocupados/ha do Pronamp e da agricultura patronal. 



```{r Normalizando variaveis e correlacao III, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
variaveis_clusterIII[is.na(variaveis_clusterIII)] <- 0

# Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização
variaveis_clusterIII_2 <- variaveis_clusterIII %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame()

variaveis_clusterIII_2 <- variaveis_clusterIII_2 %>%
  select(5:31) %>%
  rename(
    
    "Estab. - % de estab. (AF)" = AF_prop_NEstab,
    "Estab. - % de estab. (MP)" = MP_prop_NEstab,
    "Estab. - Nº total" = NEST_T,
    
    "Área - % de área (AF)" = AF_prop_AREA,  
    "Área - % de área (MP)" = MP_prop_AREA,
    "Área - Total" = AREA_T,
    
    "VBP - VBP/ha (AF)" = AF_VPdivAREA,
    "VBP - VBP/ha (MP)" = MP_VPdivAREA,
    "VBP - VBP/ha (AP)" = GP_VPdivAREA,
    
    "Bolsa Família - % pop. rural c/ BF" = pct_POPrur_BF,
    
    "Ocup. - % de ocupados (AF)" = AF_prop_OCU,
    "Ocup. - % de ocupados (MP)" = MP_prop_OCU,
    "Ocup. - Total de ocupados" = O_T,
    
    "Evol. renda (Fam.)" = Dif_REND_AF,
    "Evol. renda (Patr.)" = Dif_REND_NAF,

    "Renda por ocupado (Fam.)" = REND_OCU_AF,
    "Renda por ocupado (Pronamp)" = REND_OCU_MP,
    "Renda por ocupado (Patr.)" = REND_OCU_NAF,
    
    "Evol. ocupados (Fam.)" = Dif_OCU_AF ,  
    "Evol. ocupados (Patr.)" = Dif_OCU_NAF ,

    "Ocupados/ha (Fam.)" = AF_prop_OCUarea  ,
    "Ocupados/ha (Pronamp)" = MP_prop_OCUarea  ,
    "Ocupados/ha (Patr.)" = GP_prop_OCUarea  ,
    
    "Rendas prog. soc. (Fam.)" = AF_prop3_REC_PROG,

    "Rendas não produt. (Fam.)" = AF_prop3_REC_naoPROD ,
    "Rendas não produt. (Pronamp)" = MP_prop3_REC_naoPROD ,
    "Rendas não produt. (Patr.)" = GP_prop3_REC_naoPROD)

# Padronização das escalas
clusterizacaoIII_scale <- scale(variaveis_clusterIII_2)

correlacao_CLIII <- cor(clusterizacaoIII_scale)

# corrplot(correlacao_CLIII, method="color",  
#          type="upper", order="hclust", 
#          addCoef.col = "#565656", # Add coefficient of correlation
#          tl.col="black", tl.srt=45) #Text label color and rotation

correlacao_CLIII_corrplot <- "data/correlacao_CLIII.png"
include_graphics(correlacao_CLIII_corrplot)

```


Apesar da alta correlação, uma vez que optou-se por não realizar a redução das variáveis de análise para componentes principais antes da clusterização, todas as mencionadas serão mantidas na análise sob o mesmo argumento da correlação do grupo II.


```{r}
# #Compute PCA
# 
# res.pca <- prcomp(variaveis_clusterIII_2, scale = TRUE)
# 
# #Visualize eigenvalues (scree plot). Show the percentage of variances explained by each principal component.
# 
# fviz_eig(res.pca)
# 
# 
# 
# fviz_pca_var(res.pca,
#              col.var = "contrib", # Color by contributions to the PC
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#              repel = TRUE     # Avoid text overlapping
#              )
# 
# 
# # Eigenvalues
# eig.val <- get_eigenvalue(res.pca)
# eig.val
#   
# # Results for Variables
# res.var <- get_pca_var(res.pca)
# res.var$coord          # Coordinates
# res.var$contrib        # Contributions to the PCs
# res.var$cos2           # Quality of representation 
# # Results for individuals
# res.ind <- get_pca_ind(res.pca)
# res.ind$coord          # Coordinates
# res.ind$contrib        # Contributions to the PCs
# res.ind$cos2           # Quality of representation 
# 
# 
# View(as.data.frame(res.ind$contrib))

```






### 3.1. Número ideal de clusters

Após a normalização dos valores (com desvio padrão de 1 e média 0), uma vez que é necessário indicar previamente um número de clusters para iniciar o procedimento de clusterização das variáveis, foram verificados inicialmente três métodos diferentes para determinar o número ideal de clusters, sendo eles:
1. Método do cotovelo (Elbow method)
2. Método de silhueta (Average Silhouette Method) 
3. Método Gap (Gap Statistic Method)


```{r Testes de tamanho de cluster III, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3}

# Padronização das escalas
clusterizacaoIII_scale <- scale(variaveis_clusterIII_2)

# Elbow method
CLIDEAL_elbow <- fviz_nbclust(clusterizacaoIII_scale, kmeans, method = "wss") +
    #geom_vline(xintercept = 6, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
CLIDEAL_silhou <- fviz_nbclust(clusterizacaoIII_scale, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
CLIDEAL_gap <- fviz_nbclust(clusterizacaoIII_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")

ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5)

```

O primeiro método não apresenta um indicativo conclusivo para o número ideal de clusters e os demais indicam como ideal dois clusters, um número excessivamente baixo para a análise que se deseja fazer aqui.

Como uma alternativa, foi utilizada uma função que fornece resultados de 30 índices diferentes para a escolha do melhor número de clusters.

```{r teste numero clusters III, message=FALSE, warning=FALSE, include=FALSE}
nbclust_out <- NbClust::NbClust(
  data = clusterizacaoIII_scale,
  distance = "euclidean",
  min.nc = 4, # minimum number of clusters
  max.nc = 8, # maximum number of clusters
  method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans"
)

# create a dataframe of the optimal number of clusters
nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ])
# select only indices which select between 2 and 5 clusters
nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5)

# # create plot
# ggplot(nbclust_plot) +
#   aes(x = clusters) +
#   geom_histogram(bins = 30L, fill = "#0c4c8a") +
#   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") +
#   theme_minimal()

```

Os resultados dessa análise mostram que:

* 9 testes indicaram 4 como o número ideal de clusters
* 1 testes indicaram 5 como o número ideal de clusters
* 11 testes indicaram 7 como o número ideal de clusters
* 2 testes indicaram 8 como o número ideal de clusters

Portanto, de acordo com a maioria, o melhor número de clusters, nesse caso, é 7.



```{r Criacao dos clusters III, echo=FALSE, message=FALSE, warning=FALSE}

#CLUSTERs
set.seed(123)
k4_III <- kmeans(clusterizacaoIII_scale, centers = 4, nstart = 150)
k5_III <- kmeans(clusterizacaoIII_scale, centers = 5, nstart = 150)
k6_III <- kmeans(clusterizacaoIII_scale, centers = 6, nstart = 150)
k7_III <- kmeans(clusterizacaoIII_scale, centers = 7, nstart = 150)
k8_III <- kmeans(clusterizacaoIII_scale, centers = 8, nstart = 150)
k9_III <- kmeans(clusterizacaoIII_scale, centers = 9, nstart = 150)
#print(k4)

k4graph_III <- fviz_cluster(k4_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 4")
k5graph_III <- fviz_cluster(k5_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 5")
k7graph_III <- fviz_cluster(k7_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 7")
k9graph_III <- fviz_cluster(k9_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 9")

# Visualize silhouhette information
# library(cluster)
# #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale))
# teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale)))

```


```{r Manipulacao tabelas clusters III, message=FALSE, warning=FALSE, include=FALSE}

df_clusters_III <- variaveis_clusterIII %>%
  mutate(Cluster4 = k4_III$cluster,
         Cluster5 = k5_III$cluster,
         Cluster6 = k6_III$cluster,
         Cluster7 = k7_III$cluster,
         Cluster9 = k9_III$cluster) 


# df_clusters_k4_III_sumario <- variaveis_clusterIII %>%
#   mutate(Cluster4 = k4_III$cluster) %>%
#   group_by(Cluster4) %>%
#   summarise_all("mean") %>% 
#   mutate(Tamanho = k4_III$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k4_centers <- as.data.frame(k4[["centers"]])
# 
# 
# df_clusters_k5_III_sumario <- variaveis_clusterIII %>%
#   mutate(Cluster5 = k5_III$cluster) %>%
#   group_by(Cluster5) %>%
#   summarise_all("mean") %>% 
#   mutate(Tamanho = k5_III$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k5_centers <- as.data.frame(k5[["centers"]])
# 
# df_clusters_k6_III_sumario <- variaveis_clusterIII %>%
#   mutate(Cluster6 = k6_III$cluster) %>%
#   group_by(Cluster6) %>%
#   summarise_all("mean") %>%
#   mutate(Tamanho = k6_III$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k6_centers <- as.data.frame(k6[["centers"]])

df_clusters_k7_III_sumario <- variaveis_clusterIII %>%
  mutate(Cluster7 = k7_III$cluster) %>%
  group_by(Cluster7) %>%
  summarise(
    AF_prop_NEstab = mean(AF_prop_NEstab, na.rm = TRUE),
    MP_prop_NEstab = mean(MP_prop_NEstab, na.rm = TRUE),
    NEST_Tsum = sum(NEST_T, na.rm = TRUE)  ,
    NEST_Tmean = mean(NEST_T, na.rm = TRUE)  ,
    AF_prop_AREA = mean(AF_prop_AREA, na.rm = TRUE),
    MP_prop_AREA = mean(MP_prop_AREA, na.rm = TRUE),
    AREA_Tsum  = sum(AREA_T, na.rm = TRUE)  ,
    AREA_Tmean  = mean(AREA_T, na.rm = TRUE)  ,
    AF_VPdivAREA = mean(AF_VPdivAREA, na.rm = TRUE),
    MP_VPdivAREA = mean(MP_VPdivAREA, na.rm = TRUE),
    GP_VPdivAREA = mean(GP_VPdivAREA, na.rm = TRUE),
    pct_POPrur_BF = mean(pct_POPrur_BF, na.rm = TRUE),
    AF_prop_OCU = mean(AF_prop_OCU, na.rm = TRUE),
    MP_prop_OCU = mean(MP_prop_OCU, na.rm = TRUE),
    O_Tsum = sum(O_T, na.rm = TRUE),
    O_Tmean = mean(O_T, na.rm = TRUE),

    Dif_REND_AF = mean(Dif_REND_AF, na.rm = TRUE),
    Dif_REND_NAF = mean(Dif_REND_NAF, na.rm = TRUE),

    REND_OCU_AF = mean(REND_OCU_AF, na.rm = TRUE),
    REND_OCU_MP = mean(REND_OCU_MP, na.rm = TRUE),
    REND_OCU_NAF = mean(REND_OCU_NAF, na.rm = TRUE),
    
    Dif_OCU_AF = mean(Dif_OCU_AF, na.rm = TRUE) ,  
    Dif_OCU_NAF = mean(Dif_OCU_NAF, na.rm = TRUE) ,

    AF_prop_OCUarea = mean(AF_prop_OCUarea, na.rm = TRUE)  ,
    MP_prop_OCUarea = mean(MP_prop_OCUarea, na.rm = TRUE)  ,
    GP_prop_OCUarea = mean(GP_prop_OCUarea, na.rm = TRUE)  ,
    
    AF_prop3_REC_PROG = mean(AF_prop3_REC_PROG, na.rm = TRUE),

    AF_prop3_REC_naoPROD = mean(AF_prop3_REC_naoPROD, na.rm = TRUE) ,
    MP_prop3_REC_naoPROD = mean(MP_prop3_REC_naoPROD, na.rm = TRUE) ,
    GP_prop3_REC_naoPROD = mean(GP_prop3_REC_naoPROD, na.rm = TRUE)

  ) %>%
    mutate(Tamanho = k7_III$size)
df_clusters_k5_centers <- as.data.frame(k5[["centers"]])





# df_clusters_k9_III_sumario <- variaveis_clusterIII %>%
#   mutate(Cluster9 = k9_III$cluster) %>%
#   group_by(Cluster9) %>%
#   summarise_all("mean") %>%
#   mutate(Tamanho = k9_III$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))

# df_clusters_k9_III_centers <- as.data.frame(k9[["centers"]])

```



### 3.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r tabela sumario III, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k7_III_sumarioSCALES <- df_clusters_k7_III_sumario %>%
  mutate(
    
         AF_prop_NEstab = scales::percent(round(AF_prop_NEstab, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
         MP_prop_NEstab = scales::percent(round(MP_prop_NEstab, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         NEST_Tsum = paste(format(round(NEST_Tsum), decimal.mark=",", big.mark = "."), " estab."),
         NEST_Tmean = paste(format(round(NEST_Tmean), decimal.mark=",", big.mark = "."), " estab."),
         
         AF_prop_AREA = scales::percent(round(AF_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_AREA = scales::percent(round(MP_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         AREA_Tsum = paste(format(round(AREA_Tsum), decimal.mark=",", big.mark = "."), "ha"),
         AREA_Tmean = paste(format(round(AREA_Tmean), decimal.mark=",", big.mark = "."), "ha"),
         
         AF_VPdivAREA = paste("R$", format(round(AF_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         MP_VPdivAREA = paste("R$", format(round(MP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         GP_VPdivAREA = paste("R$", format(round(GP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         
         pct_POPrur_BF = scales::percent(round(pct_POPrur_BF, 4), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         
         AF_prop_OCU = scales::percent(round(AF_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_OCU = scales::percent(round(MP_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         O_Tsum = paste(format(round(O_Tsum), decimal.mark=",", big.mark = "."), " pessoas"),
         O_Tmean = paste(format(round(O_Tmean), decimal.mark=",", big.mark = "."), " pessoas"),

    Dif_REND_AF = scales::percent(round(Dif_REND_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE)    ,
    Dif_REND_NAF = scales::percent(round(Dif_REND_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),

    REND_OCU_AF = paste("R$",round(REND_OCU_AF), "/ ocupado") ,
    REND_OCU_MP = paste("R$",round(REND_OCU_MP), "/ ocupado")  ,
    REND_OCU_NAF = paste("R$",round(REND_OCU_NAF), "/ ocupado")  ,

    Dif_OCU_AF = scales::percent(round(Dif_OCU_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    Dif_OCU_NAF = scales::percent(round(Dif_OCU_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,

    AF_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / AF_prop_OCUarea), 2), "ha"),
    MP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / MP_prop_OCUarea), 2), "ha"),
    GP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / GP_prop_OCUarea), 2), "ha"),

    AF_prop3_REC_PROG = scales::percent(round(AF_prop3_REC_PROG, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,

    AF_prop3_REC_naoPROD = scales::percent(round(AF_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    MP_prop3_REC_naoPROD = scales::percent(round(MP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    GP_prop3_REC_naoPROD = scales::percent(round(GP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE)
  ) %>%

  relocate(REND_OCU_MP, .after = REND_OCU_AF)
    
    
# real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",")

df_clusters_k7_III_sumarioPLOT <-
  as.data.frame(t(df_clusters_k7_III_sumarioSCALES)) %>%
  rename("CL 1" = V1,
         "CL 2" = V2,
         "CL 3" = V3,
         "CL 4" = V4,
         "CL 5" = V5,
         "CL 6" = V6,
         "CL 7" = V7) %>%
  slice(-1)


df_clusters_k7_III_sumarioPLOT <- df_clusters_k7_III_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

df_clusters_k7_III_sumarioPLOT[1,1] <- "% de estab. (AF)" 
df_clusters_k7_III_sumarioPLOT[2,1] <- "% de estab. (MP)"
df_clusters_k7_III_sumarioPLOT[3,1] <- "Total de estabelecimentos no cluster"
df_clusters_k7_III_sumarioPLOT[4,1] <- "Média do total de estabelecimentos por micro"

df_clusters_k7_III_sumarioPLOT[5,1] <- "% de área (AF)"
df_clusters_k7_III_sumarioPLOT[6,1] <- "% de área (MP)"
df_clusters_k7_III_sumarioPLOT[7,1] <- "Área total em ha"
df_clusters_k7_III_sumarioPLOT[8,1] <- "Média de área em ha"

df_clusters_k7_III_sumarioPLOT[9,1] <- "VBP/ha (AF)"
df_clusters_k7_III_sumarioPLOT[10,1] <- "VBP/ha (MP)"
df_clusters_k7_III_sumarioPLOT[11,1] <- "VBP/ha (AP)"


df_clusters_k7_III_sumarioPLOT[12,1] <- "% da população rural beneficiária do Bolsa Família"

df_clusters_k7_III_sumarioPLOT[13,1] <- "% de ocupados (AF)"
df_clusters_k7_III_sumarioPLOT[14,1] <- "% de ocupados (MP)"
df_clusters_k7_III_sumarioPLOT[15,1] <- "Total de ocupados no cluster"
df_clusters_k7_III_sumarioPLOT[16,1] <- "Média do total de ocupados por micro"


df_clusters_k7_III_sumarioPLOT[17,1] <- "Aumento/redução % da renda (Fam.)"
df_clusters_k7_III_sumarioPLOT[18,1] <- "Aumento/redução % da renda (Patr.)"

df_clusters_k7_III_sumarioPLOT[19,1] <- "Renda por pessoa ocupada (Fam.)"
df_clusters_k7_III_sumarioPLOT[20,1] <- "Renda por pessoa ocupada (Pronamp)"
df_clusters_k7_III_sumarioPLOT[21,1] <- "Renda por pessoa ocupada (Patr.)"

df_clusters_k7_III_sumarioPLOT[22,1] <- "Aumento/redução % de ocupados (Fam.)"
df_clusters_k7_III_sumarioPLOT[23,1] <- "Aumento/redução % de ocupados (Patr.)"

df_clusters_k7_III_sumarioPLOT[24,1] <- "Pessoas ocupadas por ha (Fam.)"
df_clusters_k7_III_sumarioPLOT[25,1] <- "Pessoas ocupadas por ha (Pronamp)"
df_clusters_k7_III_sumarioPLOT[26,1] <- "Pessoas ocupadas por ha (Patr.)"


df_clusters_k7_III_sumarioPLOT[27,1] <- "% renda composta por prog. e pol. (Fam.)"
df_clusters_k7_III_sumarioPLOT[28,1] <- "% rendas não agrícolas (Fam.)"
df_clusters_k7_III_sumarioPLOT[29,1] <- "% rendas não agrícolas (Pronamp)"
df_clusters_k7_III_sumarioPLOT[30,1] <- "% rendas não agrícolas (Patr.)"

df_clusters_k7_III_sumarioPLOT[31,1] <- "Nº total de microrregiões"



kbl(df_clusters_k7_III_sumarioPLOT, digits = 2, 
    caption = "", align = "lcccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Estabelecimentos", 1, 4) %>%
  pack_rows("Área", 5, 8) %>%
  pack_rows("VBP", 9, 11) %>%
  pack_rows("Assistência social", 12, 12) %>%
  pack_rows("Pessoal ocupado", 13, 16) %>%
  
  pack_rows("Evolução da renda", 17, 18) %>%
  pack_rows("Renda pelo trabalho", 19, 21) %>%
  pack_rows("Evolução do pessoal ocupado", 22, 23) %>%
  pack_rows("Pessoal ocupado por ha útil", 24, 26) %>%
  pack_rows("Rendas de programas sociais", 27, 27) %>%
  pack_rows("Rendas produtivas não agrícolas", 28, 30)


```



### 3.3. Descrição dos clusters


* Cluster 1 

O primeiro cluster tem forte presença em área da AF (em média 43%). Com valor bruto da produção 3x maior do que o da patronal nessa região, a agricultura familiar também é predominante no tema de pessoal ocupado, apesar de ter tido redução nessa variável de 2006 para 2017. 


* Cluster 2 

O Cluster 2 tem baixíssima presença em área da agricultura familiar, sendo composto majoritariamente por estabelecimentos de beneficiários do Pronamp, ocupando uma área de 79% dos estabelecimentos. Apesar da menor presença da AF, ela é cerca de 2,1x mais eficiênte na produção (na utilização do espaço útil) do que a patronal


* Cluster 3 

No terceiro cluster ocorre a segunda menor procentagem de área da agricultura familiar (83% da patronal), com média de 50% de área do Pronamp. Apesar da baixa expressão da AF em área, com VBP/ha útil 3,8x maior na nela do que na patronal, a AF se mostra mais eficiente na produção em termos de utilização da área. 
Esse cluster é o único que, na média, não predominam pessoas ocupadas na AF, possuindo a renda por pessoa ocupada mais alta dentre os demais clusters da mesma tipologia (familiar). Em conjunto à renda mais alta dentre os estabelecimentos familiares, esse cluster também é o que possuía a menor porcentagem de população rural beneficiária do Bolsa Família (2%).


* Cluster 4 

O cluster 4 tem, em média, a segunda maior porcentagem em área da agricultura familiar. Talvez pelo fato do VBP/ha ser bastante baixo em comparação aos demais, essa tipologia seja a com maior porcentagem de beneficiários do bolsa família (11,15%). Mesmo sendo o único no qual a renda da agricultura familiar diminuiu de 2006 para 2017, os rendimentos não produtivos familiares ficam na mesma média que os demais clusters; já para os beneficiários do Pronamp e dos estabelecimentos patronais, esse valor é o mais alto dentre todos os clusters, com respectivamente 40% e 35% da renda sendo composta por rendas não agrícolas. 
Tendo tido a maior redução de pessoal ocupado no período analisado (20% na AF), houve um aumento de 40% no número de ocupados nos estabelecimentos patronais. 


* Cluster 5 

O cluster 5 é muito similar ao cluster que já vinha aparecendo em analises anteriores como o cluster de alta produtividade e rentabilidade da agricultura familiar. Com presença forte em área da AF (47%), o valor da produção por área dessa tipologia foi 5,06x maior que o da patronal, contando também com em média 3x mais pessoas ocupadas na AF do que na AP. 
Apesar do cluster 2 deter a posição mais alta na evolução da renda da agricultura familiar, o cluster 5 teve um aumento de 28% nessa categoria e um aumento de 75% na categoria patronal.  Com alta renda por pessoal ocupado tanto na AF quanto na AP (em média 3,4x mais alto na patronal), esse cluster apresenta a segunda menor porcentagem de população rural beneficiária do bolsa família (2,2%).


* Cluster 6 

O sexto cluster, localizado em sua maior parte na região Centro-Oeste e na porção sul do Norte é o que possui menor quantidade de pessoas ocupadas por hectare, tanto na agricultura patronal quanto na familiar. Com forte presença da agricultura não familiar (85% em média) e predominância de em média 56% de estabelecimentos baneficiários do Pronamp, apesar de um imenso aumento da renda tanto familiar quanto patronal de 2006 para 2017, o valor da produção por ha/útil não tem o segundo valor mais baixo para a AF e um valor bastante mediano para a AP, podendo indicar que apesar de extremamente rentável, as microrregiões pertencentes ao cluster não possuem grande eficiência na produção.


* Cluster 7 

O cluster 7, que na primeira análise havia ficado junto às microrregiões do cluster 5, vem separado nesta clusterização, revelando uma importante diferença com relação ao cluster predominante espacialmente na região: diferentemente do cluster 1, o cluster 7 possui um altíssimo valor da produção por área útil na AF, além de ter uma alta porcentagem da renda dos estabelecimentos da AF composta por recebimentos de programas e políticas (12% da renda).  
Nesse cluster, o que é mais relevante destacar é que, apesar de um gigantesco aumento na renda patronal de 2006 para 2017, do grande aumento no número de ocupados em estabelecimentos patronais, os valores da renda por pessoa ocupada permaneceram os mais baixos dentre todos os clusters (exceto para a AF do cluster 1), com um valor baixíssimo de pessoas ocupadas por hectare útil.



### 3.4. Representação espacial dos clusters
```{r CODmapas PREPARACAO III, message=FALSE, warning=FALSE, include=FALSE}

# SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
# SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
# st_crs(SHP_Microrregioes)
# tmap_mode("view")
# # tmap_mode("plot") #> tmap mode set to plotting
# # Mudando o nome pra ficar igual ao da tabela
# names(SHP_Microrregioes)[1] <- "COD"
# 

# Juntando o shape e a tabela
SHP_clusters_III <- SHP_Microrregioes %>%
  left_join(., df_clusters_III, by = "COD")



# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```


```{r Mapeando os clusters III, echo=FALSE, message=FALSE, warning=FALSE}
# 
# SHP_clusters_III %>%
#   tm_shape() +
#   tm_fill(col = "Cluster4",
#           title = "Clusters (n=4)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

# SHP_clusters_III %>%
#   tm_shape() +
#   tm_fill(col = "Cluster5",
#           title = "Clusters (n=5)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)
# # 
# ### CLUSTER 6
# SHP_clusters_III %>%
#   filter(!is.na(Cluster6)) %>%
#   tm_shape() +
#   tm_fill(col = "Cluster6",
#           title = "Clusters",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

### CLUSTER 7
SHP_clusters_III %>%
  filter(!is.na(Cluster7)) %>%
  tm_shape() +
  tm_fill(col = "Cluster7",
          title = "Clusters",
          id = "LOCALIZACAO", palette="Accent",
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1)

# ### CLUSTER 9
# SHP_clusters_III %>%
#   tm_shape() +
#   tm_fill(col = "Cluster9",
#           title = "Clusters (n=9)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

```


### 3.5. Tabela descritiva

Sumário com médias, medianas, mínimos e máximos das microrregiões para cada uma das variáveis utilizadas


```{r Tabela de resumo III, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

options(qwraps2_markup = 'markdown')
our_summary_III <-
  list("Proporção de estabelecimentos AF" =
       list("min"       = ~ scales::percent(round(min(AF_prop_NEstab), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop_NEstab), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop_NEstab), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop_NEstab), 2))),
       "Proporção de estabelecimentos MP" =
       list("min"       = ~ scales::percent(round(min(MP_prop_NEstab), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop_NEstab), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop_NEstab), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop_NEstab), 2))),
       "Estabelecimentos nas micro" =
       list("min"       = ~ paste(round(min(NEST_T), 2), " estab."),
            "Mediana"    = ~ paste(round(median(NEST_T), 2), " estab."),
            "max"       = ~ paste(round(max(NEST_T), 2), " estab."),
            "Média"      = ~ paste(round(mean(NEST_T), 2), " estab.")),
       
       
       "Proporção de área AF" =
       list("min"       = ~ scales::percent(round(min(AF_prop_AREA), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop_AREA), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop_AREA), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop_AREA), 2))),
       "Proporção de área MP" =
       list("min"       = ~ scales::percent(round(min(MP_prop_AREA), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop_AREA), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop_AREA), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop_AREA), 2))),
       "Área total dos estab. nas micro" =
       list("min"       = ~ paste(round(min(AREA_T), 2), " ha"),
            "Mediana"    = ~ paste(round(median(AREA_T), 2), " ha"),
            "max"       = ~ paste(round(max(AREA_T), 2), " ha"),
            "Média"      = ~ paste(round(mean(AREA_T), 2), " ha")),
       
       
       "VP/ha da AF" =
       list("min"       = ~ paste("R$", round(min(AF_VPdivAREA)), "/ha"),
            "Mediana"    = ~ paste("R$", round(median(AF_VPdivAREA)), "/ha"),
            "max"       = ~ paste("R$", round(max(AF_VPdivAREA)), "/ha"),
            "Média"      = ~ paste("R$", round(mean(AF_VPdivAREA)), "/ha")),
       "VP/ha do MP" =
       list("min"       = ~ paste("R$", round(min(MP_VPdivAREA)), "/ha"),
            "Mediana"    = ~ paste("R$", round(median(MP_VPdivAREA)), "/ha"),
            "max"       = ~ paste("R$", round(max(MP_VPdivAREA)), "/ha"),
            "Média"      = ~ paste("R$", round(mean(MP_VPdivAREA)), "/ha")),
       "VP/ha da AP" =
       list("min"       = ~ paste("R$", round(min(GP_VPdivAREA)), "/ha"),
            "Mediana"    = ~ paste("R$", round(median(GP_VPdivAREA)), "/ha"),
            "max"       = ~ paste("R$", round(max(GP_VPdivAREA)), "/ha"),
            "Média"      = ~ paste("R$", round(mean(GP_VPdivAREA)), "/ha")),
       
       
       "Assistência social - % de beneficiários do Bolsa Familia (áreas rurais)" =
       list("min"       = ~ scales::percent(round(min(pct_POPrur_BF), 2)),
            "Mediana"    = ~ scales::percent(round(median(pct_POPrur_BF), 2)),
            "max"       = ~ scales::percent(round(max(pct_POPrur_BF), 2)),
            "Média"      = ~ scales::percent(round(mean(pct_POPrur_BF), 2))),
       
       
       "Proporção de ocupados na AF" =
       list("min"       = ~ scales::percent(round(min(AF_prop_OCU), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop_OCU), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop_OCU), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop_OCU), 2))),
       "Proporção de ocupados na MP" =
       list("min"       = ~ scales::percent(round(min(MP_prop_OCU), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop_OCU), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop_OCU), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop_OCU), 2))),
       "Total de ocupados nas micro" =
       list("min"       = ~ paste(round(min(O_T), 2), "pessoas"),
            "Mediana"    = ~ paste(round(median(O_T), 2), "pessoas"),
            "max"       = ~ paste(round(max(O_T), 2), "pessoas"),
            "Média"      = ~ paste(round(mean(O_T), 2), "pessoas")),
       
       ## segunda parte
       
       "Evolução da renda - Agricultura familiar" =
       list("min"       = ~ scales::percent(round(min(Dif_REND_AF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_REND_AF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_REND_AF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_REND_AF), 2))),
       "Evolução da renda - Agricultura patronal" =
       list("min"       = ~ scales::percent(round(min(Dif_REND_NAF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_REND_NAF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_REND_NAF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_REND_NAF), 2))),
       
       "Renda por trabalhador - Agricultura familiar" =
       list("min"       = ~ paste("R$", round(min(REND_OCU_AF), 2), "/ocupado"),
            "Mediana"    = ~ paste("R$", round(median(REND_OCU_AF), 2), "/ocupado"),
            "max"       = ~ paste("R$", round(max(REND_OCU_AF), 2), "/ocupado"),
            "Média"      = ~ paste("R$", round(mean(REND_OCU_AF), 2), "/ocupado")),
       "Renda por trabalhador - Pronamp" =
       list("min"       = ~ paste("R$", round(min(REND_OCU_MP), 2), "/ocupado"),
            "Mediana"    = ~ paste("R$", round(median(REND_OCU_MP), 2), "/ocupado"),
            "max"       = ~ paste("R$", round(max(REND_OCU_MP), 2), "/ocupado"),
            "Média"      = ~ paste("R$", round(mean(REND_OCU_MP), 2), "/ocupado")),
       "Renda por trabalhador - Agricultura patronal" =
       list("min"       = ~ paste("R$", round(min(REND_OCU_NAF), 2), "/ocupado"),
            "Mediana"    = ~ paste("R$", round(median(REND_OCU_NAF), 2), "/ocupado"),
            "max"       = ~ paste("R$", round(max(REND_OCU_NAF), 2), "/ocupado"),
            "Média"      = ~ paste("R$", round(mean(REND_OCU_NAF), 2), "/ocupado")),
       
       "Evolução do pessoal ocupado - Agricultura familiar" =
       list("min"       = ~ scales::percent(round(min(Dif_OCU_AF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_OCU_AF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_OCU_AF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_OCU_AF), 2))),
       "Evolução do pessoal ocupado - Agricultura patronal" =
       list("min"       = ~ scales::percent(round(min(Dif_OCU_NAF), 2)),
            "Mediana"    = ~ scales::percent(round(median(Dif_OCU_NAF), 2)),
            "max"       = ~ scales::percent(round(max(Dif_OCU_NAF), 2)),
            "Média"      = ~ scales::percent(round(mean(Dif_OCU_NAF), 2))),
       
       
       "Pessoal ocupado por ha útil - Agricultura familiar" =
       list("min"       = ~ paste("1 pessoa ocup. a cada", round(min(AF_prop_OCUarea), 2), "ha"),
            "Mediana"    = ~ paste("1 pessoa ocup. a cada", round(median(AF_prop_OCUarea), 2), " ha"),
            "max"       = ~ paste("1 pessoa ocup. a cada", round(max(AF_prop_OCUarea), 2), " ha"),
            "Média"      = ~ paste("1 pessoa ocup. a cada", round(mean(AF_prop_OCUarea), 2), " ha")),
       "Pessoal ocupado por ha útil - Pronamp" =
       list("min"       = ~ paste("1 pessoa ocup. a cada", round(min(MP_prop_OCUarea), 2), "ha"),
            "Mediana"    = ~ paste("1 pessoa ocup. a cada", round(median(MP_prop_OCUarea), 2), " ha"),
            "max"       = ~ paste("1 pessoa ocup. a cada", round(max(MP_prop_OCUarea), 2), " ha"),
            "Média"      = ~ paste("1 pessoa ocup. a cada", round(mean(MP_prop_OCUarea), 2), " ha")),
       "Pessoal ocupado por ha útil - Agricultura patronal" =
       list("min"       = ~ paste("1 pessoa ocup. a cada", round(min(GP_prop_OCUarea), 2), "ha"),
            "Mediana"    = ~ paste("1 pessoa ocup. a cada", round(median(GP_prop_OCUarea), 2), " ha"),
            "max"       = ~ paste("1 pessoa ocup. a cada", round(max(GP_prop_OCUarea), 2), " ha"),
            "Média"      = ~ paste("1 pessoa ocup. a cada", round(mean(GP_prop_OCUarea), 2), " ha")),
       
       "Assistência social - % da renda composta por programas e políticas" =
       list("min"       = ~ scales::percent(round(min(AF_prop3_REC_PROG), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop3_REC_PROG), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop3_REC_PROG), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop3_REC_PROG), 2))),
       
       "% das rendas não agrícolas na composição da renda - Agricultura familiar" =
       list("min"       = ~ scales::percent(round(min(AF_prop3_REC_naoPROD), 2)),
            "Mediana"    = ~ scales::percent(round(median(AF_prop3_REC_naoPROD), 2)),
            "max"       = ~ scales::percent(round(max(AF_prop3_REC_naoPROD), 2)),
            "Média"      = ~ scales::percent(round(mean(AF_prop3_REC_naoPROD), 2))),
       "% das rendas não agrícolas na composição da renda - Pronamp" =
       list("min"       = ~ scales::percent(round(min(MP_prop3_REC_naoPROD), 2)),
            "Mediana"    = ~ scales::percent(round(median(MP_prop3_REC_naoPROD), 2)),
            "max"       = ~ scales::percent(round(max(MP_prop3_REC_naoPROD), 2)),
            "Média"      = ~ scales::percent(round(mean(MP_prop3_REC_naoPROD), 2))),
       "% das rendas não agrícolas na composição da renda - Agricultura patronal" =
       list("min"       = ~ scales::percent(round(min(GP_prop3_REC_naoPROD), 2)),
            "Mediana"    = ~ scales::percent(round(median(GP_prop3_REC_naoPROD), 2)),
            "max"       = ~ scales::percent(round(max(GP_prop3_REC_naoPROD), 2)),
            "Média"      = ~ scales::percent(round(mean(GP_prop3_REC_naoPROD), 2)))
       
  )
  
  
  


tabelaresumo1_III <- qwraps2::summary_table(df_clusters_III, our_summary_III)


tabelaresumo2_III <- qwraps2::summary_table(dplyr::group_by(df_clusters_III, Cluster7), our_summary_III)
print(tabelaresumo2_III, rtitle = "Clusters")


# 
# 
# kbl(df_clusters_k7_III_sumarioPLOT, digits = 2, 
#     caption = "", 
#     format.args = list(decimal.mark = ',', big.mark = ".")) %>%
#   kable_paper("basic", full_width = F) %>%
#   pack_rows("Estabelecimentos", 1, 12) %>%
#   pack_rows("Área", 13, 25) %>%
#   pack_rows("VBP", 26, 38) %>%
#   pack_rows("Assistência social", 39, 43)
#   pack_rows("Pessoal ocupado", 11, 13) %>%
#   
#   pack_rows("Evolução da renda", 14, 15) %>%
#   pack_rows("Renda pelo trabalho", 16, 18) %>%
#   pack_rows("Evolução do pessoal ocupado", 19, 20) %>%
#   pack_rows("Pessoal ocupado por ha útil", 21, 23) %>%
#   pack_rows("Rendas de programas sociais", 24, 24) %>%
#   pack_rows("Rendas produtivas não agrícolas", 25, 27)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# kbl(tabelaresumo2_III, digits = 2, caption = "", align = "lcccccc",
#     format.args = list(decimal.mark = ',', big.mark = ".")) %>%
#   kable_paper("basic", full_width = F) %>%
# 
#   pack_rows("Estabelecimentos", 1, 12) %>%
#   pack_rows("Área", 13, 25) %>%
#   pack_rows("VBP", 26, 38) %>%
#   pack_rows("Assistência social", 39, 43)
  # pack_rows("Pessoal ocupado", 11, 13) %>%
  # 
  # pack_rows("Evolução da renda", 14, 15) %>%
  # pack_rows("Renda pelo trabalho", 16, 18) %>%
  # pack_rows("Evolução do pessoal ocupado", 19, 20) %>%
  # pack_rows("Pessoal ocupado por ha útil", 21, 23) %>%
  # pack_rows("Rendas de programas sociais", 24, 24) %>%
  # pack_rows("Rendas produtivas não agrícolas", 25, 27)
```

# Adicional - Grupo I

Rodar o cluster 1 sem os indicadores de “total de ocupados na micro”, “área total na micro”, “total de estabelecimentos na micro”


**I - Sobre quem são os produtores**

*Variáveis:*

* Presença 
  + Proporção número de estabelecimentos da AF na microrregião em 2017; 
  + Proporção número de estabelecimentos do Pronamp na microrregião em 2017; 
  + Proporção número de estabelecimentos da AP na microrregião em 2017;  
  + [REMOVIDO] Total de estabelecimentos;  
  + Proporção da área de estabelecimentos AF no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos do Pronamp no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos da AP no total da microrregião em 2017; 
  + [REMOVIDO] Total de área. 

* Produtividade 
  + VBP da AF por hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP dos Médios/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP AP/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017. 

* Situação de pobreza
  + Porcentagem da população rural beneficiária do Programa Bolsa Família em 2017. 

* Pessoal ocupado
  + Proporção do pessoal ocupado da microrregião na AF em 2017; 
  + Proporção do pessoal ocupado da microrregião no Pronamp em 2017;  
  + Proporção do pessoal ocupado da microrregião na AP em 2017;  
  + [REMOVIDO] Pessoas ocupadas. 
  

```{r bCriando a tabela Cluster I, message=FALSE, warning=FALSE, include=FALSE}

variaveis_clusterI <- microrregioes_CLI %>%
  filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>%
  select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO,
         AF_prop_NEstab, MP_prop_NEstab, GP_prop_NEstab, 
         AF_prop_AREA, MP_prop_AREA, GP_prop_AREA, 
         AF_VPdivAREA, MP_VPdivAREA, GP_VPdivAREA, 
         pct_POPrur_BF, 
         AF_prop_OCU, MP_prop_OCU, GP_prop_OCU) 

```



```{r bNormalizando variaveis I, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
variaveis_clusterI[is.na(variaveis_clusterI)] <- 0

# Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização
variaveis_clusterI_2 <- variaveis_clusterI %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame()


variaveis_clusterI_3 <- variaveis_clusterI_2 %>%
  select(5:17) %>%
  rename(
    "Estab. - % de estab. (AF)" = AF_prop_NEstab,
    "Estab. - % de estab. (MP)" = MP_prop_NEstab,
    "Estab. - % de estab. (AP)" = GP_prop_NEstab,

    "Área - % de área (AF)" = AF_prop_AREA,
    "Área - % de área (MP)" = MP_prop_AREA,
    "Área - % de área (AP)" = GP_prop_AREA,

    "VBP - VBP/ha (AF)" = AF_VPdivAREA,
    "VBP - VBP/ha (MP)" = MP_VPdivAREA,
    "VBP - VBP/ha (AP)" = GP_VPdivAREA,

    "Bolsa Família - % pop. rural c/ BF" = pct_POPrur_BF,

    "Ocup. - % de ocupados (AF)" = AF_prop_OCU,
    "Ocup. - % de ocupados (MP)" = MP_prop_OCU,
    "Ocup. - % de ocupados (AP)" = GP_prop_OCU)


# Padronização das escalas
clusterizacaoI_scale <- scale(variaveis_clusterI_3[,-c(1:4)])

```


### 1.1. Número ideal de clusters

Após a normalização dos valores (com desvio padrão de 1 e média 0), uma vez que é necessário indicar previamente um número de clusters para iniciar o procedimento de clusterização das variáveis, foram verificados inicialmente três métodos diferentes para determinar o número ideal de clusters, sendo eles:
1. Método do cotovelo (Elbow method)
2. Método de silhueta (Average Silhouette Method) 
3. Método Gap (Gap Statistic Method)


```{r bTestes de tamanho de cluster I, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3}

clusterizacaoI_scale <- variaveis_clusterI_2 %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU"))

clusterizacaoI_scale <- scale(clusterizacaoI_scale[,-c(1:4)])


# Elbow method
CLIDEAL_elbow <- fviz_nbclust(clusterizacaoI_scale, kmeans, method = "wss") +
    geom_vline(xintercept = 5, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
CLIDEAL_silhou <- fviz_nbclust(clusterizacaoI_scale, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
CLIDEAL_gap <- fviz_nbclust(clusterizacaoI_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")

ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5)
```

Novamente aqui, as três análises sugeriram números ideias de clusters distintos entre si. Portanto, optou-se novamente pela alternativa a partir dos 30 índices diferentes.

```{r bbteste numero clusters I, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
nbclust_out <- NbClust::NbClust(
  data = clusterizacaoI_scale,
  distance = "euclidean",
  min.nc = 4, # minimum number of clusters
  max.nc = 8, # maximum number of clusters
  method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans"
)

# # create a dataframe of the optimal number of clusters
# nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ])
# # select only indices which select between 2 and 5 clusters
# nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5)
# 
# # create plot
# ggplot(nbclust_plot) +
#   aes(x = clusters) +
#   geom_histogram(bins = 30L, fill = "#0c4c8a") +
#   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") +
#   theme_minimal()

```


Com as três variáveis que foram retiradas o número aconselhado de clusters ainda permanece como sendo, na maioria dos testes, 5 clusters. 

* 7 testes indicaram 4 como o número ideal de clusters 
* 9 testes indicaram 5 como o número ideal de clusters 
* 1 testes indicaram 6 como o número ideal de clusters 
* 5 testes indicaram 7 como o número ideal de clusters 
* 1 testes indicaram 8 como o número ideal de clusters 

Portanto, de acordo com a maioria, o melhor número de clusters, nesse caso, é 5.


```{r bCriacao dos clusters I, message=FALSE, warning=FALSE, include=FALSE}

#CLUSTERs
set.seed(123)
k4 <- kmeans(clusterizacaoI_scale, centers = 4, nstart = 150)
k5 <- kmeans(clusterizacaoI_scale, centers = 5, nstart = 150)
k6 <- kmeans(clusterizacaoI_scale, centers = 6, nstart = 150)
k7 <- kmeans(clusterizacaoI_scale, centers = 7, nstart = 150)
k8 <- kmeans(clusterizacaoI_scale, centers = 8, nstart = 150)
k9 <- kmeans(clusterizacaoI_scale, centers = 9, nstart = 150)
#print(k4)

k4graph <- fviz_cluster(k4, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 4")
k5graph <- fviz_cluster(k5, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 5")
k6graph <- fviz_cluster(k6, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 6")
k9graph <- fviz_cluster(k9, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 9")

# Visualize silhouhette information
# library(cluster)
# #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale))
# teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale)))

```



```{r bManipulacao tabelas clusters I, message=FALSE, warning=FALSE, include=FALSE}

df_clusters <- variaveis_clusterI %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
  mutate(Cluster4 = k4$cluster,
         Cluster5 = k5$cluster,
         Cluster6 = k6$cluster,
         Cluster7 = k7$cluster,
         Cluster9 = k9$cluster) 
  


# df_clusters_k4_sumario <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster4 = k4$cluster) %>%
#   group_by(Cluster4) %>%
#   summarise_all("mean") %>% 
#   mutate(Tamanho = k4$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k4_centers <- as.data.frame(k4[["centers"]])


df_clusters_k5_sumario <- variaveis_clusterI %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
  mutate(Cluster5 = k5$cluster) %>%
  group_by(Cluster5) %>%
  summarise(
    AF_prop_NEstab = mean(AF_prop_NEstab, na.rm = TRUE),
    MP_prop_NEstab = mean(MP_prop_NEstab, na.rm = TRUE),
    #NEST_Tsum = sum(NEST_T, na.rm = TRUE)  ,
    #NEST_Tmean = mean(NEST_T, na.rm = TRUE)  ,
    AF_prop_AREA = mean(AF_prop_AREA, na.rm = TRUE),
    MP_prop_AREA = mean(MP_prop_AREA, na.rm = TRUE),
    #AREA_Tsum  = sum(AREA_T, na.rm = TRUE)  ,
    #AREA_Tmean  = mean(AREA_T, na.rm = TRUE)  ,
    AF_VPdivAREA = mean(AF_VPdivAREA, na.rm = TRUE),
    MP_VPdivAREA = mean(MP_VPdivAREA, na.rm = TRUE),
    GP_VPdivAREA = mean(GP_VPdivAREA, na.rm = TRUE),
    pct_POPrur_BF = mean(pct_POPrur_BF, na.rm = TRUE),
    AF_prop_OCU = mean(AF_prop_OCU, na.rm = TRUE),
    MP_prop_OCU = mean(MP_prop_OCU, na.rm = TRUE)
   # O_Tsum = sum(O_T, na.rm = TRUE),
  #  O_Tmean = mean(O_T, na.rm = TRUE)
  ) %>%
  # summarise_all("mean") %>% 
  mutate(Tamanho = k5$size) #%>%
  # select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k5_centers <- as.data.frame(k5[["centers"]])



```




### 1.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r btabela sumario I, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k5_sumarioSCALES <- df_clusters_k5_sumario %>%
  mutate(AF_prop_NEstab = scales::percent(round(AF_prop_NEstab, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
         MP_prop_NEstab = scales::percent(round(MP_prop_NEstab, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         # NEST_Tsum = paste(format(round(NEST_Tsum), decimal.mark=",", big.mark = "."), " estab."),
         # NEST_Tmean = paste(format(round(NEST_Tmean), decimal.mark=",", big.mark = "."), " estab."),
         
         AF_prop_AREA = scales::percent(round(AF_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_AREA = scales::percent(round(MP_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         # AREA_Tsum = paste(format(round(AREA_Tsum), decimal.mark=",", big.mark = "."), "ha"),
         # AREA_Tmean = paste(format(round(AREA_Tmean), decimal.mark=",", big.mark = "."), "ha"),
         
         AF_VPdivAREA = paste("R$", format(round(AF_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         MP_VPdivAREA = paste("R$", format(round(MP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         GP_VPdivAREA = paste("R$", format(round(GP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         
         pct_POPrur_BF = scales::percent(round(pct_POPrur_BF, 4), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         
         AF_prop_OCU = scales::percent(round(AF_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_OCU = scales::percent(round(MP_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE)
         # O_Tsum = paste(format(round(O_Tsum), decimal.mark=",", big.mark = "."), " pessoas"),
         # O_Tmean = paste(format(round(O_Tmean), decimal.mark=",", big.mark = "."), " pessoas")
        )

# real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",")

df_clusters_k5_sumarioPLOT <-
  as.data.frame(t(df_clusters_k5_sumarioSCALES)) %>%
  rename("CL 1" = 1,
         "CL 2" = 2,
         "CL 3" = 3,
         "CL 4" = 4,
         "CL 5" = 5) %>%
  slice(-1)


# mutate("Origem da renda" = (recode(names,
#                 "AF_prod" = "Produção do estabelecimento",
#                 "MP_prod" = "Produção do estabelecimento",
#                 "GP_prod" = "Produção do estabelecimento",
#                 "AF_fora" = "Fora do estabelecimento",
#                 "MP_fora" = "Fora do estabelecimento",
#                 "GP_fora" = "Fora do estabelecimento",
#                 "AF_outr" = "Outras do estabelecimento",
#                 "MP_outr" = "Outras do estabelecimento",
#                 "GP_outr" = "Outras do estabelecimento",
#                 "AF_prog" = "Programas e políticas",
#                 "MP_prog" = "Programas e políticas",
#                 "GP_prog" = "Programas e políticas"))) %>%
#   mutate(TIPOLOGIA = recode(TIPOLOGIA, 
#          "AF" = "Agricultura familiar",
#          "MP" = "Pronamp",
#          "GP" = "Agricultura patronal*")) %>%
#   select(-names) %>%
#   dplyr::relocate("Origem da renda", .after = TIPOLOGIA) %>%
#   arrange(desc(TIPOLOGIA))  %>%
#   rename(Tipologia = TIPOLOGIA)




df_clusters_k5_sumarioPLOT <- df_clusters_k5_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

df_clusters_k5_sumarioPLOT[1,1] <- "% de estab. (AF)" 
df_clusters_k5_sumarioPLOT[2,1] <- "% de estab. (MP)"
# df_clusters_k5_sumarioPLOT[3,1] <- "Total de estabelecimentos no cluster"
# df_clusters_k5_sumarioPLOT[4,1] <- "Média do total de estabelecimentos por micro"

df_clusters_k5_sumarioPLOT[3,1] <- "% de área (AF)"
df_clusters_k5_sumarioPLOT[4,1] <- "% de área (MP)"
# df_clusters_k5_sumarioPLOT[7,1] <- "Área total em ha"
# df_clusters_k5_sumarioPLOT[8,1] <- "Média de área em ha"

df_clusters_k5_sumarioPLOT[5,1] <- "VBP/ha (AF)"
df_clusters_k5_sumarioPLOT[6,1] <- "VBP/ha (MP)"
df_clusters_k5_sumarioPLOT[7,1] <- "VBP/ha (AP)"


df_clusters_k5_sumarioPLOT[8,1] <- "% da população rural beneficiária do Bolsa Família"

df_clusters_k5_sumarioPLOT[9,1] <- "% de ocupados (AF)"
df_clusters_k5_sumarioPLOT[10,1] <- "% de ocupados (MP)"
# df_clusters_k5_sumarioPLOT[15,1] <- "Total de ocupados no cluster"
# df_clusters_k5_sumarioPLOT[16,1] <- "Média do total de ocupados por micro"

df_clusters_k5_sumarioPLOT[11,1] <- "Nº total de microrregiões"



kbl(df_clusters_k5_sumarioPLOT, digits = 2, 
    caption = "", align = "lccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Estabelecimentos", 1, 2) %>%
  pack_rows("Área", 3, 4) %>%
  pack_rows("VBP", 5, 7) %>%
  pack_rows("Assistência social", 8, 8) %>%
  pack_rows("Pessoal ocupado", 9, 10)

```


### 1.4. Representação espacial dos clusters

```{r bCODmapas PREPARACAO I, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}

SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
st_crs(SHP_Microrregioes)
tmap_mode("view")
# tmap_mode("plot") #> tmap mode set to plotting
# Mudando o nome pra ficar igual ao da tabela
names(SHP_Microrregioes)[1] <- "COD"


df_clusters <- df_clusters %>%
  mutate(
    Cluster5 = case_when(Cluster5 == 1 ~ 5,
                         Cluster5 == 5 ~ 1,
                         TRUE ~ as.numeric(Cluster5))
  )
   

# Juntando o shape e a tabela
SHP_clusters <- SHP_Microrregioes %>%
  left_join(., df_clusters, by = "COD")




# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```

<br>



```{r bMapeando os clusters I, echo=FALSE, message=FALSE, warning=FALSE}

SHP_clusters %>%
  filter(!is.na(Cluster5)) %>%

  tm_shape() +
  tm_fill(col = "Cluster5", 
          title = "Clusters (n=5)", 
          id = "LOCALIZACAO", palette="Accent",
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1)

```

É possível notar que nessa clusterização, excluindo as variáveis de totais de ocupados, área e estabelecimentos, há uma redução drástica no cluster 3 que o deixa praticamente insignificante para a análise, ele passa de 69 para 2 microrregiões apenas. As demais microrregiões que fazia parte do cluster 3 passam a fazer parte do cluster 1 ou 2.

<br> 
<br>
<br>


# Adicional - Grupo II

Rodar o cluster 2 sem os indicadores pessoal ocupado por ha útil

**II - Sobre desempenho em IPR**

*Variáveis:*

* Evolução da renda 
  + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AF na microrregião 2006-2017.
  + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AP na microrregião 2006-2017. 

* Renda pelo trabalho
  + Renda da AF por trabalhador ocupado na microrregião em 2017. 
  + Renda dos beneficiários do Pronamp por trabalhador ocupado na microrregião em 2017.  
  + Renda da AP por trabalhador ocupado na microrregião em 2017. 

* Evolução pessoal ocupado 
  + Aumento ou redução do pessoal ocupado na AF 2006-2017. 
  + Aumento ou redução do pessoal ocupado na AP 2006-2017. 

* Pessoal ocupado
  + **[REMOVIDO]** Número de trabalhadores ocupados por hectare na AF da microrregião em 2017. 
  + **[REMOVIDO]** Número de trabalhadores ocupados por hectare nos beneficiários do Pronamp da microrregião em 2017. 
  + **[REMOVIDO]** Número de trabalhadores ocupados por hectare na AP da microrregião em 2017. 

* Rendas de programas sociais
  + Proporção da renda dos estabelecimentos da agricultura familiar composta por programas e políticas para AF em 2017. 

* Rendas produtivas não agrícolas
  + Proporção da renda dos estabelecimentos da AF com outras receitas ou fora do estabelecimento em 2017.
  + Proporção da renda dos estabelecimentos do Pronamp com outras receitas ou fora do estabelecimento em 2017.
  + Proporção da renda dos estabelecimentos da AP com outras receitas ou fora do estabelecimento em 2017. 




```{r cCriando a tabela Cluster II, message=FALSE, warning=FALSE, include=FALSE}

variaveis_clusterII <- microrregioes_CLI %>%
  filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>%
  mutate(AF_prop3_REC_naoPROD = (R_VALOR_AF_2 + R_VALOR_AF_302) / R_VALOR_AF_TOT ,
         MP_prop3_REC_naoPROD = (R_VALOR_MP_2 + R_VALOR_MP_302) / R_VALOR_MP_TOT ,
         GP_prop3_REC_naoPROD = ((R_VALOR_T_302 - R_VALOR_AF_302) +  (R_VALOR_T_2 - R_VALOR_AF_2))  / (R_VALOR_T_TOT - R_VALOR_AF_TOT)) %>%
  select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO,
         
         Dif_REND_AF, Dif_REND_NAF,
         REND_OCU_AF, REND_OCU_NAF, REND_OCU_MP,
         Dif_OCU_AF, Dif_OCU_NAF,
         # AF_prop_OCUarea, MP_prop_OCUarea, GP_prop_OCUarea,
         AF_prop3_REC_PROG, 
         AF_prop3_REC_naoPROD, MP_prop3_REC_naoPROD, GP_prop3_REC_naoPROD 
         ) 

```



```{r cNormalizando variaveis e correlacao II, message=FALSE, warning=FALSE, include=FALSE, out.width='100%'}
variaveis_clusterII[is.na(variaveis_clusterII)] <- 0

# Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização
variaveis_clusterII_2 <- variaveis_clusterII %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame()

variaveis_clusterII_2 <- variaveis_clusterII_2 %>%
  select(5:15) %>%
  rename(
    "Evol. renda (Fam.)" = Dif_REND_AF,
    "Evol. renda (Patr.)" = Dif_REND_NAF,

    "Renda por ocupado (Fam.)" = REND_OCU_AF,
    "Renda por ocupado (Pronamp)" = REND_OCU_MP,
    "Renda por ocupado (Patr.)" = REND_OCU_NAF,
    
    "Evol. ocupados (Fam.)" = Dif_OCU_AF ,  
    "Evol. ocupados (Patr.)" = Dif_OCU_NAF ,
# 
#     "Ocupados/ha (Fam.)" = AF_prop_OCUarea  ,
#     "Ocupados/ha (Pronamp)" = MP_prop_OCUarea  ,
#     "Ocupados/ha (Patr.)" = GP_prop_OCUarea  ,
    
    "Rendas prog. soc. (Fam.)" = AF_prop3_REC_PROG,

    "Rendas não produt. (Fam.)" = AF_prop3_REC_naoPROD ,
    "Rendas não produt. (Pronamp)" = MP_prop3_REC_naoPROD ,
    "Rendas não produt. (Patr.)" = GP_prop3_REC_naoPROD)

# Padronização das escalas
clusterizacaoII_scale <- scale(variaveis_clusterII_2)


```


#### 2.1. Número ideal de clusters


```{r cTestes de tamanho de cluster II, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3}

# Padronização das escalas
clusterizacaoII_scale <- scale(variaveis_clusterII_2)

# Elbow method
CLIDEAL_elbow <- fviz_nbclust(clusterizacaoII_scale, kmeans, method = "wss") +
    #geom_vline(xintercept = 6, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
CLIDEAL_silhou <- fviz_nbclust(clusterizacaoII_scale, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
CLIDEAL_gap <- fviz_nbclust(clusterizacaoII_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")

ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5)

```

O primeiro método não apresenta um indicativo conclusivo para o número ideal de clusters e os demais indicam como ideal números diferentes de clusters.

Como uma alternativa, foi utilizada uma função que fornece resultados de 30 índices diferentes para a escolha do melhor número de clusters.
```{r cteste numero clusters II, message=FALSE, warning=FALSE, include=FALSE}
nbclust_out <- NbClust::NbClust(
  data = clusterizacaoII_scale,
  distance = "euclidean",
  min.nc = 4, # minimum number of clusters
  max.nc = 8, # maximum number of clusters
  method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans"
)

# create a dataframe of the optimal number of clusters
# nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ])
# # select only indices which select between 2 and 5 clusters
# nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5)

# create plot
# ggplot(nbclust_plot) +
#   aes(x = clusters) +
#   geom_histogram(bins = 30L, fill = "#0c4c8a") +
#   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") +
#   theme_minimal()

```

Retirando as variáveis de pessoas ocupadas por ha útil, os resultados diferem bastante da análise com todas as variáveis:

* 7 testes indicaram 4 como o número ideal de clusters 
* 1 testes indicaram 5 como o número ideal de clusters (contra 2 no teste com todas as variáveis)
* 11 testes indicaram 6 como o número ideal de clusters (contra 11 no teste com todas as variáveis)
* 1 testes indicaram 7 como o número ideal de clusters (contra 1 no teste com todas as variáveis) 
* 3 testes indicaram 8 como o número ideal de clusters (contra 3 no teste com todas as variáveis)

Como a intenção é comparar resultados, abaixo serão encontrados dois mapas, um com o mesmo número de clusters da análise com todas as variáveis (sete) e um com o número ideal de clusters (seis).



```{r cCriacao dos clusters II, message=FALSE, warning=FALSE, include=FALSE}

#CLUSTERs
set.seed(123)
k4_II <- kmeans(clusterizacaoII_scale, centers = 4, nstart = 150)
k5_II <- kmeans(clusterizacaoII_scale, centers = 5, nstart = 150)
k6_II <- kmeans(clusterizacaoII_scale, centers = 6, nstart = 150)
k7_II <- kmeans(clusterizacaoII_scale, centers = 7, nstart = 150)
k8_II <- kmeans(clusterizacaoII_scale, centers = 8, nstart = 150)
k9_II <- kmeans(clusterizacaoII_scale, centers = 9, nstart = 150)
#print(k4)

k4graph_II <- fviz_cluster(k4_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 4")
k5graph_II <- fviz_cluster(k5_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 5")
k6graph_II <- fviz_cluster(k6_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 6")
k7graph_II <- fviz_cluster(k7_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 7")
k9graph_II <- fviz_cluster(k9_II, geom = "point",  data = clusterizacaoII_scale) + ggtitle("k = 9")

# Visualize silhouhette information
# library(cluster)
# #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale))
# teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale)))

```



```{r cManipulacao tabelas clusters II, message=FALSE, warning=FALSE, include=FALSE}

df_clusters_II <- variaveis_clusterII %>%
  mutate(Cluster4 = k4_II$cluster,
         Cluster5 = k5_II$cluster,
         Cluster6 = k6_II$cluster,
         Cluster7 = k7_II$cluster,
         Cluster9 = k9_II$cluster) 


df_clusters_k4_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster4 = k4_II$cluster) %>%
  group_by(Cluster4) %>%
  summarise_all("mean") %>% 
  mutate(Tamanho = k4_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k4_centers <- as.data.frame(k4[["centers"]])


df_clusters_k5_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster5 = k5_II$cluster) %>%
  group_by(Cluster5) %>%
  summarise_all("mean") %>% 
  mutate(Tamanho = k5_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k5_centers <- as.data.frame(k5[["centers"]])

df_clusters_k6_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster6 = k6_II$cluster) %>%
  group_by(Cluster6) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k6_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k6_centers <- as.data.frame(k6[["centers"]])

df_clusters_k7_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster7 = k7_II$cluster) %>%
  group_by(Cluster7) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k7_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k7_centers <- as.data.frame(k7[["centers"]])

df_clusters_k9_II_sumario <- variaveis_clusterII %>%
  mutate(Cluster9 = k9_II$cluster) %>%
  group_by(Cluster9) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k9_II$size) %>%
  select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))

# df_clusters_k9_II_centers <- as.data.frame(k9[["centers"]])

```

#### Com sete clusters

##### 2.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r ctabela sumario II, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k7_II_sumarioSCALES <- df_clusters_k7_II_sumario %>%
  mutate(
    
    Dif_REND_AF = scales::percent(round(Dif_REND_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE)    ,
    Dif_REND_NAF = scales::percent(round(Dif_REND_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
    
    REND_OCU_AF = paste("R$",round(REND_OCU_AF), "/ ocupado") ,
    REND_OCU_MP = paste("R$",round(REND_OCU_MP), "/ ocupado")  ,
    REND_OCU_NAF = paste("R$",round(REND_OCU_NAF), "/ ocupado")  ,
    
    Dif_OCU_AF = scales::percent(round(Dif_OCU_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,  
    Dif_OCU_NAF = scales::percent(round(Dif_OCU_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    
    # AF_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / AF_prop_OCUarea), 2), "ha"), 
    # MP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / MP_prop_OCUarea), 2), "ha"), 
    # GP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / GP_prop_OCUarea), 2), "ha"), 
    
    AF_prop3_REC_PROG = scales::percent(round(AF_prop3_REC_PROG, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    
    AF_prop3_REC_naoPROD = scales::percent(round(AF_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , 
    MP_prop3_REC_naoPROD = scales::percent(round(MP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    GP_prop3_REC_naoPROD = scales::percent(round(GP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) 
  ) %>%
  
  relocate(REND_OCU_MP, .after = REND_OCU_AF)
    
    
# real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",")

df_clusters_k7_II_sumarioPLOT <-
  as.data.frame(t(df_clusters_k7_II_sumarioSCALES)) %>%
  rename("CL 1" = V1,
         "CL 2" = V2,
         "CL 3" = V3,
         "CL 4" = V4,
         "CL 5" = V5,
         "CL 6" = V6,
         "CL 7" = V7) %>%
  slice(-1)


df_clusters_k7_II_sumarioPLOT <- df_clusters_k7_II_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

df_clusters_k7_II_sumarioPLOT[1,1] <- "Aumento/redução % da renda (Fam.)"
df_clusters_k7_II_sumarioPLOT[2,1] <- "Aumento/redução % da renda (Patr.)"

df_clusters_k7_II_sumarioPLOT[3,1] <- "Renda por pessoa ocupada (Fam.)"
df_clusters_k7_II_sumarioPLOT[4,1] <- "Renda por pessoa ocupada (Pronamp)"
df_clusters_k7_II_sumarioPLOT[5,1] <- "Renda por pessoa ocupada (Patr.)"

df_clusters_k7_II_sumarioPLOT[6,1] <- "Aumento/redução % de ocupados (Fam.)"
df_clusters_k7_II_sumarioPLOT[7,1] <- "Aumento/redução % de ocupados (Patr.)"

# df_clusters_k7_II_sumarioPLOT[8,1] <- "Pessoas ocupadas por ha (Fam.)"
# df_clusters_k7_II_sumarioPLOT[9,1] <- "Pessoas ocupadas por ha (Pronamp)"
# df_clusters_k7_II_sumarioPLOT[10,1] <- "Pessoas ocupadas por ha (Patr.)"


df_clusters_k7_II_sumarioPLOT[8,1] <- "% renda composta por prog. e pol. (Fam.)"
df_clusters_k7_II_sumarioPLOT[9,1] <- "% rendas não agrícolas (Fam.)"
df_clusters_k7_II_sumarioPLOT[10,1] <- "% rendas não agrícolas (Pronamp)"
df_clusters_k7_II_sumarioPLOT[11,1] <- "% rendas não agrícolas (Patr.)"

df_clusters_k7_II_sumarioPLOT[12,1] <- "Nº total de microrregiões"



kbl(df_clusters_k7_II_sumarioPLOT, digits = 2, 
    caption = "", align = "lccccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Evolução da renda", 1, 2) %>%
  pack_rows("Renda pelo trabalho", 3, 5) %>%
  pack_rows("Evolução do pessoal ocupado", 6, 7) %>%
  # pack_rows("Pessoal ocupado por ha útil", 8, 10) %>%
  pack_rows("Rendas de programas sociais", 8, 11)

```


##### 2.4. Representação espacial dos clusters


```{r cCODmapas PREPARACAO II, message=FALSE, warning=FALSE, include=FALSE}

# SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
# SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
# st_crs(SHP_Microrregioes)
# tmap_mode("view")
# # tmap_mode("plot") #> tmap mode set to plotting
# # Mudando o nome pra ficar igual ao da tabela
# names(SHP_Microrregioes)[1] <- "COD"
# 



df_clusters_II <- df_clusters_II %>%
  mutate(
    Cluster7 = case_when(Cluster7 == 3 ~ 1,
                         Cluster7 == 7 ~ 2,
                         Cluster7 == 2 ~ 3,
                         Cluster7 == 4 ~ 4,
                         Cluster7 == 1 ~ 5,
                         Cluster7 == 6 ~ 6,
                         Cluster7 == 5 ~ 7)
    )



# Juntando o shape e a tabela
SHP_clusters_II <- SHP_Microrregioes %>%
  left_join(., df_clusters_II, by = "COD")



# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```





```{r cMapeando os clusters II, echo=FALSE, message=FALSE, warning=FALSE}

# SHP_clusters_II %>%
#   tm_shape() +
#   tm_fill(col = "Cluster4",
#           title = "Clusters (n=4)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)
# 
# ### CLUSTER 6
# SHP_clusters_II %>%
#   filter(!is.na(Cluster6)) %>%
#   tm_shape() +
#   tm_fill(col = "Cluster6",
#           title = "Clusters",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

### CLUSTER 7
SHP_clusters_II %>%
  filter(!is.na(Cluster7)) %>%
  tm_shape() +
  tm_fill(col = "Cluster7",
          title = "Clusters",
          id = "LOCALIZACAO", palette="Accent",
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1)

# ### CLUSTER 9
# SHP_clusters_II %>%
#   tm_shape() +
#   tm_fill(col = "Cluster9",
#           title = "Clusters (n=9)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

```


No caso do segundo bloco de variáveis, retirando as informações de pessoas ocupadas por área útil dos estabelecimentos, o cluster que mais mostra diferenças é o 7. Sem as variáveis mencionadas, o cluster 7 perde grande de área na região Norte, apesar de ganhar um pouco no Mato Grosso e em algumas localidades no Sul e Sudeste (em microrregiões que anteriormente estavam no cluster 1). Além desse cluster, o 6 também é consideravelmente alterado, mas permanece com um número pequeno de microrregiões.


#### Com seis clusters

##### 2.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r cctabela sumario II, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k6_II_sumarioSCALES <- df_clusters_k6_II_sumario %>%
  mutate(
    
    Dif_REND_AF = scales::percent(round(Dif_REND_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE)    ,
    Dif_REND_NAF = scales::percent(round(Dif_REND_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
    
    REND_OCU_AF = paste("R$",round(REND_OCU_AF), "/ ocupado") ,
    REND_OCU_MP = paste("R$",round(REND_OCU_MP), "/ ocupado")  ,
    REND_OCU_NAF = paste("R$",round(REND_OCU_NAF), "/ ocupado")  ,
    
    Dif_OCU_AF = scales::percent(round(Dif_OCU_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,  
    Dif_OCU_NAF = scales::percent(round(Dif_OCU_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    
    # AF_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / AF_prop_OCUarea), 2), "ha"), 
    # MP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / MP_prop_OCUarea), 2), "ha"), 
    # GP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / GP_prop_OCUarea), 2), "ha"), 
    
    AF_prop3_REC_PROG = scales::percent(round(AF_prop3_REC_PROG, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    
    AF_prop3_REC_naoPROD = scales::percent(round(AF_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , 
    MP_prop3_REC_naoPROD = scales::percent(round(MP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) ,
    GP_prop3_REC_naoPROD = scales::percent(round(GP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) 
  ) %>%
  
  relocate(REND_OCU_MP, .after = REND_OCU_AF)
    
    
# real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",")

df_clusters_k6_II_sumarioPLOT <-
  as.data.frame(t(df_clusters_k6_II_sumarioSCALES)) %>%
  rename("CL 1" = V1,
         "CL 2" = V2,
         "CL 3" = V3,
         "CL 4" = V4,
         "CL 5" = V5,
         "CL 6" = V6) %>%
  slice(-1)


df_clusters_k6_II_sumarioPLOT <- df_clusters_k6_II_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

df_clusters_k6_II_sumarioPLOT[1,1] <- "Aumento/redução % da renda (Fam.)"
df_clusters_k6_II_sumarioPLOT[2,1] <- "Aumento/redução % da renda (Patr.)"

df_clusters_k6_II_sumarioPLOT[3,1] <- "Renda por pessoa ocupada (Fam.)"
df_clusters_k6_II_sumarioPLOT[4,1] <- "Renda por pessoa ocupada (Pronamp)"
df_clusters_k6_II_sumarioPLOT[5,1] <- "Renda por pessoa ocupada (Patr.)"

df_clusters_k6_II_sumarioPLOT[6,1] <- "Aumento/redução % de ocupados (Fam.)"
df_clusters_k6_II_sumarioPLOT[7,1] <- "Aumento/redução % de ocupados (Patr.)"

# df_clusters_k6_II_sumarioPLOT[8,1] <- "Pessoas ocupadas por ha (Fam.)"
# df_clusters_k6_II_sumarioPLOT[9,1] <- "Pessoas ocupadas por ha (Pronamp)"
# df_clusters_k6_II_sumarioPLOT[10,1] <- "Pessoas ocupadas por ha (Patr.)"


df_clusters_k6_II_sumarioPLOT[8,1] <- "% renda composta por prog. e pol. (Fam.)"
df_clusters_k6_II_sumarioPLOT[9,1] <- "% rendas não agrícolas (Fam.)"
df_clusters_k6_II_sumarioPLOT[10,1] <- "% rendas não agrícolas (Pronamp)"
df_clusters_k6_II_sumarioPLOT[11,1] <- "% rendas não agrícolas (Patr.)"

df_clusters_k6_II_sumarioPLOT[12,1] <- "Nº total de microrregiões"



kbl(df_clusters_k6_II_sumarioPLOT, digits = 2, 
    caption = "", align = "lccccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Evolução da renda", 1, 2) %>%
  pack_rows("Renda pelo trabalho", 3, 5) %>%
  pack_rows("Evolução do pessoal ocupado", 6, 7) %>%
  # pack_rows("Pessoal ocupado por ha útil", 8, 10) %>%
  pack_rows("Rendas de programas sociais", 8, 11)

```


##### 2.4. Representação espacial dos clusters


```{r ccCODmapas PREPARACAO II, message=FALSE, warning=FALSE, include=FALSE}

# SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
# SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
# st_crs(SHP_Microrregioes)
# tmap_mode("view")
# # tmap_mode("plot") #> tmap mode set to plotting
# # Mudando o nome pra ficar igual ao da tabela
# names(SHP_Microrregioes)[1] <- "COD"
# 



df_clusters_II <- df_clusters_II %>%
  mutate(
    Cluster7 = case_when(Cluster7 == 3 ~ 1,
                         Cluster7 == 7 ~ 2,
                         Cluster7 == 2 ~ 3,
                         Cluster7 == 4 ~ 4,
                         Cluster7 == 1 ~ 5,
                         Cluster7 == 6 ~ 6,
                         Cluster7 == 5 ~ 7),
    
    Cluster6 = case_when(Cluster6 ==  1 ~ 5,
                         Cluster6 ==  2 ~ 4,
                         Cluster6 ==  3 ~ 1,
                         Cluster6 ==  4 ~ 3,
                         Cluster6 ==  5 ~ 2,
                         Cluster6 ==  6 ~ 7)
    
     # Cluster7 = case_when(Cluster6 ==  7 ~ 1,
     #                      Cluster6 ==  4 ~ 2,
     #                      Cluster6 ==  5 ~ 3,
     #                      Cluster6 ==  1 ~ 4,
     #                      Cluster6 ==  3 ~ 5,
     #                      Cluster6 ==  2 ~ 6
     #                     )
     
    )



# Juntando o shape e a tabela
SHP_clusters_II <- SHP_Microrregioes %>%
  left_join(., df_clusters_II, by = "COD")



# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```





```{r ccMapeando os clusters II, echo=FALSE, message=FALSE, warning=FALSE}

### CLUSTER 6
SHP_clusters_II %>%
  filter(!is.na(Cluster6)) %>%
  tm_shape() +
  tm_fill(col = "Cluster6",
          title = "Clusters",
          id = "LOCALIZACAO", 
          palette = c("#7fc97f", #verde
            "#beaed4", #roxo
            "#fdc086", #aranja
            "#ffff99", #amarelo
            "#386cb0", #azul
            # "#f0027f", #rosa
            "#bf5b17" #marrom
),
          #palette="Accent",
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1)

# ### CLUSTER 7
# SHP_clusters_II %>%
#   filter(!is.na(Cluster7)) %>%
#   tm_shape() +
#   tm_fill(col = "Cluster7",
#           title = "Clusters",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

# ### CLUSTER 9
# SHP_clusters_II %>%
#   tm_shape() +
#   tm_fill(col = "Cluster9",
#           title = "Clusters (n=9)",
#           id = "LOCALIZACAO", palette="Accent",
#           #n=7
#           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "cat") +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1)

```

Com seis clusters a análise permanece praticamente idência a com sete clusters, com a diferença de que o cluster 6, que já possuía poucas observações, deixa de existir (suas microrregiões passam para o cluster 3).

<br>
<br>


<!-- # Adicional - Grou I + II -->

<!-- **I - Sobre quem são os produtores** -->

<!-- *Variáveis:* -->

<!-- * Presença  -->
<!--   + Proporção número de estabelecimentos da AF na microrregião em 2017;  -->
<!--   + Proporção número de estabelecimentos do Pronamp na microrregião em 2017;  -->
<!--   + Proporção número de estabelecimentos da AP na microrregião em 2017;   -->
<!--   + **[REMOVIDO]** Total de estabelecimentos;   -->
<!--   + Proporção da área de estabelecimentos AF no total da microrregião em 2017;  -->
<!--   + Proporção da área de estabelecimentos do Pronamp no total da microrregião em 2017;  -->
<!--   + Proporção da área de estabelecimentos da AP no total da microrregião em 2017;  -->
<!--   + **[REMOVIDO]** Total de área.  -->

<!-- * Produtividade  -->
<!--   + VBP da AF por hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017;  -->
<!--   + VBP dos Médios/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017;  -->
<!--   + VBP AP/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017.  -->

<!-- * Situação de pobreza -->
<!--   + Porcentagem da população rural beneficiária do Programa Bolsa Família em 2017.  -->

<!-- * Pessoal ocupado -->
<!--   + Proporção do pessoal ocupado da microrregião na AF em 2017;  -->
<!--   + Proporção do pessoal ocupado da microrregião no Pronamp em 2017;   -->
<!--   + Proporção do pessoal ocupado da microrregião na AP em 2017;   -->
<!--   + *[REMOVIDO]** Pessoas ocupadas.  -->



<!-- **II - Sobre desempenho em IPR**  -->

<!-- *Variáveis:* -->

<!-- * Evolução da renda  -->
<!--   + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AF na microrregião 2006-2017. -->
<!--   + Aumento ou redução da renda (desconsiderando aposentadorias e rendas de planos e programas) da AP na microrregião 2006-2017.  -->

<!-- * Renda pelo trabalho -->
<!--   + Renda da AF por trabalhador ocupado na microrregião em 2017.  -->
<!--   + Renda dos beneficiários do Pronamp por trabalhador ocupado na microrregião em 2017.   -->
<!--   + Renda da AP por trabalhador ocupado na microrregião em 2017.  -->

<!-- * Evolução pessoal ocupado  -->
<!--   + Aumento ou redução do pessoal ocupado na AF 2006-2017.  -->
<!--   + Aumento ou redução do pessoal ocupado na AP 2006-2017.  -->

<!-- * Pessoal ocupado -->
<!--   + **[REMOVIDO]** Número de trabalhadores ocupados por hectare na AF da microrregião em 2017.  -->
<!--   + **[REMOVIDO]** Número de trabalhadores ocupados por hectare nos beneficiários do Pronamp da microrregião em 2017.  -->
<!--   + **[REMOVIDO]** Número de trabalhadores ocupados por hectare na AP da microrregião em 2017.  -->

<!-- * Rendas de programas sociais -->
<!--   + Proporção da renda dos estabelecimentos da agricultura familiar composta por programas e políticas para AF em 2017.  -->

<!-- * Rendas produtivas não agrícolas -->
<!--   + Proporção da renda dos estabelecimentos da AF com outras receitas ou fora do estabelecimento em 2017. -->
<!--   + Proporção da renda dos estabelecimentos do Pronamp com outras receitas ou fora do estabelecimento em 2017. -->
<!--   + Proporção da renda dos estabelecimentos da AP com outras receitas ou fora do estabelecimento em 2017.  -->





<!-- ```{r Criando a tabela Cluster III, message=FALSE, warning=FALSE, include=FALSE} -->

<!-- variaveis_clusterIII <- microrregioes_CLI %>% -->
<!--   filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>% -->
<!--   mutate(AF_prop3_REC_naoPROD = (R_VALOR_AF_2 + R_VALOR_AF_302) / R_VALOR_AF_TOT , -->
<!--          MP_prop3_REC_naoPROD = (R_VALOR_MP_2 + R_VALOR_MP_302) / R_VALOR_MP_TOT , -->
<!--          GP_prop3_REC_naoPROD = ((R_VALOR_T_302 - R_VALOR_AF_302) +  (R_VALOR_T_2 - R_VALOR_AF_2))  / (R_VALOR_T_TOT - R_VALOR_AF_TOT)) %>% -->
<!--   select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO, -->

<!--          AF_prop_NEstab, MP_prop_NEstab,  -->
<!--          #NEST_T,  -->
<!--          AF_prop_AREA, MP_prop_AREA,  -->
<!--          #AREA_T,  -->
<!--          AF_VPdivAREA, MP_VPdivAREA, GP_VPdivAREA,  -->
<!--          pct_POPrur_BF,  -->
<!--          AF_prop_OCU, MP_prop_OCU,  -->
<!--          #O_T, -->

<!--          Dif_REND_AF, Dif_REND_NAF, -->
<!--          REND_OCU_AF, REND_OCU_NAF, REND_OCU_MP, -->
<!--          Dif_OCU_AF, Dif_OCU_NAF, -->
<!--          #AF_prop_OCUarea, MP_prop_OCUarea, GP_prop_OCUarea, -->
<!--          AF_prop3_REC_PROG,  -->
<!--          AF_prop3_REC_naoPROD, MP_prop3_REC_naoPROD, GP_prop3_REC_naoPROD  -->
<!--          )  -->

<!-- ``` -->


<!-- ```{r Normalizando variaveis e correlacao III, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'} -->
<!-- variaveis_clusterIII[is.na(variaveis_clusterIII)] <- 0 -->

<!-- # Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização -->
<!-- variaveis_clusterIII_2 <- variaveis_clusterIII %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame() -->

<!-- variaveis_clusterIII_2 <- variaveis_clusterIII_2 %>% -->
<!--   select(5:25) %>% -->
<!--   rename( -->

<!--     "Estab. - % de estab. (AF)" = AF_prop_NEstab, -->
<!--     "Estab. - % de estab. (MP)" = MP_prop_NEstab, -->
<!--     # "Estab. - Nº total" = NEST_T, -->

<!--     "Área - % de área (AF)" = AF_prop_AREA,   -->
<!--     "Área - % de área (MP)" = MP_prop_AREA, -->
<!--     # "Área - Total" = AREA_T, -->

<!--     "VBP - VBP/ha (AF)" = AF_VPdivAREA, -->
<!--     "VBP - VBP/ha (MP)" = MP_VPdivAREA, -->
<!--     "VBP - VBP/ha (AP)" = GP_VPdivAREA, -->

<!--     "Bolsa Família - % pop. rural c/ BF" = pct_POPrur_BF, -->

<!--     "Ocup. - % de ocupados (AF)" = AF_prop_OCU, -->
<!--     "Ocup. - % de ocupados (MP)" = MP_prop_OCU, -->
<!--     # "Ocup. - Total de ocupados" = O_T, -->

<!--     "Evol. renda (Fam.)" = Dif_REND_AF, -->
<!--     "Evol. renda (Patr.)" = Dif_REND_NAF, -->

<!--     "Renda por ocupado (Fam.)" = REND_OCU_AF, -->
<!--     "Renda por ocupado (Pronamp)" = REND_OCU_MP, -->
<!--     "Renda por ocupado (Patr.)" = REND_OCU_NAF, -->

<!--     "Evol. ocupados (Fam.)" = Dif_OCU_AF ,   -->
<!--     "Evol. ocupados (Patr.)" = Dif_OCU_NAF , -->

<!--     # "Ocupados/ha (Fam.)" = AF_prop_OCUarea  , -->
<!--     # "Ocupados/ha (Pronamp)" = MP_prop_OCUarea  , -->
<!--     # "Ocupados/ha (Patr.)" = GP_prop_OCUarea  , -->

<!--     "Rendas prog. soc. (Fam.)" = AF_prop3_REC_PROG, -->

<!--     "Rendas não produt. (Fam.)" = AF_prop3_REC_naoPROD , -->
<!--     "Rendas não produt. (Pronamp)" = MP_prop3_REC_naoPROD , -->
<!--     "Rendas não produt. (Patr.)" = GP_prop3_REC_naoPROD) -->

<!-- # Padronização das escalas -->
<!-- clusterizacaoIII_scale <- scale(variaveis_clusterIII_2) -->

<!-- # correlacao_CLIII <- cor(clusterizacaoIII_scale) -->
<!-- #  -->
<!-- # # corrplot(correlacao_CLIII, method="color",   -->
<!-- # #          type="upper", order="hclust",  -->
<!-- # #          addCoef.col = "#565656", # Add coefficient of correlation -->
<!-- # #          tl.col="black", tl.srt=45) #Text label color and rotation -->
<!-- #  -->
<!-- # correlacao_CLIII_corrplot <- "data/correlacao_CLIII.png" -->
<!-- # include_graphics(correlacao_CLIII_corrplot) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- # #Compute PCA -->
<!-- #  -->
<!-- # res.pca <- prcomp(variaveis_clusterIII_2, scale = TRUE) -->
<!-- #  -->
<!-- # #Visualize eigenvalues (scree plot). Show the percentage of variances explained by each principal component. -->
<!-- #  -->
<!-- # fviz_eig(res.pca) -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # fviz_pca_var(res.pca, -->
<!-- #              col.var = "contrib", # Color by contributions to the PC -->
<!-- #              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), -->
<!-- #              repel = TRUE     # Avoid text overlapping -->
<!-- #              ) -->
<!-- #  -->
<!-- #  -->
<!-- # # Eigenvalues -->
<!-- # eig.val <- get_eigenvalue(res.pca) -->
<!-- # eig.val -->
<!-- #    -->
<!-- # # Results for Variables -->
<!-- # res.var <- get_pca_var(res.pca) -->
<!-- # res.var$coord          # Coordinates -->
<!-- # res.var$contrib        # Contributions to the PCs -->
<!-- # res.var$cos2           # Quality of representation  -->
<!-- # # Results for individuals -->
<!-- # res.ind <- get_pca_ind(res.pca) -->
<!-- # res.ind$coord          # Coordinates -->
<!-- # res.ind$contrib        # Contributions to the PCs -->
<!-- # res.ind$cos2           # Quality of representation  -->
<!-- #  -->
<!-- #  -->
<!-- # View(as.data.frame(res.ind$contrib)) -->

<!-- ``` -->






<!-- ### 3.1. Número ideal de clusters -->

<!-- ```{r Testes de tamanho de cluster III, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3} -->

<!-- # Padronização das escalas -->
<!-- clusterizacaoIII_scale <- scale(variaveis_clusterIII_2) -->

<!-- # Elbow method -->
<!-- CLIDEAL_elbow <- fviz_nbclust(clusterizacaoIII_scale, kmeans, method = "wss") + -->
<!--     #geom_vline(xintercept = 6, linetype = 2)+ -->
<!--   labs(subtitle = "Elbow method") -->

<!-- # Silhouette method -->
<!-- CLIDEAL_silhou <- fviz_nbclust(clusterizacaoIII_scale, kmeans, method = "silhouette")+ -->
<!--   labs(subtitle = "Silhouette method") -->

<!-- # Gap statistic -->
<!-- # nboot = 50 to keep the function speedy.  -->
<!-- # recommended value: nboot= 500 for your analysis. -->
<!-- # Use verbose = FALSE to hide computing progression. -->
<!-- set.seed(123) -->
<!-- CLIDEAL_gap <- fviz_nbclust(clusterizacaoIII_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+ -->
<!--   labs(subtitle = "Gap statistic method") -->

<!-- ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5) -->

<!-- ``` -->

<!-- O primeiro método não apresenta um indicativo conclusivo para o número ideal de clusters e os demais indicam como ideal dois clusters, um número excessivamente baixo para a análise que se deseja fazer aqui. -->

<!-- Como uma alternativa, foi utilizada uma função que fornece resultados de 30 índices diferentes para a escolha do melhor número de clusters. -->

<!-- ```{r teste numero clusters III, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- nbclust_out <- NbClust::NbClust( -->
<!--   data = clusterizacaoIII_scale, -->
<!--   distance = "euclidean", -->
<!--   min.nc = 4, # minimum number of clusters -->
<!--   max.nc = 8, # maximum number of clusters -->
<!--   method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans" -->
<!-- ) -->

<!-- # create a dataframe of the optimal number of clusters -->
<!-- # nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ]) -->
<!-- # # select only indices which select between 2 and 5 clusters -->
<!-- # nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5) -->

<!-- # # create plot -->
<!-- # ggplot(nbclust_plot) + -->
<!-- #   aes(x = clusters) + -->
<!-- #   geom_histogram(bins = 30L, fill = "#0c4c8a") + -->
<!-- #   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") + -->
<!-- #   theme_minimal() -->

<!-- ``` -->



<!-- Os resultados dessa análise mostram que: -->

<!-- * 9 testes indicaram 4 como o número ideal de clusters -->
<!-- * 1 testes indicaram 5 como o número ideal de clusters -->
<!-- * 11 testes indicaram 7 como o número ideal de clusters -->
<!-- * 2 testes indicaram 8 como o número ideal de clusters -->

<!-- Portanto, de acordo com a maioria, o melhor número de clusters, nesse caso, é 7. -->



<!-- ```{r Criacao dos clusters III, echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- #CLUSTERs -->
<!-- set.seed(123) -->
<!-- k4_III <- kmeans(clusterizacaoIII_scale, centers = 4, nstart = 150) -->
<!-- k5_III <- kmeans(clusterizacaoIII_scale, centers = 5, nstart = 150) -->
<!-- k6_III <- kmeans(clusterizacaoIII_scale, centers = 6, nstart = 150) -->
<!-- k7_III <- kmeans(clusterizacaoIII_scale, centers = 7, nstart = 150) -->
<!-- k8_III <- kmeans(clusterizacaoIII_scale, centers = 8, nstart = 150) -->
<!-- k9_III <- kmeans(clusterizacaoIII_scale, centers = 9, nstart = 150) -->
<!-- #print(k4) -->

<!-- k4graph_III <- fviz_cluster(k4_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 4") -->
<!-- k5graph_III <- fviz_cluster(k5_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 5") -->
<!-- k7graph_III <- fviz_cluster(k7_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 7") -->
<!-- k9graph_III <- fviz_cluster(k9_III, geom = "point",  data = clusterizacaoIII_scale) + ggtitle("k = 9") -->

<!-- # Visualize silhouhette information -->
<!-- # library(cluster) -->
<!-- # #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale)) -->
<!-- # teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale))) -->

<!-- ``` -->


<!-- ```{r Manipulacao tabelas clusters III, message=FALSE, warning=FALSE, include=FALSE} -->

<!-- df_clusters_III <- variaveis_clusterIII %>% -->
<!--   mutate(Cluster4 = k4_III$cluster, -->
<!--          Cluster5 = k5_III$cluster, -->
<!--          Cluster6 = k6_III$cluster, -->
<!--          Cluster7 = k7_III$cluster, -->
<!--          Cluster9 = k9_III$cluster)  -->


<!-- # df_clusters_k4_III_sumario <- variaveis_clusterIII %>% -->
<!-- #   mutate(Cluster4 = k4_III$cluster) %>% -->
<!-- #   group_by(Cluster4) %>% -->
<!-- #   summarise_all("mean") %>%  -->
<!-- #   mutate(Tamanho = k4_III$size) %>% -->
<!-- #   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO)) -->
<!-- # df_clusters_k4_centers <- as.data.frame(k4[["centers"]]) -->
<!-- #  -->
<!-- #  -->
<!-- # df_clusters_k5_III_sumario <- variaveis_clusterIII %>% -->
<!-- #   mutate(Cluster5 = k5_III$cluster) %>% -->
<!-- #   group_by(Cluster5) %>% -->
<!-- #   summarise_all("mean") %>%  -->
<!-- #   mutate(Tamanho = k5_III$size) %>% -->
<!-- #   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO)) -->
<!-- # df_clusters_k5_centers <- as.data.frame(k5[["centers"]]) -->
<!-- #  -->
<!-- # df_clusters_k6_III_sumario <- variaveis_clusterIII %>% -->
<!-- #   mutate(Cluster6 = k6_III$cluster) %>% -->
<!-- #   group_by(Cluster6) %>% -->
<!-- #   summarise_all("mean") %>% -->
<!-- #   mutate(Tamanho = k6_III$size) %>% -->
<!-- #   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO)) -->
<!-- # df_clusters_k6_centers <- as.data.frame(k6[["centers"]]) -->

<!-- df_clusters_k7_III_sumario <- variaveis_clusterIII %>% -->
<!--   mutate(Cluster7 = k7_III$cluster) %>% -->
<!--   group_by(Cluster7) %>% -->
<!--   summarise( -->
<!--     AF_prop_NEstab = mean(AF_prop_NEstab, na.rm = TRUE), -->
<!--     MP_prop_NEstab = mean(MP_prop_NEstab, na.rm = TRUE), -->
<!--     NEST_Tsum = sum(NEST_T, na.rm = TRUE)  , -->
<!--     NEST_Tmean = mean(NEST_T, na.rm = TRUE)  , -->
<!--     AF_prop_AREA = mean(AF_prop_AREA, na.rm = TRUE), -->
<!--     MP_prop_AREA = mean(MP_prop_AREA, na.rm = TRUE), -->
<!--     AREA_Tsum  = sum(AREA_T, na.rm = TRUE)  , -->
<!--     AREA_Tmean  = mean(AREA_T, na.rm = TRUE)  , -->
<!--     AF_VPdivAREA = mean(AF_VPdivAREA, na.rm = TRUE), -->
<!--     MP_VPdivAREA = mean(MP_VPdivAREA, na.rm = TRUE), -->
<!--     GP_VPdivAREA = mean(GP_VPdivAREA, na.rm = TRUE), -->
<!--     pct_POPrur_BF = mean(pct_POPrur_BF, na.rm = TRUE), -->
<!--     AF_prop_OCU = mean(AF_prop_OCU, na.rm = TRUE), -->
<!--     MP_prop_OCU = mean(MP_prop_OCU, na.rm = TRUE), -->
<!--     O_Tsum = sum(O_T, na.rm = TRUE), -->
<!--     O_Tmean = mean(O_T, na.rm = TRUE), -->

<!--     Dif_REND_AF = mean(Dif_REND_AF, na.rm = TRUE), -->
<!--     Dif_REND_NAF = mean(Dif_REND_NAF, na.rm = TRUE), -->

<!--     REND_OCU_AF = mean(REND_OCU_AF, na.rm = TRUE), -->
<!--     REND_OCU_MP = mean(REND_OCU_MP, na.rm = TRUE), -->
<!--     REND_OCU_NAF = mean(REND_OCU_NAF, na.rm = TRUE), -->

<!--     Dif_OCU_AF = mean(Dif_OCU_AF, na.rm = TRUE) ,   -->
<!--     Dif_OCU_NAF = mean(Dif_OCU_NAF, na.rm = TRUE) , -->

<!--     AF_prop_OCUarea = mean(AF_prop_OCUarea, na.rm = TRUE)  , -->
<!--     MP_prop_OCUarea = mean(MP_prop_OCUarea, na.rm = TRUE)  , -->
<!--     GP_prop_OCUarea = mean(GP_prop_OCUarea, na.rm = TRUE)  , -->

<!--     AF_prop3_REC_PROG = mean(AF_prop3_REC_PROG, na.rm = TRUE), -->

<!--     AF_prop3_REC_naoPROD = mean(AF_prop3_REC_naoPROD, na.rm = TRUE) , -->
<!--     MP_prop3_REC_naoPROD = mean(MP_prop3_REC_naoPROD, na.rm = TRUE) , -->
<!--     GP_prop3_REC_naoPROD = mean(GP_prop3_REC_naoPROD, na.rm = TRUE) -->

<!--   ) %>% -->
<!--     mutate(Tamanho = k7_III$size) -->
<!-- df_clusters_k5_centers <- as.data.frame(k5[["centers"]]) -->





<!-- # df_clusters_k9_III_sumario <- variaveis_clusterIII %>% -->
<!-- #   mutate(Cluster9 = k9_III$cluster) %>% -->
<!-- #   group_by(Cluster9) %>% -->
<!-- #   summarise_all("mean") %>% -->
<!-- #   mutate(Tamanho = k9_III$size) %>% -->
<!-- #   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO)) -->

<!-- # df_clusters_k9_III_centers <- as.data.frame(k9[["centers"]]) -->

<!-- ``` -->



<!-- ### 3.2. Sumário das médias das microrregiões para cada um dos clusters calculados -->

<!-- ```{r tabela sumario III, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"} -->

<!-- df_clusters_k7_III_sumarioSCALES <- df_clusters_k7_III_sumario %>% -->
<!--   mutate( -->

<!--          AF_prop_NEstab = scales::percent(round(AF_prop_NEstab, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE), -->
<!--          MP_prop_NEstab = scales::percent(round(MP_prop_NEstab, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE), -->
<!--          NEST_Tsum = paste(format(round(NEST_Tsum), decimal.mark=",", big.mark = "."), " estab."), -->
<!--          NEST_Tmean = paste(format(round(NEST_Tmean), decimal.mark=",", big.mark = "."), " estab."), -->

<!--          AF_prop_AREA = scales::percent(round(AF_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE), -->
<!--          MP_prop_AREA = scales::percent(round(MP_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE), -->
<!--          AREA_Tsum = paste(format(round(AREA_Tsum), decimal.mark=",", big.mark = "."), "ha"), -->
<!--          AREA_Tmean = paste(format(round(AREA_Tmean), decimal.mark=",", big.mark = "."), "ha"), -->

<!--          AF_VPdivAREA = paste("R$", format(round(AF_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"), -->
<!--          MP_VPdivAREA = paste("R$", format(round(MP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"), -->
<!--          GP_VPdivAREA = paste("R$", format(round(GP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"), -->

<!--          pct_POPrur_BF = scales::percent(round(pct_POPrur_BF, 4), big.mark = ".",  decimal.mark = ",", na.rm = TRUE), -->

<!--          AF_prop_OCU = scales::percent(round(AF_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE), -->
<!--          MP_prop_OCU = scales::percent(round(MP_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE), -->
<!--          O_Tsum = paste(format(round(O_Tsum), decimal.mark=",", big.mark = "."), " pessoas"), -->
<!--          O_Tmean = paste(format(round(O_Tmean), decimal.mark=",", big.mark = "."), " pessoas"), -->

<!--     Dif_REND_AF = scales::percent(round(Dif_REND_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE)    , -->
<!--     Dif_REND_NAF = scales::percent(round(Dif_REND_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE), -->

<!--     REND_OCU_AF = paste("R$",round(REND_OCU_AF), "/ ocupado") , -->
<!--     REND_OCU_MP = paste("R$",round(REND_OCU_MP), "/ ocupado")  , -->
<!--     REND_OCU_NAF = paste("R$",round(REND_OCU_NAF), "/ ocupado")  , -->

<!--     Dif_OCU_AF = scales::percent(round(Dif_OCU_AF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , -->
<!--     Dif_OCU_NAF = scales::percent(round(Dif_OCU_NAF, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , -->

<!--     AF_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / AF_prop_OCUarea), 2), "ha"), -->
<!--     MP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / MP_prop_OCUarea), 2), "ha"), -->
<!--     GP_prop_OCUarea = paste("1 pessoa ocup. a cada", round((1 / GP_prop_OCUarea), 2), "ha"), -->

<!--     AF_prop3_REC_PROG = scales::percent(round(AF_prop3_REC_PROG, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , -->

<!--     AF_prop3_REC_naoPROD = scales::percent(round(AF_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , -->
<!--     MP_prop3_REC_naoPROD = scales::percent(round(MP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) , -->
<!--     GP_prop3_REC_naoPROD = scales::percent(round(GP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE) -->
<!--   ) %>% -->

<!--   relocate(REND_OCU_MP, .after = REND_OCU_AF) -->


<!-- # real <- dollar_format(prefix = "R$ ", big.mark = ".", decimal.mark = ",") -->

<!-- df_clusters_k7_III_sumarioPLOT <- -->
<!--   as.data.frame(t(df_clusters_k7_III_sumarioSCALES)) %>% -->
<!--   rename("CL 1" = V1, -->
<!--          "CL 2" = V2, -->
<!--          "CL 3" = V3, -->
<!--          "CL 4" = V4, -->
<!--          "CL 5" = V5, -->
<!--          "CL 6" = V6, -->
<!--          "CL 7" = V7) %>% -->
<!--   slice(-1) -->


<!-- df_clusters_k7_III_sumarioPLOT <- df_clusters_k7_III_sumarioPLOT %>% -->
<!-- rownames_to_column(var = "Médias das microrregiões") -->

<!-- df_clusters_k7_III_sumarioPLOT[1,1] <- "% de estab. (AF)"  -->
<!-- df_clusters_k7_III_sumarioPLOT[2,1] <- "% de estab. (MP)" -->
<!-- df_clusters_k7_III_sumarioPLOT[3,1] <- "Total de estabelecimentos no cluster" -->
<!-- df_clusters_k7_III_sumarioPLOT[4,1] <- "Média do total de estabelecimentos por micro" -->

<!-- df_clusters_k7_III_sumarioPLOT[5,1] <- "% de área (AF)" -->
<!-- df_clusters_k7_III_sumarioPLOT[6,1] <- "% de área (MP)" -->
<!-- df_clusters_k7_III_sumarioPLOT[7,1] <- "Área total em ha" -->
<!-- df_clusters_k7_III_sumarioPLOT[8,1] <- "Média de área em ha" -->

<!-- df_clusters_k7_III_sumarioPLOT[9,1] <- "VBP/ha (AF)" -->
<!-- df_clusters_k7_III_sumarioPLOT[10,1] <- "VBP/ha (MP)" -->
<!-- df_clusters_k7_III_sumarioPLOT[11,1] <- "VBP/ha (AP)" -->


<!-- df_clusters_k7_III_sumarioPLOT[12,1] <- "% da população rural beneficiária do Bolsa Família" -->

<!-- df_clusters_k7_III_sumarioPLOT[13,1] <- "% de ocupados (AF)" -->
<!-- df_clusters_k7_III_sumarioPLOT[14,1] <- "% de ocupados (MP)" -->
<!-- df_clusters_k7_III_sumarioPLOT[15,1] <- "Total de ocupados no cluster" -->
<!-- df_clusters_k7_III_sumarioPLOT[16,1] <- "Média do total de ocupados por micro" -->


<!-- df_clusters_k7_III_sumarioPLOT[17,1] <- "Aumento/redução % da renda (Fam.)" -->
<!-- df_clusters_k7_III_sumarioPLOT[18,1] <- "Aumento/redução % da renda (Patr.)" -->

<!-- df_clusters_k7_III_sumarioPLOT[19,1] <- "Renda por pessoa ocupada (Fam.)" -->
<!-- df_clusters_k7_III_sumarioPLOT[20,1] <- "Renda por pessoa ocupada (Pronamp)" -->
<!-- df_clusters_k7_III_sumarioPLOT[21,1] <- "Renda por pessoa ocupada (Patr.)" -->

<!-- df_clusters_k7_III_sumarioPLOT[22,1] <- "Aumento/redução % de ocupados (Fam.)" -->
<!-- df_clusters_k7_III_sumarioPLOT[23,1] <- "Aumento/redução % de ocupados (Patr.)" -->

<!-- df_clusters_k7_III_sumarioPLOT[24,1] <- "Pessoas ocupadas por ha (Fam.)" -->
<!-- df_clusters_k7_III_sumarioPLOT[25,1] <- "Pessoas ocupadas por ha (Pronamp)" -->
<!-- df_clusters_k7_III_sumarioPLOT[26,1] <- "Pessoas ocupadas por ha (Patr.)" -->


<!-- df_clusters_k7_III_sumarioPLOT[27,1] <- "% renda composta por prog. e pol. (Fam.)" -->
<!-- df_clusters_k7_III_sumarioPLOT[28,1] <- "% rendas não agrícolas (Fam.)" -->
<!-- df_clusters_k7_III_sumarioPLOT[29,1] <- "% rendas não agrícolas (Pronamp)" -->
<!-- df_clusters_k7_III_sumarioPLOT[30,1] <- "% rendas não agrícolas (Patr.)" -->

<!-- df_clusters_k7_III_sumarioPLOT[31,1] <- "Nº total de microrregiões" -->



<!-- kbl(df_clusters_k7_III_sumarioPLOT, digits = 2,  -->
<!--     caption = "", align = "lcccccc", -->
<!--     format.args = list(decimal.mark = ',', big.mark = ".")) %>% -->
<!--   kable_paper("basic", full_width = F) %>% -->
<!--   kable_paper("basic", full_width = F) %>% -->
<!--   pack_rows("Estabelecimentos", 1, 4) %>% -->
<!--   pack_rows("Área", 5, 8) %>% -->
<!--   pack_rows("VBP", 9, 11) %>% -->
<!--   pack_rows("Assistência social", 12, 12) %>% -->
<!--   pack_rows("Pessoal ocupado", 13, 16) %>% -->

<!--   pack_rows("Evolução da renda", 17, 18) %>% -->
<!--   pack_rows("Renda pelo trabalho", 19, 21) %>% -->
<!--   pack_rows("Evolução do pessoal ocupado", 22, 23) %>% -->
<!--   pack_rows("Pessoal ocupado por ha útil", 24, 26) %>% -->
<!--   pack_rows("Rendas de programas sociais", 27, 27) %>% -->
<!--   pack_rows("Rendas produtivas não agrícolas", 28, 30) -->


<!-- ``` -->



<!-- ### 3.3. Descrição dos clusters -->


<!-- * Cluster 1  -->

<!-- O primeiro cluster tem forte presença em área da AF (em média 43%). Com valor bruto da produção 3x maior do que o da patronal nessa região, a agricultura familiar também é predominante no tema de pessoal ocupado, apesar de ter tido redução nessa variável de 2006 para 2017.  -->


<!-- * Cluster 2  -->

<!-- O Cluster 2 tem baixíssima presença em área da agricultura familiar, sendo composto majoritariamente por estabelecimentos de beneficiários do Pronamp, ocupando uma área de 79% dos estabelecimentos. Apesar da menor presença da AF, ela é cerca de 2,1x mais eficiênte na produção (na utilização do espaço útil) do que a patronal -->


<!-- * Cluster 3  -->

<!-- No terceiro cluster ocorre a segunda menor procentagem de área da agricultura familiar (83% da patronal), com média de 50% de área do Pronamp. Apesar da baixa expressão da AF em área, com VBP/ha útil 3,8x maior na nela do que na patronal, a AF se mostra mais eficiente na produção em termos de utilização da área.  -->
<!-- Esse cluster é o único que, na média, não predominam pessoas ocupadas na AF, possuindo a renda por pessoa ocupada mais alta dentre os demais clusters da mesma tipologia (familiar). Em conjunto à renda mais alta dentre os estabelecimentos familiares, esse cluster também é o que possuía a menor porcentagem de população rural beneficiária do Bolsa Família (2%). -->


<!-- * Cluster 4  -->

<!-- O cluster 4 tem, em média, a segunda maior porcentagem em área da agricultura familiar. Talvez pelo fato do VBP/ha ser bastante baixo em comparação aos demais, essa tipologia seja a com maior porcentagem de beneficiários do bolsa família (11,15%). Mesmo sendo o único no qual a renda da agricultura familiar diminuiu de 2006 para 2017, os rendimentos não produtivos familiares ficam na mesma média que os demais clusters; já para os beneficiários do Pronamp e dos estabelecimentos patronais, esse valor é o mais alto dentre todos os clusters, com respectivamente 40% e 35% da renda sendo composta por rendas não agrícolas.  -->
<!-- Tendo tido a maior redução de pessoal ocupado no período analisado (20% na AF), houve um aumento de 40% no número de ocupados nos estabelecimentos patronais.  -->


<!-- * Cluster 5  -->

<!-- O cluster 5 é muito similar ao cluster que já vinha aparecendo em analises anteriores como o cluster de alta produtividade e rentabilidade da agricultura familiar. Com presença forte em área da AF (47%), o valor da produção por área dessa tipologia foi 5,06x maior que o da patronal, contando também com em média 3x mais pessoas ocupadas na AF do que na AP.  -->
<!-- Apesar do cluster 2 deter a posição mais alta na evolução da renda da agricultura familiar, o cluster 5 teve um aumento de 28% nessa categoria e um aumento de 75% na categoria patronal.  Com alta renda por pessoal ocupado tanto na AF quanto na AP (em média 3,4x mais alto na patronal), esse cluster apresenta a segunda menor porcentagem de população rural beneficiária do bolsa família (2,2%). -->


<!-- * Cluster 6  -->

<!-- O sexto cluster, localizado em sua maior parte na região Centro-Oeste e na porção sul do Norte é o que possui menor quantidade de pessoas ocupadas por hectare, tanto na agricultura patronal quanto na familiar. Com forte presença da agricultura não familiar (85% em média) e predominância de em média 56% de estabelecimentos baneficiários do Pronamp, apesar de um imenso aumento da renda tanto familiar quanto patronal de 2006 para 2017, o valor da produção por ha/útil não tem o segundo valor mais baixo para a AF e um valor bastante mediano para a AP, podendo indicar que apesar de extremamente rentável, as microrregiões pertencentes ao cluster não possuem grande eficiência na produção. -->


<!-- * Cluster 7  -->

<!-- O cluster 7, que na primeira análise havia ficado junto às microrregiões do cluster 5, vem separado nesta clusterização, revelando uma importante diferença com relação ao cluster predominante espacialmente na região: diferentemente do cluster 1, o cluster 7 possui um altíssimo valor da produção por área útil na AF, além de ter uma alta porcentagem da renda dos estabelecimentos da AF composta por recebimentos de programas e políticas (12% da renda).   -->
<!-- Nesse cluster, o que é mais relevante destacar é que, apesar de um gigantesco aumento na renda patronal de 2006 para 2017, do grande aumento no número de ocupados em estabelecimentos patronais, os valores da renda por pessoa ocupada permaneceram os mais baixos dentre todos os clusters (exceto para a AF do cluster 1), com um valor baixíssimo de pessoas ocupadas por hectare útil. -->



<!-- ### 3.4. Representação espacial dos clusters -->
<!-- ```{r CODmapas PREPARACAO III, message=FALSE, warning=FALSE, include=FALSE} -->

<!-- # SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp") -->
<!-- # SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp") -->
<!-- # st_crs(SHP_Microrregioes) -->
<!-- # tmap_mode("view") -->
<!-- # # tmap_mode("plot") #> tmap mode set to plotting -->
<!-- # # Mudando o nome pra ficar igual ao da tabela -->
<!-- # names(SHP_Microrregioes)[1] <- "COD" -->
<!-- #  -->

<!-- # Juntando o shape e a tabela -->
<!-- SHP_clusters_III <- SHP_Microrregioes %>% -->
<!--   left_join(., df_clusters_III, by = "COD") -->



<!-- # A ser usado na hora de gerar o mapa -->
<!-- margens <- list(b = 50, t = 115) -->

<!-- # make some bbox magic -->
<!-- bbox_new <- st_bbox(SHP_clusters) # current bounding box -->

<!-- xrange <- bbox_new$xmax - bbox_new$xmin # range of x values -->
<!-- yrange <- bbox_new$ymax - bbox_new$ymin # range of y values -->

<!--  bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left -->
<!-- # bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita) -->
<!--  bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom -->
<!-- #bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima) -->

<!-- bbox_new <- bbox_new %>%  # take the bounding box ... -->
<!--   st_as_sfc() # ... and make it a sf polygon -->



<!-- ##### mapa -->

<!-- # tm_AF_VPdivAREA <-  -->
<!-- # microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>% -->
<!-- #   filter(VPdivAREA >= 0) %>% -->
<!-- #   filter(TIPOLOGIA == "AF") %>% -->
<!-- #   tm_shape(bbox = bbox_new) + -->
<!-- #   tm_fill(col = "VPdivAREA",  -->
<!-- #           title = "Valor da produção por hectare (VP/ha)<br/>- AF",  -->
<!-- #           id = "LOCALIZACAO", palette="BuGn", -->
<!-- #           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))), -->
<!-- #           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) + -->
<!-- #   tm_borders(lwd = 0.2) + -->
<!-- #   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) + -->
<!-- #   tm_view(view.legend.position = c("right", "bottom")) + -->
<!-- #   tm_shape(SHP_Estados) + -->
<!-- #   tm_borders(lwd = 1)  -->


<!-- ``` -->


<!-- ```{r Mapeando os clusters III, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- #  -->
<!-- # SHP_clusters_III %>% -->
<!-- #   tm_shape() + -->
<!-- #   tm_fill(col = "Cluster4", -->
<!-- #           title = "Clusters (n=4)", -->
<!-- #           id = "LOCALIZACAO", palette="Accent", -->
<!-- #           #n=7 -->
<!-- #           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))), -->
<!-- #           style = "cat") + -->
<!-- #   tm_borders(lwd = 0.2) + -->
<!-- #   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) + -->
<!-- #   tm_view(view.legend.position = c("right", "bottom")) + -->
<!-- #   tm_shape(SHP_Estados) + -->
<!-- #   tm_borders(lwd = 1) -->

<!-- # SHP_clusters_III %>% -->
<!-- #   tm_shape() + -->
<!-- #   tm_fill(col = "Cluster5", -->
<!-- #           title = "Clusters (n=5)", -->
<!-- #           id = "LOCALIZACAO", palette="Accent", -->
<!-- #           #n=7 -->
<!-- #           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))), -->
<!-- #           style = "cat") + -->
<!-- #   tm_borders(lwd = 0.2) + -->
<!-- #   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) + -->
<!-- #   tm_view(view.legend.position = c("right", "bottom")) + -->
<!-- #   tm_shape(SHP_Estados) + -->
<!-- #   tm_borders(lwd = 1) -->
<!-- # #  -->
<!-- # ### CLUSTER 6 -->
<!-- # SHP_clusters_III %>% -->
<!-- #   filter(!is.na(Cluster6)) %>% -->
<!-- #   tm_shape() + -->
<!-- #   tm_fill(col = "Cluster6", -->
<!-- #           title = "Clusters", -->
<!-- #           id = "LOCALIZACAO", palette="Accent", -->
<!-- #           #n=7 -->
<!-- #           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))), -->
<!-- #           style = "cat") + -->
<!-- #   tm_borders(lwd = 0.2) + -->
<!-- #   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) + -->
<!-- #   tm_view(view.legend.position = c("right", "bottom")) + -->
<!-- #   tm_shape(SHP_Estados) + -->
<!-- #   tm_borders(lwd = 1) -->

<!-- ### CLUSTER 7 -->
<!-- SHP_clusters_III %>% -->
<!--   filter(!is.na(Cluster7)) %>% -->
<!--   tm_shape() + -->
<!--   tm_fill(col = "Cluster7", -->
<!--           title = "Clusters", -->
<!--           id = "LOCALIZACAO", palette="Accent", -->
<!--           #n=7 -->
<!--           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))), -->
<!--           style = "cat") + -->
<!--   tm_borders(lwd = 0.2) + -->
<!--   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) + -->
<!--   tm_view(view.legend.position = c("right", "bottom")) + -->
<!--   tm_shape(SHP_Estados) + -->
<!--   tm_borders(lwd = 1) -->

<!-- # ### CLUSTER 9 -->
<!-- # SHP_clusters_III %>% -->
<!-- #   tm_shape() + -->
<!-- #   tm_fill(col = "Cluster9", -->
<!-- #           title = "Clusters (n=9)", -->
<!-- #           id = "LOCALIZACAO", palette="Accent", -->
<!-- #           #n=7 -->
<!-- #           #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))), -->
<!-- #           style = "cat") + -->
<!-- #   tm_borders(lwd = 0.2) + -->
<!-- #   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) + -->
<!-- #   tm_view(view.legend.position = c("right", "bottom")) + -->
<!-- #   tm_shape(SHP_Estados) + -->
<!-- #   tm_borders(lwd = 1) -->

<!-- ``` -->





