---
title: "Análise de clusters"
subtitle: "Seleção final de variáveis"
output:
  html_document:
    toc: true
    toc_depth: 4 
    toc_float: 
      collapsed: false
    theme: flatly  

---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```


```{r Pacotes, message=FALSE, warning=FALSE, include=FALSE}
#pacotes

#install.packages(c("ggthemes", "ggpubr", "readr", "readxl", "rstatix", "sp", "sf", "tmap", "leaflet", "arsenal", "knitr", "plotly", "kableExtra", "prettydoc", "rmdformats", "knitr", "scales", "esquisse", "pacman"))

#install.packages(c(	"broom", "cli", "crayon" , "dbplyr", "dplyr", "forcats", "ggplot2", "haven", "hms", "httr", "jsonlite", "lubridate", "magrittr", "modelr", "pillar", "purrr", "readr", "readxl", "reprex", "rlang", "rstudioapi", "rvest", "stringr", "tibble", "tidyr", "xml2", "corrplot"))

##install.packages("factoextra")
##install.packages("qwraps2")

pacman::p_load(ggthemes, ggpubr, tidyverse, readr, readxl, esquisse, rstatix, sp, sf, tmap, leaflet, arsenal, knitr, plotly, kableExtra, prettydoc, rmdformats, knitr, scales, broom, cli, crayon , dbplyr, dplyr, forcats, ggplot2, haven, hms, httr, jsonlite, lubridate, magrittr, modelr, pillar, purrr, readr, readxl, reprex, rlang, rstudioapi, rvest, stringr, tibble, tidyr, xml2, factoextra, qwraps2, corrplot) 


options(scipen=999)

```


```{r COD_Tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### TABELAS -----------------
TABELA1 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6778_condicaodoprodutor+niveis.xlsx", na = "X") 
TABELA1$COD[TABELA1$NIVEL == "BR"] <- 000 #alterando o código do Brasil que está igual ao da região Norte

TABELA2 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6878_areaestabelecimentos+niveis.xlsx", na = "X") 
TABELA2$COD[TABELA2$NIVEL == "BR"] <- 000
TABELA2 <- TABELA2 %>% #deletando colunas pra que elas não fiquem duplicadas quando for juntar as tabelas
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA3 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6884_estabelecimentos_pessoalocupadolacoparentesco+niveis.xlsx", na = "X") 
TABELA3$COD[TABELA3$NIVEL == "BR"] <- 000
TABELA3 <- TABELA3 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA4 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6884_pessoalocupado+niveis.xlsx", na = "X") 
TABELA4$COD[TABELA4$NIVEL == "BR"] <- 000
TABELA4 <- TABELA4 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA5 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6884_pessoalocupadolacoparentesco+niveis.xlsx", na = "X") 
TABELA5$COD[TABELA5$NIVEL == "BR"] <- 000
TABELA5 <- TABELA5 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA6 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6898_valordaproducao+niveis.xlsx", na = "X") 
TABELA6$COD[TABELA6$NIVEL == "BR"] <- 000
TABELA6 <- TABELA6 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA7 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6901_num-estab-rendas+niveis.xlsx", na = "X") 
TABELA7$COD[TABELA7$NIVEL == "BR"] <- 000
TABELA7 <- TABELA7 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6901_valorreceitas+niveis.xlsx", na = "X") 
TABELA8$COD[TABELA8$NIVEL == "BR"] <- 000
TABELA8 <- TABELA8 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA9 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/6882_areapreservacao+niveis.xlsx", na = "X") 
TABELA9$COD[TABELA9$NIVEL == "BR"] <- 000
TABELA9 <- TABELA9 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA10 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6788_MUN_totalestabelecimentos+niveis.xlsx", na = "X") 
TABELA10$COD[TABELA10$NIVEL == "BR"] <- 000
TABELA10 <- TABELA10 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)




TABELA4_06 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1113_MUN_ocupados.xlsx", na = "X") 
TABELA4_06$COD[TABELA4_06$NIVEL == "BR"] <- 000
TABELA4_06 <- TABELA4_06 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8_06a <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1116_MUN_rendimentosagropecuarios.xlsx", na = "X") 
TABELA8_06a$COD[TABELA8_06a$NIVEL == "BR"] <- 000
TABELA8_06a <- TABELA8_06a %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8_06b <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1117_MUN_rendimentosnaoagropec.xlsx", na = "X") 
TABELA8_06b$COD[TABELA8_06b$NIVEL == "BR"] <- 000
TABELA8_06b <- TABELA8_06b %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)
TABELA8_06 <- left_join(TABELA8_06a, TABELA8_06b, by = "COD")

TABELA2_06 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/2006_1112_MUN_totalestabelecimentos+areas+niveis.xlsx", na = "X") 
TABELA2_06$COD[TABELA2_06$NIVEL == "BR"] <- 000
TABELA2_06 <- TABELA2_06 %>% #deletando colunas pra que elas não fiquem duplicadas quando for juntar as tabelas
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)



```

```{r COD_Procedimentos com as tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### PROCEDIMENTOS COM AS TABELAS -----------------

#PARA VER (se) QUAIS LINHAS ESTÃO DUPLICADAS
TABELA1[duplicated(TABELA1$COD) | duplicated(TABELA1$COD, fromLast = TRUE), ]


#Join de todas as tabelas 
todastabelas <- TABELA1 %>% 
  left_join(., TABELA2, by = "COD") %>%
  left_join(., TABELA3, by = "COD") %>%
  left_join(., TABELA4, by = "COD") %>%
  left_join(., TABELA5, by = "COD") %>%
  left_join(., TABELA6, by = "COD") %>%
  left_join(., TABELA7, by = "COD") %>%
  left_join(., TABELA8, by = "COD") %>%
  left_join(., TABELA9, by = "COD") %>%
  left_join(., TABELA10, by = "COD") %>%
  full_join(., TABELA4_06, by = "COD") %>%
  full_join(., TABELA8_06, by = "COD") %>%
  full_join(., TABELA2_06, by = "COD")


#Filtragem por recorte geográfico
microrregioes <- todastabelas %>% filter(NIVEL == "MI")
mesorregioes <- todastabelas %>% filter(NIVEL == "ME")
estados <- todastabelas %>% filter(NIVEL == "UF")
macrorregioes <- todastabelas %>% filter(NIVEL == "GR")
brasil <- todastabelas %>% filter(NIVEL == "BR")


#Criando colunas de código do estado e da região 
microrregioes <- microrregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
microrregioes$COD_ESTADO <- substr(microrregioes$COD_ESTADO, 0, 2)
microrregioes$COD_REGIAO <- substr(microrregioes$COD_REGIAO, 0, 1)
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "1"] <- "Norte"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "2"] <- "Nordeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "3"] <- "Sudeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "4"] <- "Sul"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "5"] <- "Centro-Oeste"


mesorregioes <- mesorregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
mesorregioes$COD_ESTADO <- substr(mesorregioes$COD_ESTADO, 0, 2)
mesorregioes$COD_REGIAO <- substr(mesorregioes$COD_REGIAO, 0, 1)


```

```{r COD_Novas colunas, message=FALSE, warning=FALSE, include=FALSE}
#### CÁLCULO DAS PORCENTAGENS -----------------
microrregioes_pct <- microrregioes %>%
  mutate(MP_prop_REC_PROD = R_VALOR_MP_1 / R_VALOR_T_1 ,
         MP_prop_REC_OUTR = R_VALOR_MP_2 / R_VALOR_T_2 ,
         MP_prop_REC_FORA = R_VALOR_MP_302 / R_VALOR_T_302 ,
         MP_prop_REC_PROG = (R_VALOR_MP_301 + R_VALOR_MP_303 + R_VALOR_MP_304 + R_VALOR_MP_305 + R_VALOR_MP_306 + R_VALOR_MP_307) / (R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) ,
         AF_prop_REC_PROD = R_VALOR_AF_1 / R_VALOR_T_1 ,
         AF_prop_REC_OUTR = R_VALOR_AF_2 / R_VALOR_T_2 ,
         AF_prop_REC_FORA = R_VALOR_AF_302 / R_VALOR_T_302 ,
         AF_prop_REC_PROG = (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307) / (R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) ,
         GP_prop_REC_PROD = (R_VALOR_T_1 - R_VALOR_AF_1) / R_VALOR_T_1,
         GP_prop_REC_OUTR = (R_VALOR_T_2 - R_VALOR_AF_2) / R_VALOR_T_2,
         GP_prop_REC_FORA = (R_VALOR_T_302 - R_VALOR_AF_302) / R_VALOR_T_302,
         GP_prop_REC_PROG = ((R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) - (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307)) / (R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307),
GP_prop_REC_TOT = (R_VALOR_T_TOT - R_VALOR_AF_TOT) / R_VALOR_T_TOT,
         
         AF_prop_NEstab = PROD_AF / PROD_T ,
         MP_prop_NEstab = PROD_MP / PROD_T ,
         GP_prop_NEstab = (PROD_T - PROD_AF) / PROD_T ,
         
         AF_prop_AREA = AREA_AF / AREA_T ,
         MP_prop_AREA = AREA_MP / AREA_T ,
         GP_prop_AREA = (AREA_T - AREA_AF) / AREA_T ,
         
         AF_prop_OCU = O_AF / O_T ,
         MP_prop_OCU = O_MP / O_T ,
         GP_prop_OCU = (O_T - O_AF) / O_T ,
         
         AF_prop_VP = VP_AF / VP_T ,
         MP_prop_VP = VP_MP / VP_T ,
         GP_prop_VP = (VP_T - VP_AF) / VP_T ,
         
         MP_prop_REC_TOT = R_VALOR_MP_TOT / R_VALOR_T_TOT,
         AF_prop_REC_TOT = R_VALOR_AF_TOT / R_VALOR_T_TOT,
         GP_prop_REC_TOT = (R_VALOR_T_TOT - R_VALOR_AF_TOT) / R_VALOR_T_TOT,
         
         #porcentagem tipo 2, usando o total de tudo
         MP_prop2_REC_PROD = R_VALOR_MP_1 / R_VALOR_T_TOT ,
         MP_prop2_REC_OUTR = R_VALOR_MP_2 / R_VALOR_T_TOT ,
         MP_prop2_REC_FORA = R_VALOR_MP_302 / R_VALOR_T_TOT ,
         MP_prop2_REC_PROG = (R_VALOR_MP_301 + R_VALOR_MP_303 + R_VALOR_MP_304 + R_VALOR_MP_305 + R_VALOR_MP_306 + R_VALOR_MP_307) / R_VALOR_T_TOT ,
         AF_prop2_REC_PROD = R_VALOR_AF_1 / R_VALOR_T_TOT ,
         AF_prop2_REC_OUTR = R_VALOR_AF_2 / R_VALOR_T_TOT ,
         AF_prop2_REC_FORA = R_VALOR_AF_302 / R_VALOR_T_TOT ,
         AF_prop2_REC_PROG = (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307) /  R_VALOR_T_TOT ,
         GP_prop2_REC_PROD	=	(R_VALOR_T_1 - R_VALOR_AF_1 ) /  R_VALOR_T_TOT,
         GP_prop2_REC_OUTR	=	(R_VALOR_T_2 - R_VALOR_AF_2) /  R_VALOR_T_TOT ,
         GP_prop2_REC_FORA	=	(R_VALOR_T_302 - R_VALOR_AF_302) /  R_VALOR_T_TOT ,
         GP_prop2_REC_PROG	=	((R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) - (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307)) / R_VALOR_T_TOT  ,
         
        #porcentagem tipo 3, usando o total de cada tipologia 
        MP_prop3_REC_PROD = R_VALOR_MP_1 / R_VALOR_MP_TOT ,
        MP_prop3_REC_OUTR = R_VALOR_MP_2 / R_VALOR_MP_TOT ,
        MP_prop3_REC_FORA = R_VALOR_MP_302 / R_VALOR_MP_TOT ,
        MP_prop3_REC_PROG = (R_VALOR_MP_301 + R_VALOR_MP_303 + R_VALOR_MP_304 + R_VALOR_MP_305 + R_VALOR_MP_306 + R_VALOR_MP_307) / R_VALOR_MP_TOT ,
        AF_prop3_REC_PROD = R_VALOR_AF_1 / R_VALOR_AF_TOT ,
        AF_prop3_REC_OUTR = R_VALOR_AF_2 / R_VALOR_AF_TOT ,
        AF_prop3_REC_FORA = R_VALOR_AF_302 / R_VALOR_AF_TOT ,
        AF_prop3_REC_PROG = (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307) /  R_VALOR_AF_TOT ,   
        GP_prop3_REC_PROD = (R_VALOR_T_1 - R_VALOR_AF_1) /  (R_VALOR_T_TOT - R_VALOR_AF_TOT) ,
        GP_prop3_REC_OUTR = (R_VALOR_T_2 - R_VALOR_AF_2) /  (R_VALOR_T_TOT - R_VALOR_AF_TOT) ,
        GP_prop3_REC_FORA = (R_VALOR_T_302 - R_VALOR_AF_302) /  (R_VALOR_T_TOT - R_VALOR_AF_TOT) ,
        GP_prop3_REC_PROG = ((R_VALOR_T_301 + R_VALOR_T_303 + R_VALOR_T_304 + R_VALOR_T_305 + R_VALOR_T_306 + R_VALOR_T_307) - (R_VALOR_AF_301 + R_VALOR_AF_303 + R_VALOR_AF_304 + R_VALOR_AF_305 + R_VALOR_AF_306 + R_VALOR_AF_307)) / (R_VALOR_T_TOT - R_VALOR_AF_TOT)  ,

 #Valor da produção por área útil
    TT_VPdivAREA = round((VP_T*1000) / (AREA_T - AREAPRESERV_T), 2), 
    AF_VPdivAREA = round((VP_AF*1000) / (AREA_AF - AREAPRESERV_AF), 2),
    MP_VPdivAREA = round((VP_MP*1000) / (AREA_MP - AREAPRESERV_MP), 2),
    GP_VPdivAREA = round((((VP_T - VP_AF))*1000) / ((VP_T - VP_AF) - AREAPRESERV_GP), 2),
         





    
##a partir daqui, método para calcular os rendimentos dos estabelecimentos + RENDIMENTOS FORA DO ESTABELECIMENTO (SEM CONSIDERAR RENDAS DE PROGRAMAS E POLÍTICAS)

    # R_NEST_T = R_NEST_T_TOT     ,
    # R_NEST_NAF = R_NEST_T_TOT - R_NEST_AF_TOT     ,
    # R_NEST_AF = R_NEST_AF_TOT     ,
    # R_06_NEST_T = R_06_NEST_T     ,
    # R_06_NEST_NAF = R_06_NEST_NAF     ,
    # R_06_NEST_AF = R_06_NEST_AF     ,
    # 
    # 
    # R_VALOR_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302) / 12 ,
    # R_VALOR_NAF = (R_VALOR_T_1 - R_VALOR_AF_1 + R_VALOR_T_2 - R_VALOR_AF_2 + R_VALOR_T_302 - R_VALOR_AF_302) / 12 ,
    # R_VALOR_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302) / 12 ,
    # 
    # 
    # Rc_06_VALOR_T	=	((R_06_VALOR_T + R_06_VALOROTR_T6) / 12)	*	1,8974051,  #Para corrigir inflação multiplicar tudo por 1,89740510
    # Rc_06_VALOR_AF	=	((R_06_VALOR_AF + R_06_VALOROTR_AF6) / 12)	*	1,8974051,
    # Rc_06_VALOR_NAF	=	((R_06_VALOR_NAF + R_06_VALOROTR_NAF6) / 12)	*	1,8974051,
    # R_06_VALOR_T = (R_06_VALOR_T + R_06_VALOROTR_T6) / 12   ,
    # R_06_VALOR_AF = (R_06_VALOR_AF + R_06_VALOROTR_AF6) / 12  ,
    # R_06_VALOR_NAF = (R_06_VALOR_NAF + R_06_VALOROTR_NAF6) / 12   ,
    # 
    # NEST_T = NEST_T     ,
    # NEST_NAF = NEST_NAF     ,
    # NEST_AF = NEST_AF     ,
    # NEST_06_T = NEST_06_T     ,
    # NEST_06_NAF = NEST_06_NAF     ,
    # NEST_06_AF = NEST_06_AF     ,
    # AREA_T = AREA_T     ,
    # AREA_NAF = AREA_T - AREA_AF     ,
    # AREA_AF = AREA_AF     ,
    # AREA_06_T = AREA_06_T     ,
    # AREA_06_NAF = AREA_06_NAF     ,
    # AREA_06_AF = AREA_06_AF     ,
    # OCU_T = O_T     ,
    # OCU_NAF = O_T - O_AF     ,
    # OCU_AF = O_AF     ,
    # OCU_06_T = OCU_06_T     ,
    # OCU_06_NAF = OCU_06_Nfam     ,
    # OCU_06_AF = OCU_06_AF  ,
    

##a partir daqui, método para calcular os rendimentos APENAS DOS ESTABELECIMENTOS
    
    R_NEST_T	=	R_NEST_T_TOT				,
    R_NEST_NAF	=	R_NEST_T_TOT - R_NEST_AF_TOT				,
    R_NEST_AF	=	R_NEST_AF_TOT				,
    R_06_NEST_T	=	R_06_NEST_T				,
    R_06_NEST_NAF	=	R_06_NEST_NAF				,
    R_06_NEST_AF	=	R_06_NEST_AF				,


    R_VALOR_T	=	((R_VALOR_T_1	+	R_VALOR_T_2) / 12), #como a variável é anual, aqui está sendo dividida por 12 para se ter o valor mensal médio
    R_VALOR_NAF	=	((R_VALOR_T_1 - R_VALOR_AF_1	+	R_VALOR_T_2 - R_VALOR_AF_2) / 12)		,
    R_VALOR_AF	=	((R_VALOR_AF_1	+	R_VALOR_AF_2) / 12)		,
    R_VALOR_MP	=	((R_VALOR_MP_1	+	R_VALOR_MP_2) / 12)		,



    Rc_06_VALOR_T	=	((R_06_VALOR_T / 12)	*	1.8974051),  #Para corrigir inflação multiplicar tudo por 1,89740510
    Rc_06_VALOR_NAF	=	((R_06_VALOR_NAF / 12)	*	1.8974051),
    Rc_06_VALOR_AF	=	((R_06_VALOR_AF / 12)	*	1.8974051),
    R_06_VALOR_T	=	(R_06_VALOR_T) / 12				,
    R_06_VALOR_NAF	=	(R_06_VALOR_NAF) / 12				,
    R_06_VALOR_AF	=	(R_06_VALOR_AF) / 12				,

    


    NEST_T	=	NEST_T				,
    NEST_NAF	=	NEST_NAF				,
    NEST_AF	=	NEST_AF				,
    NEST_06_T	=	NEST_06_T				,
    NEST_06_NAF	=	NEST_06_NAF				,
    NEST_06_AF	=	NEST_06_AF				,
    AREA_T	=	AREA_T				,
    AREA_NAF	=	AREA_T - AREA_AF				,
    AREA_AF	=	AREA_AF				,
    AREA_06_T	=	AREA_06_T				,
    AREA_06_NAF	=	AREA_06_NAF				,
    AREA_06_AF	=	AREA_06_AF				,
    OCU_T	=	O_T				,
    OCU_NAF	=	O_T - O_AF				,
    OCU_AF	=	O_AF				,
    OCU_06_T	=	OCU_06_T				,
    OCU_06_NAF	=	OCU_06_Nfam				,
    OCU_06_AF	=	OCU_06_AF	,




    PROD_prop_T_01 = PROD_T_01 / PROD_T,
    PROD_prop_AF_01 = PROD_AF_01 / PROD_AF,
    PROD_prop_MP_01 = PROD_MP_01 / PROD_MP,

    PROD_prop_T_010203 = (PROD_T_01+PROD_T_02+PROD_T_03) / PROD_T,
    PROD_prop_AF_010203 = (PROD_AF_01+PROD_AF_02+PROD_AF_03) / PROD_AF,
    PROD_prop_MP_010203 = (PROD_MP_01+PROD_MP_02+PROD_MP_03) / PROD_MP,
   # PROD_prop_NAF_010203 = (PROD_MP_01+PROD_MP_02+PROD_MP_03) / PROD_MP,

    



 

REND_ESTAB_T	=	(1000	*	R_VALOR_T)	/	NEST_T	,
REND_ESTAB_NAF	=	(1000	*	R_VALOR_NAF)	/	NEST_NAF	,
REND_ESTAB_AF	=	(1000	*	R_VALOR_AF)	/	NEST_AF	,
REND_ESTAB_06_T	=	(1000	*	R_06_VALOR_T)	/	NEST_06_T	,
REND_ESTAB_06_NAF	=	(1000	*	R_06_VALOR_NAF)	/	NEST_06_NAF	,
REND_ESTAB_06_AF	=	(1000	*	R_06_VALOR_AF)	/	NEST_06_AF , 
RENDc_ESTAB_06_T	=	(1000	*	Rc_06_VALOR_T)	/	NEST_06_T	, #INFLAÇÃO CORRIGIDA
RENDc_ESTAB_06_NAF	=	(1000	*	Rc_06_VALOR_NAF)	/	NEST_06_NAF	, #INFLAÇÃO CORRIGIDA
RENDc_ESTAB_06_AF	=	(1000	*	Rc_06_VALOR_AF)	/	NEST_06_AF ,  #INFLAÇÃO CORRIGIDA


REND_OCU_T	=	(1000	*	R_VALOR_T)	/	OCU_T	,
REND_OCU_NAF	=	(1000	*	R_VALOR_NAF)	/	OCU_NAF	,
REND_OCU_AF	=	(1000	*	R_VALOR_AF)	/	OCU_AF	,
REND_OCU_MP	=	(1000	*	R_VALOR_MP)	/	O_MP	, # Renda por trabalhador ocupado - renda pelo trabalho

REND_OCU_06_T	=	(1000	*	R_06_VALOR_T)	/	OCU_06_T	,
REND_OCU_06_NAF	=	(1000	*	R_06_VALOR_NAF)	/	OCU_06_NAF	,
REND_OCU_06_AF	=	(1000	*	R_06_VALOR_AF)	/	OCU_06_AF ,

RENDc_OCU_06_T	=	(1000	*	Rc_06_VALOR_T)	/	OCU_06_T	,
RENDc_OCU_06_NAF	=	(1000	*	Rc_06_VALOR_NAF)	/	OCU_06_NAF	,
RENDc_OCU_06_AF	=	(1000	*	Rc_06_VALOR_AF)	/	OCU_06_AF ,
  

Dif_NEST_T	=	(	NEST_T	-	NEST_06_T	)	/	NEST_06_T	,
Dif_NEST_NAF	=	(	NEST_NAF	-	NEST_06_NAF	)	/	NEST_06_NAF	,
Dif_NEST_AF	=	(	NEST_AF	-	NEST_06_AF	)	/	NEST_06_AF	,
									
Dif_OCU_T	=	(	OCU_T	-	OCU_06_T	)	/	OCU_06_T	,
Dif_OCU_NAF	=	(	OCU_NAF	-	OCU_06_NAF	)	/	OCU_06_NAF	,
Dif_OCU_AF	=	(	OCU_AF	-	OCU_06_AF	)	/	OCU_06_AF	,
									
Dif_REND_OCU_T	=	(	REND_OCU_T	-	REND_OCU_06_T	)	/	REND_OCU_06_T	,
Dif_REND_OCU_NAF	=	(	REND_OCU_NAF	-	REND_OCU_06_NAF	)	/	REND_OCU_06_NAF	,
Dif_REND_OCU_AF	=	(	REND_OCU_AF	-	REND_OCU_06_AF	)	/	REND_OCU_06_AF	,
									
Dif_REND_ESTAB_T	=	(	REND_ESTAB_T	-	RENDc_ESTAB_06_T	)	/	RENDc_ESTAB_06_T	,
Dif_REND_ESTAB_NAF	=	(	REND_ESTAB_NAF	-	RENDc_ESTAB_06_NAF	)	/	RENDc_ESTAB_06_NAF	,
Dif_REND_ESTAB_AF	=	(	REND_ESTAB_AF	-	RENDc_ESTAB_06_AF	)	/	RENDc_ESTAB_06_AF	,
									
Dif_AREA_T	=	(	AREA_T	-	AREA_06_T	)	/	AREA_06_T	,
Dif_AREA_NAF	=	(	AREA_NAF	-	AREA_06_NAF	)	/	AREA_06_NAF	,
Dif_AREA_AF	=	(	AREA_AF	-	AREA_06_AF	)	/	AREA_06_AF	,

Dif_REND_T	=	(	R_VALOR_T	-	Rc_06_VALOR_T	)	/	Rc_06_VALOR_T	,
Dif_REND_NAF	=	(	R_VALOR_NAF	-	Rc_06_VALOR_NAF	)	/	Rc_06_VALOR_NAF	,
Dif_REND_AF	=	(	R_VALOR_AF	-	Rc_06_VALOR_AF	)	/	Rc_06_VALOR_AF ,

AF_prop_OCUarea = (O_AF / (AREA_AF - AREAPRESERV_AF)), #prop de pessoas ocupadas por hectare da AF
MP_prop_OCUarea = (O_MP / (AREA_MP - AREAPRESERV_MP)), #prop de pessoas ocupadas por hectare da AF
GP_prop_OCUarea = ((O_T - O_AF) / ((AREA_T - AREA_AF) - AREAPRESERV_GP)), #prop de pessoas ocupadas por hectare da AP


TOT_AREAmedia = AREA_T / NEST_T ,
NAF_AREAmedia = AREA_NAF / NEST_NAF, 
AF_AREAmedia = AREA_AF / NEST_AF,

TOT_AREAmedia_util = (AREA_T - AREAPRESERV_T) / NEST_T, 
NAF_AREAmedia_util = (AREA_NAF - AREAPRESERV_GP) / NEST_NAF, 
AF_AREAmedia_util = (AREA_AF - AREAPRESERV_AF) / NEST_AF


)


# microrregioes_pct <- microrregioes_pct %>%
#   select(-(4:162))

```


Essa análise tem como objetivo verificar, a partir do processo de clusterização, as possíveis formas de agrupar um conjunto de variáveis de modo a regionalizar aspectos que possam auxiliar no melhor entendimento da inclusão produtiva rural. 

A partir da clusterização realizada para os dois conjuntos de variáveis, foram selecionadas apenas algumas das variáveis para comporem a clusterização final.


**Sobre a tipologia dos estabelecimentos:**

As variáveis compreendem dados de três grupos:

* Estabelecimentos da agricultura familiar (AF / Fam. / Familiar);
* Estabelecimentos de beneficiados pelo Pronamp - Programa Nacional de Apoio ao Médio Produtor Rural (MP / Pronamp / médio produtor);
  + Pequenos ou médios agricultores rurais que tenham no mínimo, 80% de sua renda bruta anual originária da atividade agropecuária ou extrativa vegetal e possuam renda bruta anual de até R$ 2 milhões;
* Estabelecimentos que não são de agricultura familiar (AP / não familiares / patronais)
  + Nessa análise, foi considerado como de tipologia patronal tudo que não é familiar, ou seja, a diferença entre o total dos estabelecimentos e os estabelecimentos da agricultura familiar.
  

Observação: Ao tratar de área útil dos estabelecimentos (hectare útil), o trabalho refere-se a totalidade das áreas dos estabelecimentos, excluídas as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal.


```{r TABELA_POP_BF, message=FALSE, warning=FALSE, include=FALSE}

CENSODEM_10 <- read_excel("data/tabelas/CensoDemografico/CensoDem_2010_3216.xlsx", na = "X") 
CENSODEM_10$COD[CENSODEM_10$NIVEL == "BR"] <- 000
CENSODEM_10 <- CENSODEM_10 %>%
  select(c(COD, POP10_Rur))




# CORRESPONDER MUNICÍPIO E MICRORREGIÃO
corresp <- read_delim("data/tabelas/CORRESPmun_micro/TabelaCorrespondencia_MUN_MICRO.csv", 
                      ";", escape_double = FALSE, locale = locale(encoding = "WINDOWS-1252"))

CADUNICO_familia <- read_delim("data/tabelas/CADUNICO/base_amostra_familia_201712_20190131.csv",
    ";", escape_double = FALSE, col_types = cols(dat_alteracao_fam = col_date(format = "%Y-%m-%d")),
    trim_ws = TRUE)


CADUNICO_familia2 <- CADUNICO_familia %>%
  filter(cod_local_domic_fam == 2) %>% #apenas rural
  filter(marc_pbf == 1) %>% #beneficiários do Bolsa Familia
  group_by(cd_ibge) %>%
  summarise(NumPessoasBF = sum(qtde_pessoas)) %>%
  left_join(., corresp, by = c("cd_ibge" = "Código Município Completo")) %>%
  group_by(COD_MICRO) %>%
  summarise(NumPessoasBF = sum(NumPessoasBF)) %>%
  mutate(COD_MICRO = as.character(COD_MICRO))


CADUNICO_POP <- CADUNICO_familia2 %>%
  left_join(., CENSODEM_10, by = c("COD_MICRO" = "COD")) %>%
  mutate(pct_POPrur_BF = (NumPessoasBF / POP10_Rur)) # Cálculo da porcentagem da população beneficiária do BF


#Juntando a tabela com as variáveis do Censo Agro e os dados do CADUNICO

microrregioes_CLI <- microrregioes_pct %>%
  left_join(., CADUNICO_POP, by = c("COD" = "COD_MICRO"))

 
```

<br>

# Clusterização

## Variáveis

* Presença 
  + Proporção de estabelecimentos da AF na microrregião em 2017; 
  + Proporção de estabelecimentos do Pronamp na microrregião em 2017; 
  + Proporção de estabelecimentos da AP na microrregião em 2017;  
  + Proporção da área de estabelecimentos AF no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos do Pronamp no total da microrregião em 2017; 
  + Proporção da área de estabelecimentos da AP no total da microrregião em 2017; 
  + Área média do total dos estabelecimentos na microrregião em 2017;
  + Área média dos estabelecimentos da AF na microrregião em 2017;
  + Área média dos estabelecimentos da AP na microrregião em 2017;
  

* Produtividade 
  + VBP da AF por hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP dos Médios/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017; 
  + VBP AP/hectare útil (excluindo as áreas de matas ou florestas naturais destinadas à preservação permanente ou reserva legal) da microrregião em 2017. 
  

* Pessoal ocupado
  + Proporção do pessoal ocupado da microrregião na AF em 2017; 
  + Proporção do pessoal ocupado da microrregião no Pronamp em 2017;  
  + Proporção do pessoal ocupado da microrregião na AP em 2017;

  
* Rendimentos
  + Rendimentos por trabalhador ocupado nos estabelecimentos agropecuários da AF em 2017;
  + Rendimentos por trabalhador ocupado nos estabelecimentos agropecuários não familiares em 2017;
  + Rendimentos por trabalhador ocupado nos estabelecimentos agropecuários de beneficiários do Pronamp em 2017;
  + Rendas produtivas não agrícolas (desinvestimentos; serviço de turismo rural; exploração mineral; atividade de artesanato, tecelagem, etc; outras receitas do estabelecimento; rendas obtidas em atividades fora do estabelecimento) 
    - Proporção da renda dos estabelecimentos da AF com outras receitas ou fora do estabelecimento em 2017; 
    - Proporção da renda dos estabelecimentos do Pronamp com outras receitas ou fora do estabelecimento em 2017; 
    - Proporção da renda dos estabelecimentos da AP com outras receitas ou fora do estabelecimento em 2017; 
  + Proporção da renda dos estabelecimentos da agricultura familiar composta por programas e políticas para AF em 2017;
  
  


```{r bCriando a tabela Cluster I, message=FALSE, warning=FALSE, include=FALSE}

# microrregioes_CLI_dist <- as.data.frame(SHP_DISTANCIAREGIC) %>%
#   select(CD_MICRO, distance) %>%
#   full_join(., microrregioes_CLI, by = c("CD_MICRO" = "COD")) 


variaveis_clusterI <- microrregioes_CLI %>%
  filter(LOCALIZACAO != "Fernando de Noronha (PE)") %>%
  mutate(AF_prop3_REC_naoPROD = (R_VALOR_AF_2 + R_VALOR_AF_302) / R_VALOR_AF_TOT ,
         MP_prop3_REC_naoPROD = (R_VALOR_MP_2 + R_VALOR_MP_302) / R_VALOR_MP_TOT ,
         GP_prop3_REC_naoPROD = ((R_VALOR_T_302 - R_VALOR_AF_302) + (R_VALOR_T_2 - R_VALOR_AF_2))  / (R_VALOR_T_TOT - R_VALOR_AF_TOT),
         
         AF_prop3_PRODOUTRFORA = (AF_prop3_REC_PROD + AF_prop3_REC_OUTR + AF_prop3_REC_FORA),
         MP_prop3_PRODOUTRFORA = (MP_prop3_REC_PROD + MP_prop3_REC_OUTR + MP_prop3_REC_FORA),
         GP_prop3_PRODOUTRFORA = (GP_prop3_REC_PROD + GP_prop3_REC_OUTR + GP_prop3_REC_FORA)) %>%
  
  
  
  select(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO,
         AF_prop_NEstab, MP_prop_NEstab, GP_prop_NEstab, 
         TOT_AREAmedia, AF_AREAmedia, NAF_AREAmedia,
         AF_prop_AREA, MP_prop_AREA, GP_prop_AREA, 
         AF_VPdivAREA, MP_VPdivAREA, GP_VPdivAREA, 
         AF_prop_OCU, MP_prop_OCU, GP_prop_OCU,
         #rendas exceto produção agrícola
         AF_prop3_REC_naoPROD, MP_prop3_REC_naoPROD, GP_prop3_REC_naoPROD,
         #rendas exceto programas e políticas
         #AF_prop3_PRODOUTRFORA, MP_prop3_PRODOUTRFORA, GP_prop3_PRODOUTRFORA,
         # rendimentos por trabalhador ocupado
         REND_OCU_AF, REND_OCU_NAF, REND_OCU_MP,
         AF_prop3_REC_PROG)
```



```{r bNormalizando variaveis I, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
variaveis_clusterI[is.na(variaveis_clusterI)] <- 0

# Colocando a coluna de ID da micro como coluna 0, identificadora da linha, assim ela não é afetada pelo procedimento de padronização
variaveis_clusterI_2 <- variaveis_clusterI %>% remove_rownames %>% column_to_rownames(var="COD") %>% as.data.frame()


variaveis_clusterI_3 <- variaveis_clusterI_2 %>%
  select(5:26) 
#%>%
  # rename(
  #   "Estab. - % de estab. (AF)" = AF_prop_NEstab,
  #   "Estab. - % de estab. (MP)" = MP_prop_NEstab,
  #   "Estab. - % de estab. (AP)" = GP_prop_NEstab,
  # 
  #   "Área - % de área (AF)" = AF_prop_AREA,
  #   "Área - % de área (MP)" = MP_prop_AREA,
  #   "Área - % de área (AP)" = GP_prop_AREA,
  # 
  #   "VBP - VBP/ha (AF)" = AF_VPdivAREA,
  #   "VBP - VBP/ha (MP)" = MP_VPdivAREA,
  #   "VBP - VBP/ha (AP)" = GP_VPdivAREA,
  # 
  #   #"Bolsa Família - % pop. rural c/ BF" = pct_POPrur_BF,
  # 
  #   "Ocup. - % de ocupados (AF)" = AF_prop_OCU,
  #   "Ocup. - % de ocupados (MP)" = MP_prop_OCU,
  #   "Ocup. - % de ocupados (AP)" = GP_prop_OCU,
  #   
  #   
  #   "" = TOT_AREAmedia,
  #   "" = AF_AREAmedia,
  #   "" = NAF_AREAmedia,
  #   "" = AF_prop3_REC_naoPROD,
  #   "" = MP_prop3_REC_naoPROD,
  #   "" = GP_prop3_REC_naoPROD,
  #   "" = REND_OCU_AF,
  #   "" = REND_OCU_NAF,
  #   "" = REND_OCU_MP,
  #   "" = AF_prop3_REC_PROG,
  #   "" = ,
  #   "" = ,
  #   
  #   )


# Padronização das escalas
clusterizacaoI_scale <- scale(variaveis_clusterI_3)

```


### 1.1. Número ideal de clusters

Após a normalização dos valores (com desvio padrão de 1 e média 0), uma vez que é necessário indicar previamente um número de clusters para iniciar o procedimento de clusterização das variáveis, foram verificados inicialmente três métodos diferentes para determinar o número ideal de clusters, sendo eles:
1. Método do cotovelo (Elbow method)
2. Método de silhueta (Average Silhouette Method) 
3. Método Gap (Gap Statistic Method)


```{r bTestes de tamanho de cluster I, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3}

# clusterizacaoI_scale <- variaveis_clusterI_2 %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU"))
# 
# clusterizacaoI_scale <- scale(clusterizacaoI_scale[,-c(1:4)])


# Elbow method
CLIDEAL_elbow <- fviz_nbclust(clusterizacaoI_scale, kmeans, method = "wss") +
    geom_vline(xintercept = 5, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
CLIDEAL_silhou <- fviz_nbclust(clusterizacaoI_scale, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy.
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
CLIDEAL_gap <- fviz_nbclust(clusterizacaoI_scale, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")

ggarrange(CLIDEAL_elbow, CLIDEAL_silhou, CLIDEAL_gap, nrow = 1, heights = 0.5)
```

Novamente aqui, as três análises sugeriram números ideias de clusters distintos entre si. Portanto, optou-se novamente pela alternativa a partir dos 30 índices diferentes.

```{r bbteste numero clusters I, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
nbclust_out <- NbClust::NbClust(
  data = clusterizacaoI_scale,
  distance = "euclidean",
  min.nc = 4, # minimum number of clusters
  max.nc = 8, # maximum number of clusters
  method = "kmeans" # one of: "ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid", "kmeans"
)

# # create a dataframe of the optimal number of clusters
# nbclust_plot <- data.frame(clusters = nbclust_out$Best.nc[1, ])
# # select only indices which select between 2 and 5 clusters
# nbclust_plot <- subset(nbclust_plot, clusters >= 2 & clusters <= 5)
# 
# # create plot
# ggplot(nbclust_plot) +
#   aes(x = clusters) +
#   geom_histogram(bins = 30L, fill = "#0c4c8a") +
#   labs(x = "Number of clusters", y = "Frequency among all indices", title = "Optimal number of clusters") +
#   theme_minimal()

```


Com as três variáveis que foram retiradas o número aconselhado de clusters ainda permanece como sendo, na maioria dos testes, 5 clusters. 

* 7 testes indicaram 4 como o número ideal de clusters 
* 9 testes indicaram 5 como o número ideal de clusters 
* 1 testes indicaram 6 como o número ideal de clusters 
* 5 testes indicaram 7 como o número ideal de clusters 
* 1 testes indicaram 8 como o número ideal de clusters 

Portanto, de acordo com a maioria, o melhor número de clusters, nesse caso, é 5.


```{r bCriacao dos clusters I, message=FALSE, warning=FALSE, include=FALSE}

#CLUSTERs
set.seed(123)
k4 <- kmeans(clusterizacaoI_scale, centers = 4, nstart = 150)
k5 <- kmeans(clusterizacaoI_scale, centers = 5, nstart = 150)
k6 <- kmeans(clusterizacaoI_scale, centers = 6, nstart = 150)
k7 <- kmeans(clusterizacaoI_scale, centers = 7, nstart = 150)
k8 <- kmeans(clusterizacaoI_scale, centers = 8, nstart = 150)
k9 <- kmeans(clusterizacaoI_scale, centers = 9, nstart = 150)
#print(k4)

k4graph <- fviz_cluster(k4, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 4")
k5graph <- fviz_cluster(k5, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 5")
k6graph <- fviz_cluster(k6, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 6")
k9graph <- fviz_cluster(k9, geom = "point",  data = clusterizacaoI_scale) + ggtitle("k = 9")

# Visualize silhouhette information
# library(cluster)
# #sil <- silhouette(k4$cluster, dist(clusterizacao1_scale))
# teste <- fviz_silhouette(silhouette(k9$cluster, dist(clusterizacao1_scale)))

```



```{r bManipulacao tabelas clusters I, message=FALSE, warning=FALSE, include=FALSE}

df_clusters <- variaveis_clusterI %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
  mutate(Cluster4 = k4$cluster,
         Cluster5 = k5$cluster,
         Cluster6 = k6$cluster,
         Cluster7 = k7$cluster,
         Cluster9 = k9$cluster) 
  


# df_clusters_k4_sumario <- variaveis_clusterI %>%
#   select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
#   mutate(Cluster4 = k4$cluster) %>%
#   group_by(Cluster4) %>%
#   summarise_all("mean") %>% 
#   mutate(Tamanho = k4$size) %>%
#   select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
# df_clusters_k4_centers <- as.data.frame(k4[["centers"]])


df_clusters_k5_sumario <- variaveis_clusterI %>%
  select(-c("GP_prop_NEstab", "GP_prop_AREA", "GP_prop_OCU")) %>%
  mutate(Cluster5 = k5$cluster) %>%
  group_by(Cluster5) %>%
  summarise_all("mean") %>%
  mutate(Tamanho = k5$size) #%>%
  # select(-c(NIVEL, COD, LOCALIZACAO, COD_ESTADO, COD_REGIAO))
df_clusters_k5_centers <- as.data.frame(k5[["centers"]])



```




### 1.2. Sumário das médias das microrregiões para cada um dos clusters calculados

```{r btabela sumario I, echo=FALSE, message=FALSE, warning=FALSE, results = "asis"}

df_clusters_k5_sumarioSCALES <- df_clusters_k5_sumario %>%
  mutate(AF_prop_NEstab = scales::percent(round(AF_prop_NEstab, 2), big.mark = ".",  decimal.mark = "," , na.rm = TRUE),
         MP_prop_NEstab = scales::percent(round(MP_prop_NEstab, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         
         TOT_AREAmedia = paste(format(round(TOT_AREAmedia), decimal.mark=",", big.mark = "."), "ha"),
         AF_AREAmedia = paste(format(round(AF_AREAmedia), decimal.mark=",", big.mark = "."), "ha"),
         NAF_AREAmedia = paste(format(round(NAF_AREAmedia), decimal.mark=",", big.mark = "."), "ha"),

         AF_prop_AREA = scales::percent(round(AF_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_AREA = scales::percent(round(MP_prop_AREA, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),

         AF_VPdivAREA = paste("R$", format(round(AF_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         MP_VPdivAREA = paste("R$", format(round(MP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),
         GP_VPdivAREA = paste("R$", format(round(GP_VPdivAREA), decimal.mark=",", big.mark = "."), "/ha"),

         AF_prop_OCU = scales::percent(round(AF_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop_OCU = scales::percent(round(MP_prop_OCU, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
    
         AF_prop3_REC_naoPROD = scales::percent(round(AF_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         MP_prop3_REC_naoPROD = scales::percent(round(MP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         GP_prop3_REC_naoPROD = scales::percent(round(GP_prop3_REC_naoPROD, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE),
         
         REND_OCU_AF = paste("R$", format(round(REND_OCU_AF), decimal.mark=",", big.mark = "."), "/ocup."),
         REND_OCU_MP = paste("R$", format(round(REND_OCU_MP), decimal.mark=",", big.mark = "."), "/ocup."),
         REND_OCU_NAF = paste("R$", format(round(REND_OCU_NAF), decimal.mark=",", big.mark = "."), "/ocup."),
         
         AF_prop3_REC_PROG = scales::percent(round(AF_prop3_REC_PROG, 2), big.mark = ".",  decimal.mark = ",", na.rm = TRUE)
        ) %>%
  
  
  rename(
    "% de estab. (AF)" = AF_prop_NEstab,
    "% de estab. (MP)" = MP_prop_NEstab,

    "Área média dos estab." = TOT_AREAmedia,
    "Área média dos estab. (AF)" = AF_AREAmedia,
    "Área média dos estab. (AP)" = NAF_AREAmedia,
    "% de área (AF)" = AF_prop_AREA,
    "% de área (MP)" = MP_prop_AREA,

    "VBP/ha (AF)" = AF_VPdivAREA,
    "VBP/ha (MP)" = MP_VPdivAREA,
    "VBP/ha (AP)" = GP_VPdivAREA,

    "% de ocupados (AF)" = AF_prop_OCU,
    "% de ocupados (MP)" = MP_prop_OCU,
    
    "Rendimento por ocupado (AF)" = REND_OCU_AF,
    "Rendimento por ocupado (AP)" = REND_OCU_NAF,
    "Rendimento por ocupado (MP)" = REND_OCU_MP,
    
    "% rendimentos não agrícolas (AF)" = AF_prop3_REC_naoPROD,
    "% rendimentos não agrícolas (MP)" = MP_prop3_REC_naoPROD,
    "% rendimentos não agrícolas (AP)" = GP_prop3_REC_naoPROD,
    "% rendimentos de prog. e pol. (AF)" = AF_prop3_REC_PROG,
    
    "Nº total de microrregiões" = Tamanho
    )

  

df_clusters_k5_sumarioPLOT <-
  as.data.frame(t(df_clusters_k5_sumarioSCALES)) %>%
  rename("CL 1" = 1,
         "CL 2" = 2,
         "CL 3" = 3,
         "CL 4" = 4,
         "CL 5" = 5) %>%
  slice(-c(1:6))

df_clusters_k5_sumarioPLOT <- df_clusters_k5_sumarioPLOT %>%
rownames_to_column(var = "Médias das microrregiões")

kbl(df_clusters_k5_sumarioPLOT, digits = 2, 
    caption = "", align = "lccccc",
    format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_paper("basic", full_width = F) %>%
  pack_rows("Estabelecimentos", 1, 2) %>%
  pack_rows("Área", 3, 7) %>%
  pack_rows("VBP", 8, 10) %>%
  pack_rows("Pessoal ocupado", 11, 12) %>%
  pack_rows("Rendimentos", 13, 19)
  

```

### 1.3. Descrição dos clusters

**Cluster 1**

- Estabelecimentos
	+ Segunda menor média de estabelecimentos da AF, mas ainda assim acima de 50% como em todos os demais clusters
	+ Segunda maior média de estabelecimentos beneficiários do Pronamp (34%)
	
- Área
	+ Estabelecimentos com maior média de área (6x maior do que o cluster com o segundo valor mais alto)
	+ Tanto na agricultura familiar quanto na não-familiar/patronal os estabelecimentos são muito maiores do que em todos os demais clusters
	+ Agricultura familiar possui baixíssima expressão nas microrregiões, com apenas em média 7% da área de estabelecimentos agropecuários sendo dessa tipologia
	+ Em média, metade da área desse cluster é ocupada por estabelecimentos de beneficiários do Pronamp
	
- VBP
	+ AF possui o menor VBP/ha dentre todos os outros clusters considerando a mesma tipologia
	+ Apesar dos estabelecimentos não-familiares terem o maior VBP/ha dentre todos os não familiares (com pouca diferença do cluster 5), esse VBP/ha ainda é muito inferior ao maior dentre todas as categorias (que pertence à AF no cluster 2)
- Pessoal ocupado
	+ Em média pouco mais da metade do pessoal ocupado está alocado em estabelecimentos não familiares

- Rendimentos 
	+ Nos estabelecimentos da AF, em média 8% dos rendimentos não são de atividades agropecuárias; apesar de baixo, é a maior média dentre os estabelecimentos da AF
	+ Nos estabelecimentos patronais, em média 9% dos rendimentos não são de atividades agropecuárias, mas diferentemente da AF, essa é a porcentagem mais baixa, dentre os patronais nos 5 clusters
	+ Nos estabelecimentos patronais o valor da produção por pessoa ocupada é, com larga margem, o mais alto de todos (a hipótese, a partir da localização do cluster, é que isso deve se dar tanto pelo baixo número de pessoas ocupadas nos estabelecimentos, quanto pelo alto rendimento bruto da produção)


**Cluster 2**

- Estabelecimentos
	+ Maior porcentagem de área ocupada pela agricultura familiar (em média, 83%)
	+ Estabelecimentos do Pronamp com apenas 18% (menor porcentagem, empatado com o CL3)
	
- Área
	+ Menor área média dos estabelecimentos tanto familiares quanto não familiares 
	+ Microrregiões em média equilibradas em termos de área ocupada pelos estabelecimentos, com 46% da AF e 54% da não familiar (equilíbrio similar ao do cluster3)
	
- VBP
	+ O VBP/ha é o destaque desse cluster: especificamente na AF ele tem o valor 5x maior do que na não familiar, sendo o maior dentre todos os clusters e tipologias
	
- Pessoal ocupado
	+ Assim como no cluster 3 e 5, esse possui em média mais da metade das pessoas ocupadas na AF, sendo nesse cluster o segundo valor mais alto (74%)
	
- Rendimentos 
	+ Em média, os rendimentos não agrícolar ocupam a menor porcentagem da renda da AF dentre todos os clusters, com apenas 4%. Nos estabelecimentos não familiares, o valor sobe para 10%, baixo quando em comparação com os clusters 3 e 5, mas alto quanto em comparação com a AF
	+ O rendimento por pessoa ocupada fica com o valor mais alto na AF, empatado com o cluster 4, e não tão distante do cluster 1


**Cluster 3**

- Estabelecimentos
	+ Estabelecimentos da AF são vasta maioria em número (82%)
	
- Área
	+ Estabelecimentos tanto da AF quando da AP com área média inferior a dos demais clusters
	+ Porcentagem de área ocupada pela AF equivalente a quase 50%, em média
	
- VBP
	+ VBP/ha baixo para a AF, apenas maior do que o do cluster 1
	+ Menor VBP/ha na AP dentre todos os clusters em estabelecimentos da mesma tipologia
	
- Pessoal ocupado
	+ Maior porcentagem de ocupados na AF (cerca de 78%) 
	
- Rendimentos 
	+ Média mais alta de porcentagem da renda composta por rendimentos não agrícolas nos estabelecimentos não familiares (35%), mas o valor alto não se repete para a AF
	+ Menor rendimento por pessoal ocupado tanto na AF quando na AP
	+ Cluster com maior média de renda nos estabelecimentos composta por programas e políticas


**Cluster 4**

- Estabelecimentos
	+ Porcentagem de estabelecimentos da AF similar ao cluster 1, ainda são maioria em número, mas com valor menor que nos clusters 2, 3 e 
	
- Área
	+ Área média dos estabelecimentos tanto para a AF quanto para a AP com valores altos, apenas não ultrapassando as médias do cluster 1 
	+ Porcentagem baixa de área ocupada por estabelecimentos da AF, com 14% (apenas superior ao cluster 1, com 7%)
	
- VBP
	+ Segundo VBP/ha da AF mais alto (apenas abaixo do cluster 2)
	+ VBP/ha da AP mediano quando comparado com a mesma tipologia nos demais clusters, mas 4x menor que na AF do mesmo cluster
	
- Pessoal ocupado
	+ Em média, a maior parte dos ocupados estão em estabelecimentos não familiares (59%)
	
- Rendimentos 
	+ Porcentagem de rendimentos não agrícolas medianos quando em comparação com os demais clusters tanto para a AF quanto para a AP
	+ Segundo maior rendimento por pessoal ocupado na AP (apesar de ainda ser metade do mais alto, no cluster 1)
	+ Rendimento por pessoal ocupado alto, tanto quanto no cluster 2, para a AF 


**Cluster 5**

- Estabelecimentos
	+ Maior número de estabelecimentos da AF do que da AP, assim como todos os demais clusters
	
- Área
	+ AF ocupa uma porcentagem baixa da área (27% em média), maior apenas que o cluster 1
	+ Estabelecimentos da AF de tamanho mediano quando comparado com as demais
	
- VBP
	+ VBP/ha mediano na AF
	+ VBP/ha alto na AP quando comparado com a mesma tipologia nos demais clusters, mas ligeiramente menor do que na AF no cluster
	
- Pessoal ocupado
	+ Maior parcela dos ocupados estão em estabelecimentos da AF, apesar de não ser um dos valores mais altos 
	
- Rendimentos 
	+ Valor médio para participação dos rendimentos não agrícolas na renda da AF, mas segundo valor mais alto na renda dos não familiares (menor apenas que o cluster 3)
	+ Segundo maior valor médio da porcentagem das rendas compostas por programas e políticas 


<br>

### 1.4. Representação espacial dos clusters

```{r bCODmapas PREPARACAO I, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}

SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
st_crs(SHP_Microrregioes)
tmap_mode("view")
# tmap_mode("plot") #> tmap mode set to plotting
# Mudando o nome pra ficar igual ao da tabela
names(SHP_Microrregioes)[1] <- "COD"


# Juntando o shape e a tabela
SHP_clusters <- SHP_Microrregioes %>%
  left_join(., df_clusters, by = "COD")


# A ser usado na hora de gerar o mapa
margens <- list(b = 50, t = 115)

# make some bbox magic
bbox_new <- st_bbox(SHP_clusters) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

 bbox_new[1] <- bbox_new[1] - (0.12 * xrange) # xmin - left
# bbox_new[3] <- bbox_new[3] + (0.1 * xrange) # xmax - right (aumenta a direita)
 bbox_new[2] <- bbox_new[2] - (0.50 * yrange) # ymin - bottom
#bbox_new[4] <- bbox_new[4] + (0.1 * yrange) # ymax - top (aumenta em cima)

bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon



##### mapa

# tm_AF_VPdivAREA <- 
# microrregioes_VPha_shape[!is.na(microrregioes_VPha_shape$VPdivAREA),] %>%
#   filter(VPdivAREA >= 0) %>%
#   filter(TIPOLOGIA == "AF") %>%
#   tm_shape(bbox = bbox_new) +
#   tm_fill(col = "VPdivAREA", 
#           title = "Valor da produção por hectare (VP/ha)<br/>- AF", 
#           id = "LOCALIZACAO", palette="BuGn",
#           legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
#           style = "fixed", breaks = c(35, 500, 1500, 3500, 16000)) +
#   tm_borders(lwd = 0.2) +
#   #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
#   tm_view(view.legend.position = c("right", "bottom")) +
#   tm_shape(SHP_Estados) +
#   tm_borders(lwd = 1) 


```

<br>


```{r bMapeando os clusters I, echo=FALSE, message=FALSE, warning=FALSE}
cores <- c("#beaed4", "#386cb0", "#fdc086", "#7fc97f", "#ffff99")

SHP_clusters %>%
  filter(!is.na(Cluster5)) %>%

  tm_shape() +
  tm_fill(col = "Cluster5", 
          title = "Clusters (n=5)", 
          id = "LOCALIZACAO", palette=cores,
          #n=7
          #legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"))),
          style = "cat") +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1)

```


<br> 
<br>
<br>



# Mapas individuais extras

## Pobreza rural

<!-- Prevalência da pobreza rural -->

```{r cMAPAS_CADUNICO, message=FALSE, warning=FALSE, include=FALSE}
# Juntando o shape e a tabela
SHP_CADUNICO <- SHP_Microrregioes %>%
  left_join(., CADUNICO_POP, by = c("COD" = "COD_MICRO"))
```

**Porcentagem de residentes de áreas rurais da microrregião que são beneficiários do bolsa família (2017)**

```{r cMAPAS_CADUNICO2, echo=FALSE, message=FALSE, warning=FALSE}

### Mobilidade de rendimentos por residentes de 2006 para 2017

cores_spectral <- c("#2b83ba", "#abdda4", "#ffffbf", "#fdae61", "#d7191c") 

SHP_CADUNICO %>%
  filter(!is.na(pct_POPrur_BF)) %>%
  tm_shape() +
  tm_fill(col = "pct_POPrur_BF", 
          palette = cores_spectral,
          title = "% de residentes na zona<br>rural que recebem BF (2017)",
          id = "LOCALIZACAO",
          #n=7
          legend.format=list(fun=function(x) paste0(round(x*100), "%")),
          style = "fisher" 
          #breaks = c(50, 85, 170, 340, 680, 1500, 5000, 10000, 40000)
          ) +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1) 



```

<br>
<br>
<br>

## Variação de ocupados nos estabelecimentos


### Todos os estabelecimentos

```{r bCODmapas PREPARACAO II, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Juntando o shape e a tabela
SHP_mapasfinais <- SHP_Microrregioes %>%
  full_join(., microrregioes_pct, by = "COD")
```

**Diferença percentual de ocupados nos estabelecimentos de 2006 para 2017**

```{r OCUPADOS_DIF, echo=FALSE, message=FALSE, warning=FALSE}
palete4 <- c("#b2182b", "#ef8a62", "#fddbc7", "#c7eae5", "#80cdc1", "#01665e")

SHP_mapasfinais %>%
  mutate(Dif_OCU_T = Dif_OCU_T * 100) %>%
  filter(!is.na(LOCALIZACAO)) %>%
  tm_shape() +
  tm_fill(col = "Dif_OCU_T", 
          title = "Diferença percentual de ocupados<br>nos estabelecimentos (2006/2017)", 
          id = "LOCALIZACAO", palette=palete4,
          #n=7
          legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"), "%")),
          style = "fixed",
          breaks = c(-75, -50, -5, 5, 50, 100, 270)
          ) +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1) 

```

<br>

### Estabelecimentos da AF

**Diferença percentual de ocupados nos estabelecimentos de 2006 para 2017 na AF**

```{r OCUPADOS_DIF_AF, echo=FALSE, message=FALSE, warning=FALSE}
palete4 <- c("#b2182b", "#ef8a62", "#fddbc7", "#c7eae5", "#80cdc1", "#01665e")

SHP_mapasfinais %>%
  mutate(Dif_OCU_AF = Dif_OCU_AF * 100) %>%
  filter(!is.na(LOCALIZACAO)) %>%
  filter(!is.na(Dif_OCU_AF)) %>%
  tm_shape() +
  tm_fill(col = "Dif_OCU_AF", 
          title = "Diferença percentual de ocupados<br>nos estabelecimentos da AF (2006/2017)", 
          id = "LOCALIZACAO", palette=palete4,
          #n=7
          legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = " ", format="f"), "%")),
          style = "fixed",
          breaks = c(-100, -50, -5, 5, 50, 100, 400)
          ) +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1) 

```

<br>
<br>
<br>

## Variação dos rendimentos por ocupados

### Todos os estabelecimentos 

*Para garantir a comparação entre valores, os rendimentos de 2006 foram corrigidos de acordo com a inflação do período correspondente (IGP-M).

*Diferença percentual de rendimentos totais dos estabelecimentos por ocupados nos estabelecimentos de 2006 para 2017 *
```{r MAPAS_DifPercent_RENDA, echo=FALSE, message=FALSE, warning=FALSE}
### Diferença percentual de rendimentos totais dos estabelecimentos 

palete3 <- c("#b2182b", "#ef8a62", "#fddbc7", "#c7eae5", "#80cdc1", "#01665e")

#Total
SHP_mapasfinais %>%
  mutate(Dif_REND_OCU_T = Dif_REND_OCU_T * 100) %>%
  filter(!is.na(LOCALIZACAO)) %>%
  tm_shape() +
  tm_fill(col = "Dif_REND_OCU_T", 
          title = "Alteração percentual nos rendimentos por<br>ocupados nos estab. de 2006* para 2017", 
          id = "LOCALIZACAO", palette=palete3,
          #n=7
          legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = ".", format="f"), "%")),
          style = "fixed", 
          breaks = c(-200, -50, -5, 5, 100, 500, 1000)
          ) +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1) 

```

<br>

### Estabelecimentos da AF
*Diferença percentual de rendimentos totais da AF por ocupados nos estabelecimentos de 2006 para 2017 *
```{r MAPAS_DifPercent_RENDA_AF, echo=FALSE, message=FALSE, warning=FALSE}
### Diferença percentual de rendimentos totais dos estabelecimentos 

palete3 <- c("#b2182b", "#ef8a62", "#fddbc7", "#c7eae5", "#80cdc1", "#01665e")

#Total
SHP_mapasfinais %>%
  mutate(Dif_REND_OCU_AF = Dif_REND_OCU_AF * 100) %>%
  filter(!is.na(LOCALIZACAO)) %>%
  filter(!is.na(Dif_REND_OCU_AF)) %>%
  tm_shape() +
  tm_fill(col = "Dif_REND_OCU_AF", 
          title = "Alteração percentual nos<br>rendimentos por ocupados nos<br>estab. da AF de 2006* para 2017", 
          id = "LOCALIZACAO", palette=palete3,
          #n=7
          legend.format=list(fun=function(x) paste0(formatC(x, digits=0, big.mark = ".", format="f"), "%")),
          style = "fixed", 
          breaks = c(-200, -50, -5, 5, 100, 500, 1000)
          ) +
  tm_borders(lwd = 0.2) +
  #tm_facets(by = "TIPOLOGIA", nrow = 1, sync = TRUE, free.coords = TRUE) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_borders(lwd = 1) 

```

<br>
<br>

## [pendente] Variação da pobreza


























