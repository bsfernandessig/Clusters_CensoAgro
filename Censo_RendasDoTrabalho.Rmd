---
title: "Censo Agro - Comparação de rendas do trabalho"
output:
  html_document:
    toc: true
    toc_depth: 4 
    toc_float: 
      collapsed: false
    theme: flatly  
---


```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```


```{r Pacotes, message=FALSE, warning=FALSE, include=FALSE}
#pacotes

#install.packages(c("ggthemes", "ggpubr", "readr", "readxl", "rstatix", "sp", "sf", "tmap", "leaflet", "arsenal", "knitr", "plotly", "kableExtra", "prettydoc", "rmdformats", "knitr", "scales", "esquisse", "pacman"))

#install.packages(c(	"broom", "cli", "crayon" , "dbplyr", "dplyr", "forcats", "ggplot2", "haven", "hms", "httr", "jsonlite", "lubridate", "magrittr", "modelr", "pillar", "purrr", "readr", "readxl", "reprex", "rlang", "rstudioapi", "rvest", "stringr", "tibble", "tidyr", "xml2", "corrplot"))

##install.packages("factoextra")
##install.packages("qwraps2")

pacman::p_load(ggthemes, ggpubr, tidyverse, readr, readxl, esquisse, rstatix, sp, sf, tmap, leaflet, arsenal, knitr, plotly, kableExtra, prettydoc, rmdformats, knitr, scales, broom, cli, crayon , dbplyr, dplyr, forcats, ggplot2, haven, hms, httr, jsonlite, lubridate, magrittr, modelr, pillar, purrr, readr, readxl, reprex, rlang, rstudioapi, rvest, stringr, tibble, tidyr, xml2, factoextra, qwraps2, corrplot) 


options(scipen=999)

```



```{r COD_Tabelas, message=FALSE, warning=FALSE, include=FALSE}
TABELA2 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6878_MUN_areaestabelecimentos+niveis.xlsx", na = "X") 
TABELA2$COD[TABELA2$NIVEL == "BR"] <- 000


TABELA6 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6898_MUN_valordaproducao+niveis.xlsx", na = "X") 
TABELA6$COD[TABELA6$NIVEL == "BR"] <- 000
TABELA6 <- TABELA6 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA8 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6901_MUN_valorreceitas+niveis.xlsx", na = "X") 
TABELA8$COD[TABELA8$NIVEL == "BR"] <- 000
TABELA8 <- TABELA8 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA9 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6882_MUN_areapreservacao+niveis.xlsx", na = "X") 
TABELA9$COD[TABELA9$NIVEL == "BR"] <- 000
TABELA9 <- TABELA9 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA10 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6788_MUN_totalestabelecimentos+niveis.xlsx", na = "X") 
TABELA10$COD[TABELA10$NIVEL == "BR"] <- 000
TABELA10 <- TABELA10 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

```


```{r COD_Procedimentos com as tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### PROCEDIMENTOS COM AS TABELAS -----------------

#Join de todas as tabelas 
todastabelas <- TABELA2 %>% 
  left_join(., TABELA6, by = "COD") %>%
  left_join(., TABELA8, by = "COD") %>%
  left_join(., TABELA9, by = "COD") %>%
  left_join(., TABELA10, by = "COD") %>%
  mutate_if(is.numeric , replace_na, replace = 0)


#Filtragem por recorte geográfico

municipios <- todastabelas %>% filter(NIVEL == "MU")
microrregioes <- todastabelas %>% filter(NIVEL == "MI")
mesorregioes <- todastabelas %>% filter(NIVEL == "ME")
estados <- todastabelas %>% filter(NIVEL == "UF")
macrorregioes <- todastabelas %>% filter(NIVEL == "GR")
brasil <- todastabelas %>% filter(NIVEL == "BR")


#Criando colunas de código do estado e da região - MUNICIPIOS
municipios <- municipios %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
municipios$COD_ESTADO <- substr(municipios$COD_ESTADO, 0, 2)
municipios$COD_REGIAO <- substr(municipios$COD_REGIAO, 0, 1)
municipios$COD_REGIAO[municipios$COD_REGIAO == "1"] <- "Norte"
municipios$COD_REGIAO[municipios$COD_REGIAO == "2"] <- "Nordeste"
municipios$COD_REGIAO[municipios$COD_REGIAO == "3"] <- "Sudeste"
municipios$COD_REGIAO[municipios$COD_REGIAO == "4"] <- "Sul"
municipios$COD_REGIAO[municipios$COD_REGIAO == "5"] <- "Centro-Oeste"

#Criando colunas de código do estado e da região - MICRORREGIOES
microrregioes <- microrregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
microrregioes$COD_ESTADO <- substr(microrregioes$COD_ESTADO, 0, 2)
microrregioes$COD_REGIAO <- substr(microrregioes$COD_REGIAO, 0, 1)
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "1"] <- "Norte"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "2"] <- "Nordeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "3"] <- "Sudeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "4"] <- "Sul"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "5"] <- "Centro-Oeste"


mesorregioes <- mesorregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
mesorregioes$COD_ESTADO <- substr(mesorregioes$COD_ESTADO, 0, 2)
mesorregioes$COD_REGIAO <- substr(mesorregioes$COD_REGIAO, 0, 1)

```

# Introdução

O presente documento tem como objetivo comparar as rendas da Agricultura Familiar obtidas pelo trabalho com a média das rendas obtidas pelo conjunto total dos estabelecimentos agropecuários no país.

A variável utilizada tem como origem o Censo Agropecuário de 2017, tendo como nome "valor das receitas ou rendas obtidas pelos estabelecimentos agropecuários (Mil Reais)".

<br>

**Rendas/receitas consideradas**

- Receitas da produção do estabelecimento - produtos vegetais
- Receitas da produção do estabelecimento - animais e seus produtos
- Receitas da produção do estabelecimento - Produtos da agroindústria
- Outras receitas do estabelecimento - desinvestimentos
- Outras receitas do estabelecimento - serviço de turismo rural
- Outras receitas do estabelecimento - exploração mineral
- Outras receitas do estabelecimento - atividade de artesanato, tecelagem, etc.
- Outras receitas do estabelecimento - outras receitas do estabelecimento
- Outras receitas do produtor - rendas obtidas em atividades fora do estabelecimento

**Rendas/receitas descartadas**

- Outras receitas do produtor - recursos de aposentadorias ou pensões
- Outras receitas do produtor - recebimento de prêmio de Programa Garantia Safra
- Outras receitas do produtor - recebimento de prêmio de Programa Garantia da Atividade Agropecuária da Agricultura Familiar - PROAGRO Mais
- Outras receitas do produtor - recebimento do Programa Nacional de Habitação Rural Minha Casa Minha Vida
- Outras receitas do produtor - recebimento de pagamento por serviços ambientais (Bolsa Verde e Programas Estaduais)
- Outras receitas do produtor - provenientes de programas dos Governos (federal, estadual ou municipal)


```{r COD_Novas colunas, message=FALSE, warning=FALSE, include=FALSE}

#### Microrregiões ####

municipios <- municipios %>%
  mutate(PAIS = "Brasil") %>%
  group_by(NIVEL, COD, LOCALIZACAO, PAIS, COD_ESTADO, COD_REGIAO) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    .keep = "used"
  )

media_estadoMUN <- municipios %>%
  group_by(COD_ESTADO) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    # RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    # RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
  ) %>%
  summarise(
    REN_ESTD_mean_T = mean(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_ESTD_TRABALHO_mean_T = mean(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_ESTD_mean_AF = mean(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENDAporESTAB_TRABALHO_mean_AF = mean(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE),
    
    REN_ESTD_median_T = median(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_ESTD_TRABALHO_median_T = median(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_ESTD_median_AF = median(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENDAporESTAB_TRABALHO_median_AF = median(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE)
  )

media_regiaoMUN <- municipios %>%
  group_by(COD_REGIAO) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    # RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    # RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
  ) %>%
  summarise(
    REN_REG_mean_T = mean(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_REG_TRABALHO_mean_T = mean(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_REG_mean_AF = mean(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_REG_TRABALHO_mean_AF = mean(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE),
    
    REN_REG_median_T = median(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_REG_TRABALHO_median_T = median(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_REG_median_AF = median(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_REG_TRABALHO_median_AF = median(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE)
  )


media_brasilMUN <- municipios %>%
  mutate(PAIS = "Brasil") %>%
  group_by(PAIS) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    # RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    # RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
  ) %>%
  summarise(
    REN_BRA_mean_T = mean(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_mean_T = mean(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_BRA_mean_AF = mean(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_mean_AF = mean(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE),
    
    REN_BRA_median_T = median(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_median_T = median(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_BRA_median_AF = median(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_median_AF = median(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE)
  )

municipios_all <- municipios %>%
  left_join(., media_brasilMUN, by = "PAIS") %>%
  left_join(., media_regiaoMUN, by = "COD_REGIAO") %>%
  left_join(., media_estadoMUN, by = "COD_ESTADO")

#### Microrregiões ####

microrregioes <- microrregioes %>%
  mutate(PAIS = "Brasil") %>%
  group_by(NIVEL, COD, LOCALIZACAO, PAIS, COD_ESTADO, COD_REGIAO) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    .keep = "used"
  )

media_estadoMIC <- microrregioes %>%
  group_by(COD_ESTADO) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
  ) %>%
  summarise(
    REN_ESTD_mean_T = mean(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_ESTD_TRABALHO_mean_T = mean(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_ESTD_mean_AF = mean(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENDAporESTAB_TRABALHO_mean_AF = mean(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE),
    
    REN_ESTD_median_T = median(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_ESTD_TRABALHO_median_T = median(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_ESTD_median_AF = median(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENDAporESTAB_TRABALHO_median_AF = median(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE)
  )

media_regiaoMIC <- microrregioes %>%
  group_by(COD_REGIAO) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
  ) %>%
  summarise(
    REN_REG_mean_T = mean(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_REG_TRABALHO_mean_T = mean(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_REG_mean_AF = mean(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_REG_TRABALHO_mean_AF = mean(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE),
    
    REN_REG_median_T = median(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_REG_TRABALHO_median_T = median(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_REG_median_AF = median(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_REG_TRABALHO_median_AF = median(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE)
  )

media_brasilMIC <- microrregioes %>%
  mutate(PAIS = "Brasil") %>%
  group_by(PAIS) %>%
  mutate(
    RENDA_TRABALHO_T = (R_VALOR_T_1 + R_VALOR_T_2 + R_VALOR_T_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_T = (RENDA_TRABALHO_T / NEST_T), #rendimentos totais do trabalho, pelo número total de estabelecimentos
    RENDA_TRABALHO_AF = (R_VALOR_AF_1 + R_VALOR_AF_2 + R_VALOR_AF_302),  #rendimentos totais do trabalho
    RENDAporESTAB_TRABALHO_AF = (RENDA_TRABALHO_AF / NEST_AF), #rendimentos totais do trabalho, pelo número total de estabelecimentos
  ) %>%
  summarise(
    REN_BRA_mean_T = mean(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_mean_T = mean(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_BRA_mean_AF = mean(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_mean_AF = mean(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE),
    
    REN_BRA_median_T = median(RENDA_TRABALHO_T, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_median_T = median(RENDAporESTAB_TRABALHO_T, na.rm = TRUE),
    REN_BRA_median_AF = median(RENDA_TRABALHO_AF, na.rm = TRUE),
    # RENEST_BRA_TRABALHO_median_AF = median(RENDAporESTAB_TRABALHO_AF, na.rm = TRUE)
  )


microrregioes_all <- microrregioes %>%
  left_join(., media_brasilMIC, by = "PAIS") %>%
  left_join(., media_regiaoMIC, by = "COD_REGIAO") %>%
  left_join(., media_estadoMIC, by = "COD_ESTADO") 

```



```{r CALCULO_CLASSIFICACOES, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}
municipios_class <- municipios_all %>%
  mutate(classREN_BRA_mean_T = case_when(RENDA_TRABALHO_T >= REN_BRA_mean_T ~ "Acima da média do país",
                                         RENDA_TRABALHO_T < REN_BRA_mean_T ~ "Abaixo da média do país"),
         classREN_BRA_mean_AFAF = case_when(RENDA_TRABALHO_AF >= REN_BRA_mean_AF ~ "Acima da média do país",
                                         RENDA_TRABALHO_AF < REN_BRA_mean_AF ~ "Abaixo da média do país"),
         classREN_BRA_mean_AFT = case_when(RENDA_TRABALHO_AF >= REN_BRA_mean_T ~ "Acima da média do país",
                                         RENDA_TRABALHO_AF < REN_BRA_mean_T ~ "Abaixo da média do país"),
         
         classREN_BRA_median_T = case_when(RENDA_TRABALHO_T >= REN_BRA_median_T ~ "Acima da mediana do país",
                                         RENDA_TRABALHO_T < REN_BRA_median_T ~ "Abaixo da mediana do país"),
         classREN_BRA_median_AFAF = case_when(RENDA_TRABALHO_AF >= REN_BRA_median_AF ~ "Acima da mediana do país",
                                         RENDA_TRABALHO_AF < REN_BRA_median_AF ~ "Abaixo da mediana do país"),
         classREN_BRA_median_AFT = case_when(RENDA_TRABALHO_AF >= REN_BRA_median_T ~ "Acima da mediana do país",
                                         RENDA_TRABALHO_AF < REN_BRA_median_T ~ "Abaixo da mediana do país"),
         
         
         classREN_REG_mean_T = case_when(RENDA_TRABALHO_T >= REN_REG_mean_T ~ "Acima da média da região",
                                         RENDA_TRABALHO_T < REN_REG_mean_T ~ "Abaixo da média da região"),
         classREN_REG_mean_AFAF = case_when(RENDA_TRABALHO_AF >= REN_REG_mean_AF ~ "Acima da média da região",
                                         RENDA_TRABALHO_AF < REN_REG_mean_AF ~ "Abaixo da média da região"),
         classREN_REG_mean_AFT = case_when(RENDA_TRABALHO_AF >= REN_REG_mean_T ~ "Acima da média da região",
                                         RENDA_TRABALHO_AF < REN_REG_mean_T ~ "Abaixo da média da região"),
         
         classREN_REG_median_T = case_when(RENDA_TRABALHO_T >= REN_REG_median_T ~ "Acima da mediana da região",
                                         RENDA_TRABALHO_T < REN_REG_median_T ~ "Abaixo da mediana da região"),
         classREN_REG_median_AFAF = case_when(RENDA_TRABALHO_AF >= REN_REG_median_AF ~ "Acima da mediana da região",
                                         RENDA_TRABALHO_AF < REN_REG_median_AF ~ "Abaixo da mediana da região"),
         classREN_REG_median_AFT = case_when(RENDA_TRABALHO_AF >= REN_REG_median_T ~ "Acima da mediana da região",
                                         RENDA_TRABALHO_AF < REN_REG_median_T ~ "Abaixo da mediana da região"),
         
         
         classREN_ESTD_mean_T = case_when(RENDA_TRABALHO_T >= REN_ESTD_mean_T ~ "Acima da média do estado",
                                         RENDA_TRABALHO_T < REN_ESTD_mean_T ~ "Abaixo da média do estado"),
         classREN_ESTD_mean_AFAF = case_when(RENDA_TRABALHO_AF >= REN_ESTD_mean_AF ~ "Acima da média do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_mean_AF ~ "Abaixo da média do estado"),
         classREN_ESTD_mean_AFT = case_when(RENDA_TRABALHO_AF >= REN_ESTD_mean_T ~ "Acima da média do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_mean_T ~ "Abaixo da média do estado"),
         
         classREN_ESTD_median_T = case_when(RENDA_TRABALHO_T >= REN_ESTD_median_T ~ "Acima da mediana do estado",
                                         RENDA_TRABALHO_T < REN_ESTD_median_T ~ "Abaixo da mediana do estado"),
         classREN_ESTD_median_AFAF = case_when(RENDA_TRABALHO_AF >= REN_ESTD_median_AF ~ "Acima da mediana do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_median_AF ~ "Abaixo da mediana do estado"),
         classREN_ESTD_median_AFT = case_when(RENDA_TRABALHO_AF >= REN_ESTD_median_T ~ "Acima da mediana do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_median_T ~ "Abaixo da mediana do estado")
         )


microrregioes_class <- microrregioes_all %>%
  mutate(classREN_BRA_mean_T = case_when(RENDA_TRABALHO_T >= REN_BRA_mean_T ~ "Acima da média do país",
                                         RENDA_TRABALHO_T < REN_BRA_mean_T ~ "Abaixo da média do país"),
         classREN_BRA_mean_AFAF = case_when(RENDA_TRABALHO_AF >= REN_BRA_mean_AF ~ "Acima da média do país",
                                         RENDA_TRABALHO_AF < REN_BRA_mean_AF ~ "Abaixo da média do país"),
         classREN_BRA_mean_AFT = case_when(RENDA_TRABALHO_AF >= REN_BRA_mean_T ~ "Acima da média do país",
                                         RENDA_TRABALHO_AF < REN_BRA_mean_T ~ "Abaixo da média do país"),
         
         classREN_BRA_median_T = case_when(RENDA_TRABALHO_T >= REN_BRA_median_T ~ "Acima da mediana do país",
                                         RENDA_TRABALHO_T < REN_BRA_median_T ~ "Abaixo da mediana do país"),
         classREN_BRA_median_AFAF = case_when(RENDA_TRABALHO_AF >= REN_BRA_median_AF ~ "Acima da mediana do país",
                                         RENDA_TRABALHO_AF < REN_BRA_median_AF ~ "Abaixo da mediana do país"),
         classREN_BRA_median_AFT = case_when(RENDA_TRABALHO_AF >= REN_BRA_median_T ~ "Acima da mediana do país",
                                         RENDA_TRABALHO_AF < REN_BRA_median_T ~ "Abaixo da mediana do país"),
         
         
         classREN_REG_mean_T = case_when(RENDA_TRABALHO_T >= REN_REG_mean_T ~ "Acima da média da região",
                                         RENDA_TRABALHO_T < REN_REG_mean_T ~ "Abaixo da média da região"),
         classREN_REG_mean_AFAF = case_when(RENDA_TRABALHO_AF >= REN_REG_mean_AF ~ "Acima da média da região",
                                         RENDA_TRABALHO_AF < REN_REG_mean_AF ~ "Abaixo da média da região"),
         classREN_REG_mean_AFT = case_when(RENDA_TRABALHO_AF >= REN_REG_mean_T ~ "Acima da média da região",
                                         RENDA_TRABALHO_AF < REN_REG_mean_T ~ "Abaixo da média da região"),
         
         classREN_REG_median_T = case_when(RENDA_TRABALHO_T >= REN_REG_median_T ~ "Acima da mediana da região",
                                         RENDA_TRABALHO_T < REN_REG_median_T ~ "Abaixo da mediana da região"),
         classREN_REG_median_AFAF = case_when(RENDA_TRABALHO_AF >= REN_REG_median_AF ~ "Acima da mediana da região",
                                         RENDA_TRABALHO_AF < REN_REG_median_AF ~ "Abaixo da mediana da região"),
         classREN_REG_median_AFT = case_when(RENDA_TRABALHO_AF >= REN_REG_median_T ~ "Acima da mediana da região",
                                         RENDA_TRABALHO_AF < REN_REG_median_T ~ "Abaixo da mediana da região"),
         
         
         classREN_ESTD_mean_T = case_when(RENDA_TRABALHO_T >= REN_ESTD_mean_T ~ "Acima da média do estado",
                                         RENDA_TRABALHO_T < REN_ESTD_mean_T ~ "Abaixo da média do estado"),
         classREN_ESTD_mean_AFAF = case_when(RENDA_TRABALHO_AF >= REN_ESTD_mean_AF ~ "Acima da média do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_mean_AF ~ "Abaixo da média do estado"),
         classREN_ESTD_mean_AFT = case_when(RENDA_TRABALHO_AF >= REN_ESTD_mean_T ~ "Acima da média do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_mean_T ~ "Abaixo da média do estado"),
         
         classREN_ESTD_median_T = case_when(RENDA_TRABALHO_T >= REN_ESTD_median_T ~ "Acima da mediana do estado",
                                         RENDA_TRABALHO_T < REN_ESTD_median_T ~ "Abaixo da mediana do estado"),
         classREN_ESTD_median_AFAF = case_when(RENDA_TRABALHO_AF >= REN_ESTD_median_AF ~ "Acima da mediana do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_median_AF ~ "Abaixo da mediana do estado"),
         classREN_ESTD_median_AFT = case_when(RENDA_TRABALHO_AF >= REN_ESTD_median_T ~ "Acima da mediana do estado",
                                         RENDA_TRABALHO_AF < REN_ESTD_median_T ~ "Abaixo da mediana do estado")
         )

```

```{r shapefiles, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}
SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
SHP_Municipios <- read_sf("data/shapes/BR_Municipios_2020_simplif.shp")
SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
st_crs(SHP_Microrregioes)
tmap_mode("view")
# tmap_mode("plot") #> tmap mode set to plotting
# Mudando o nome pra ficar igual ao da tabela
names(SHP_Microrregioes)[1] <- "COD"
names(SHP_Municipios)[1] <- "COD"

SHP_Microrregioes_class <- left_join(SHP_Microrregioes, microrregioes_class, by = "COD")
SHP_Municipios_class <- left_join(SHP_Municipios, municipios_class, by = "COD")

```

# Por Municípios

## A partir da média brasileira

A média brasileira por municípios, considerando os rendimentos de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMUN[1,]$REN_BRA_mean_T, 1),"(mil reais)")`.


**Resumo por região**

```{r tabelaresumo_mediabrasileira, echo=FALSE, message=FALSE, warning=FALSE}

municipios_class_sumario <- municipios_class %>%
  select(COD_REGIAO, classREN_BRA_mean_AFT) %>%
  group_by(COD_REGIAO, classREN_BRA_mean_AFT) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classREN_BRA_mean_AFT, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Acima da média do país`,
         `pct_Acima da média do país`,
         `n_Abaixo da média do país`,
         `pct_Abaixo da média do país`) 
# %>%
# 
#   rename("Região" = COD_REGIAO,
#          "Microrregiões acima da média" = "n_Acima da média do país"
#          "% municípios " = "pct_Acima da média do país"
#          "Abaixo da média" = "n_Abaixo da média do país"
#          "% municípios" = "pct_Abaixo da média do país") 


options(knitr.kable.NA = 'Não há')


kbl(municipios_class_sumario,
    col.names = c("Região",
                  "Nº de municipios",
                  "% na região",
                  "Nº de municipios",
                  "% na região"),
    align = "crlrl",
    caption = "Resumo por região") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "Rendimentos da AF acima da média" = 2, "Rendimentos da AF abaixo da média" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos da AF em relação a média (todos) do país" = 4)) 
  #row_spec(6, bold = T, color = "black")


```

**Representação espacial**

```{r mapa_mediabrasileira, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#fc8d62", "#66c2a5")

  SHP_Municipios_class %>%
  filter(!is.na(classREN_BRA_mean_AFT)) %>%
  tm_shape() +
  tm_fill(col = "classREN_BRA_mean_AFT", 
          palette = cores,
          title = "Rendas do trabalho na AF<br>Cálculo pela média",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```

<br>

<br>

## A partir da mediana brasileira

A mediana brasileira por municípios, considerando os rendimentos de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMUN[1,]$REN_BRA_median_T, 1),"(mil reais)")`.

**Resumo por região**

```{r tabelaresumo_medianabrasileira, echo=FALSE, message=FALSE, warning=FALSE}

municipios_class_sumario <- municipios_class %>%
  select(COD_REGIAO, classREN_BRA_median_AFT) %>%
  group_by(COD_REGIAO, classREN_BRA_median_AFT) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classREN_BRA_median_AFT, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Acima da mediana do país`,
         `pct_Acima da mediana do país`,
         `n_Abaixo da mediana do país`,
         `pct_Abaixo da mediana do país`) 
# %>%
# 
#   rename("Região" = COD_REGIAO,
#          "Microrregiões acima da mediana" = "n_Acima da mediana do país"
#          "% municípios " = "pct_Acima da mediana do país"
#          "Abaixo da mediana" = "n_Abaixo da mediana do país"
#          "% municípios" = "pct_Abaixo da mediana do país") 


options(knitr.kable.NA = 'Não há')


kbl(municipios_class_sumario,
    col.names = c("Região",
                  "Nº de municipios",
                  "% na região",
                  "Nº de municipios",
                  "% na região"),
    align = "crlrl",
    caption = "Resumo por região") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "Rendimentos da AF acima da mediana" = 2, "Rendimentos da AF abaixo da mediana" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos da AF em relação a mediana (todos) do país" = 4)) 
  #row_spec(6, bold = T, color = "black")


```

**Representação espacial**

```{r mapa_medinabrasileira, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#fc8d62", "#66c2a5")

  SHP_Municipios_class %>%
  filter(!is.na(classREN_BRA_median_AFT)) %>%
  tm_shape() +
  tm_fill(col = "classREN_BRA_median_AFT", 
          palette = cores,
          title = "Rendas do trabalho na AF<br>Cálculo pela mediana",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```



# Por Microrregiões

A média brasileira por microrregiões, considerando os rendimentos de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMIC[1,]$REN_BRA_mean_T, 1),"(mil reais)")`.

## A partir da média brasileira

**Resumo por região**

```{r tabelaresumo_mediabrasileira_micro, echo=FALSE, message=FALSE, warning=FALSE}
microrregioes_class_sumario <- microrregioes_class %>%
  select(COD_REGIAO, classREN_BRA_mean_AFT) %>%
  group_by(COD_REGIAO, classREN_BRA_mean_AFT) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classREN_BRA_mean_AFT, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Acima da média do país`,
         `pct_Acima da média do país`,
         `n_Abaixo da média do país`,
         `pct_Abaixo da média do país`) 
# %>%
# 
#   rename("Região" = COD_REGIAO,
#          "Microrregiões acima da média" = "n_Acima da média do país"
#          "% microrregiões " = "pct_Acima da média do país"
#          "Abaixo da média" = "n_Abaixo da média do país"
#          "% microrregiões" = "pct_Abaixo da média do país") 


options(knitr.kable.NA = 'Não há')


kbl(microrregioes_class_sumario,
    col.names = c("Região",
                  "Nº de microrregioes",
                  "% na região",
                  "Nº de microrregioes",
                  "% na região"),
    align = "crlrl",
    caption = "Resumo por região") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "Rendimentos da AF acima da média" = 2, "Rendimentos da AF abaixo da média" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos da AF em relação a média geral do país" = 4)) 
  #row_spec(6, bold = T, color = "black")

```

**Representação espacial**

```{r mapa_mediabrasileira_micro, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#fc8d62", "#66c2a5")

  SHP_Microrregioes_class %>%
  filter(!is.na(classREN_BRA_mean_AFT)) %>%
  tm_shape() +
  tm_fill(col = "classREN_BRA_mean_AFT", 
          palette = cores,
          title = "Rendas do trabalho na AF<br>Cálculo pela média",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```

<br>

<br>


## A partir da mediana brasileira

A mediana brasileira por municípios, considerando os rendimentos de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMIC[1,]$REN_BRA_median_T, 1),"(mil reais)")`.

**Resumo por região**

```{r tabelaresumo_medianabrasileira_micro, echo=FALSE, message=FALSE, warning=FALSE}

microrregioes_class_sumario <- microrregioes_class %>%
  select(COD_REGIAO, classREN_BRA_median_AFT) %>%
  group_by(COD_REGIAO, classREN_BRA_median_AFT) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classREN_BRA_median_AFT, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Acima da mediana do país`,
         `pct_Acima da mediana do país`,
         `n_Abaixo da mediana do país`,
         `pct_Abaixo da mediana do país`) 
# %>%
# 
#   rename("Região" = COD_REGIAO,
#          "Microrregiões acima da mediana" = "n_Acima da mediana do país"
#          "% microrregiões " = "pct_Acima da mediana do país"
#          "Abaixo da mediana" = "n_Abaixo da mediana do país"
#          "% microrregiões" = "pct_Abaixo da mediana do país") 


options(knitr.kable.NA = 'Não há')


kbl(microrregioes_class_sumario,
    col.names = c("Região",
                  "Nº de microrregioes",
                  "% na região",
                  "Nº de microrregioes",
                  "% na região"),
    align = "crlrl",
    caption = "Resumo por região") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "Rendimentos da AF acima da mediana" = 2, "Rendimentos da AF abaixo da mediana" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos da AF em relação a mediana (todos) do país" = 4)) 
  #row_spec(6, bold = T, color = "black")


```

**Representação espacial**

```{r mapa_medianabrasileira_micro, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#fc8d62", "#66c2a5")

  SHP_Microrregioes_class %>%
  filter(!is.na(classREN_BRA_median_AFT)) %>%
  tm_shape() +
  tm_fill(col = "classREN_BRA_median_AFT", 
          palette = cores,
          title = "Rendas do trabalho na AF<br>Cálculo pela mediana",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```



